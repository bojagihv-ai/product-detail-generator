<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏûêÎèô ÏÉùÏÑ±Í∏∞</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#6366f1;--primary-h:#818cf8;--primary-dim:rgba(99,102,241,.15);
  --bg:#0f0f13;--bg-card:#1a1a23;--bg-input:#13131a;
  --border:#2a2a36;--border-h:#3a3a4a;
  --text:#e4e4e7;--text-d:#9494a5;--text-m:#6b6b7b;
  --ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
  --cyan:#06b6d4;--orange:#f97316;
}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.fade-in{animation:fadeIn .3s ease-out}

/* Layout */
.app{display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;flex-shrink:0}
.logo{display:flex;align-items:center;gap:10px;padding:20px 16px;border-bottom:1px solid var(--border)}
.logo-icon{font-size:28px;color:var(--primary);font-weight:900}
.logo-text{font-weight:700;font-size:15px;line-height:1.3}
.logo-sub{font-weight:400;font-size:12px;color:var(--text-d)}
.nav{padding:12px 8px;display:flex;flex-direction:column;gap:2px;flex:1}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:.15s;color:var(--text-d);font-size:13px;border:none;background:none;width:100%;text-align:left;font-family:inherit}
.nav-item:hover{background:rgba(255,255,255,.03)}
.nav-item.active{background:var(--primary-dim);color:var(--primary-h)}
.nav-item.disabled{opacity:.4;cursor:not-allowed}
.main{flex:1;min-width:0;padding:24px 32px;overflow-y:auto}
.container{max-width:1100px;margin:0 auto}

/* Typography */
.page-title{font-size:26px;font-weight:800;margin-bottom:6px}
.page-desc{font-size:14px;color:var(--text-d);margin-bottom:24px}

/* Upload */
.upload-area{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;cursor:pointer;background:var(--bg-card);margin-bottom:24px;min-height:240px;display:flex;align-items:center;justify-content:center;transition:.2s}
.upload-area:hover{border-color:var(--primary);background:rgba(99,102,241,.03)}
.upload-area.has-image{border-style:solid;border-color:var(--border)}
.preview-img{max-height:300px;max-width:100%;border-radius:12px;object-fit:contain}

/* Form */
.input-group{margin-bottom:20px}
.label{display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:var(--text-d)}
.input,.textarea{width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;outline:none;font-family:inherit;transition:border .2s}
.input:focus,.textarea:focus{border-color:var(--primary)}
.textarea{resize:vertical;line-height:1.5;font-size:13px}

/* Buttons */
.btn-primary{display:inline-flex;align-items:center;gap:8px;padding:12px 28px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;transition:.15s}
.btn-primary:hover{background:var(--primary-h)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-sm{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;background:var(--bg-card);color:var(--text-d);border:1px solid var(--border);border-radius:6px;font-size:12px;cursor:pointer;font-family:inherit}
.btn-sm:hover{border-color:var(--border-h);color:var(--text)}

/* Cards */
.feature-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:40px}
.feature-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center}
.feature-card .mi{font-size:28px;color:var(--primary);margin-bottom:8px}
.feature-card h4{font-weight:600;font-size:14px;margin-bottom:4px}
.feature-card p{font-size:12px;color:var(--text-d)}

/* Analysis Summary */
.analysis-box{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:24px}
.tag{display:inline-block;padding:3px 10px;background:var(--primary-dim);color:var(--primary-h);border-radius:20px;font-size:11px;font-weight:500;margin:2px}

/* Section Cards */
.section-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:10px}
.section-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;cursor:pointer;transition:.15s}
.section-card:hover{border-color:var(--border-h);background:var(--bg-card)}
.section-card .head{display:flex;align-items:center;gap:12px}
.section-card .icon{font-size:28px}
.section-card .info{flex:1}
.section-card .info h4{font-weight:600;font-size:14px}
.section-card .info p{font-size:12px;color:var(--text-d);margin-top:2px}
.custom-badge{margin-top:8px;padding:6px 10px;background:var(--primary-dim);border-radius:6px;font-size:12px;color:var(--primary-h)}

/* Progress */
.progress-outer{width:100%;max-width:400px;height:24px;background:var(--bg-card);border-radius:12px;overflow:hidden;border:1px solid var(--border)}
.progress-inner{height:100%;background:linear-gradient(90deg,var(--primary),var(--cyan));border-radius:12px;transition:width .5s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:600;min-width:40px}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
.spinner-lg{width:64px;height:64px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
.gen-icons{margin-top:40px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.gen-icon{width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:var(--bg-card);border-radius:10px;font-size:22px;border:1px solid var(--border);transition:.3s}
.gen-icon.done{background:var(--primary-dim);border-color:var(--primary)}

/* Preview */
.preview-wrap{background:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
.section-ctrl{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--bg-card);border-bottom:1px solid var(--border)}
.section-ctrl .name{font-weight:600;font-size:13px}
.edit-panel{padding:12px 16px;background:var(--bg);border-bottom:1px solid var(--border)}

/* Error */
.error-bar{display:flex;align-items:center;gap:8px;padding:10px 16px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;color:var(--err);font-size:13px;margin-bottom:16px}

/* API Key Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:32px;max-width:480px;width:90%}
.modal h2{font-size:20px;margin-bottom:8px}
.modal p{font-size:13px;color:var(--text-d);margin-bottom:20px}

/* Image Cuts */
.cuts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.cut-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:10px;transition:.2s}
.cut-card.has-result{border-color:var(--primary)}
.cut-label{font-size:13px;font-weight:700;color:var(--primary)}
.cut-preview{width:100%;aspect-ratio:4/3;border-radius:8px;object-fit:cover;background:var(--bg-input);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--text-m);font-size:12px;overflow:hidden}
.cut-preview img{width:100%;height:100%;object-fit:cover}
.cut-spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;margin:auto}
.source-upload{border:2px dashed var(--border);border-radius:12px;padding:24px;text-align:center;cursor:pointer;background:var(--bg-card);transition:.2s;margin-bottom:20px}
.source-upload:hover{border-color:var(--primary)}
.placement-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.placement-row:last-child{border-bottom:none}
.placement-select{background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:4px 8px;font-size:12px;font-family:inherit;outline:none}
.cut-thumb{width:40px;height:40px;border-radius:6px;object-fit:cover;border:1px solid var(--border);background:var(--bg-input)}

/* Automation */
.auto-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.auto-card h3{font-size:15px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.auto-status{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
.auto-status.running{background:rgba(34,197,94,.15);color:var(--ok)}
.auto-status.stopped{background:rgba(239,68,68,.15);color:var(--err)}
.auto-status.waiting{background:rgba(245,158,11,.15);color:var(--warn)}
.folder-pick{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:.15s;min-height:44px}
.folder-pick:hover{border-color:var(--primary)}
.folder-pick .name{flex:1;font-size:13px;color:var(--text)}
.folder-pick .placeholder{flex:1;font-size:13px;color:var(--text-m)}
.queue-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);font-size:13px}
.queue-item:last-child{border-bottom:none}
.queue-item .q-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.queue-item .q-status.pending{background:var(--text-m)}
.queue-item .q-status.processing{background:var(--warn);animation:pulse 1s infinite}
.queue-item .q-status.done{background:var(--ok)}
.queue-item .q-status.error{background:var(--err)}
.log-box{background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:12px;max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px;line-height:1.8}
.log-line{color:var(--text-d)}
.log-line.ok{color:var(--ok)}
.log-line.err{color:var(--err)}
.log-line.info{color:var(--cyan)}
.interval-slider{width:100%;accent-color:var(--primary)}

/* Token Tracker */
.token-bar{position:fixed;bottom:0;left:0;right:0;background:var(--bg-card);border-top:1px solid var(--border);padding:6px 16px;display:flex;align-items:center;gap:16px;font-size:11px;z-index:500;flex-wrap:wrap}
.token-bar .tb-label{color:var(--text-m);white-space:nowrap}
.token-bar .tb-val{font-weight:700;font-family:monospace}
.token-bar .tb-val.flash{animation:pulse .4s ease}
.token-bar .sep{color:var(--border);user-select:none}
.token-bar .tb-model{padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600}
.token-bar .m-flash{background:rgba(99,102,241,.2);color:var(--primary-h)}
.token-bar .m-img{background:rgba(249,115,22,.2);color:var(--orange)}
.token-bar .tb-cost{color:var(--ok);font-weight:700;font-family:monospace}
.token-bar .tb-reset{cursor:pointer;color:var(--text-m);padding:2px 6px;border-radius:4px;border:1px solid var(--border);background:none;font-size:10px;font-family:inherit}
.token-bar .tb-reset:hover{color:var(--text);border-color:var(--border-h)}
.token-detail-btn{cursor:pointer;color:var(--primary-h);font-size:10px;text-decoration:underline;background:none;border:none;font-family:inherit;padding:0}
.token-modal{position:fixed;bottom:44px;right:16px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;min-width:360px;max-width:480px;z-index:600;box-shadow:0 8px 32px rgba(0,0,0,.4)}
.token-modal h3{font-size:14px;font-weight:700;margin-bottom:12px}
.token-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
.token-row:last-child{border-bottom:none}
.token-row .model-name{font-family:monospace;font-size:11px;color:var(--text-d)}
/* Model Settings */
.provider-tabs{display:flex;gap:8px;margin-bottom:20px}
.provider-tab{flex:1;padding:14px;border-radius:10px;border:2px solid var(--border);background:var(--bg-card);cursor:pointer;text-align:center;transition:.15s}
.provider-tab:hover{border-color:var(--border-h)}
.provider-tab.active-gemini{border-color:#6366f1;background:rgba(99,102,241,.1)}
.provider-tab.active-openai{border-color:#10a37f;background:rgba(16,163,127,.1)}
.provider-tab .pt-icon{font-size:22px;font-weight:900;margin-bottom:4px}
.provider-tab .pt-label{font-size:13px;font-weight:700}
.provider-tab .pt-sub{font-size:11px;color:var(--text-m);margin-top:2px}
.model-list{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px}
.model-card{padding:12px 14px;border-radius:8px;border:2px solid var(--border);background:var(--bg-card);cursor:pointer;transition:.15s}
.model-card:hover{border-color:var(--border-h)}
.model-card.selected{border-color:var(--primary);background:var(--primary-dim)}
.model-card.selected-green{border-color:#10a37f;background:rgba(16,163,127,.1)}
.model-card .mc-label{font-size:13px;font-weight:700;margin-bottom:2px}
.model-card .mc-id{font-size:10px;font-family:monospace;color:var(--text-m)}
.model-card .mc-desc{font-size:11px;color:var(--text-d);margin-top:4px}
.model-card .mc-price{font-size:10px;color:var(--warn);margin-top:4px}
.settings-section{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.settings-section h3{font-size:14px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.cur-model-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;margin-left:8px}
.cur-model-badge.gemini{background:rgba(99,102,241,.2);color:var(--primary-h)}
.cur-model-badge.openai{background:rgba(16,163,127,.2);color:#10a37f}

/* Responsive */
@media(max-width:900px){
  .feature-grid{grid-template-columns:repeat(2,1fr)}
  .section-grid{grid-template-columns:1fr}
  .sidebar{width:60px;overflow:hidden}
  .sidebar .logo-text,.sidebar .logo-sub,.sidebar .nav-item span:last-child{display:none}
}
</style>
</head>
<body>
<div id="app"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SECTION DEFINITIONS (15 sections)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SECTIONS = [
  {n:1,name:"Ìó§Îçî (Header)",id:"header",purpose:"Ï†úÌíàÏùÑ ÍπîÎÅîÌïú ÌôîÏù¥Ìä∏ÌÜ§ Î∞∞Í≤ΩÏúºÎ°ú Í∞ïÏ°∞. Ï†úÌíàÎ™ÖÏùÑ ÏÉÅÎã®Ïóê ÌÅ¨Í≥† ÏûÑÌå©Ìä∏ ÏûàÍ≤å ÌëúÏãú.",desc:"ÌôîÏù¥Ìä∏ Î∞∞Í≤Ω + Ï†úÌíà Ï§ëÏïô Î∞∞Ïπò + Ï†úÌíàÎ™Ö Í∞ïÏ°∞",icon:"üéØ"},
  {n:2,name:"ÌõÖ (Hook)",id:"hook",purpose:"Íµ¨Îß§ ÏöïÍµ¨Î•º ÏûêÍ∑πÌïòÎäî Í∞ïÎ†¨Ìïú ÎπÑÏ£ºÏñºÍ≥º Ïπ¥Ìîº. Í≥†Í∞ùÏùò ÌéòÏù∏Ìè¨Ïù∏Ìä∏Î•º Í±¥ÎìúÎ¶¨Í≥† Ï†úÌíàÏù¥ Ìï¥Í≤∞Ï±ÖÏûÑÏùÑ ÏïîÏãú.",desc:"Íµ¨Îß§ ÏöïÍµ¨ ÏûêÍ∑π ÌõÖ Î©îÏãúÏßÄ + Í∞êÏÑ± Ïù¥ÎØ∏ÏßÄ",icon:"ü™ù"},
  {n:3,name:"ÌïµÏã¨ ÌäπÏßï (Key Features)",id:"key_features",purpose:"Ï†úÌíàÏùò ÌïµÏã¨ ÌäπÏû•Ï†ê 3~5Í∞ÄÏßÄÎ•º ÏïÑÏù¥ÏΩò/Ïù¥ÎØ∏ÏßÄÏôÄ Ìï®Íªò Î™ÖÌôïÌïòÍ≤å Ï†ÑÎã¨.",desc:"ÌïµÏã¨ ÌäπÏû•Ï†ê 3~5Í∞ÄÏßÄ ÏïÑÏù¥ÏΩò+ÌÖçÏä§Ìä∏ Í∑∏Î¶¨Îìú",icon:"‚≠ê"},
  {n:4,name:"ÏÉÅÏÑ∏ Ïä§Ìéô (Specifications)",id:"specifications",purpose:"Ï†úÌíàÏùò ÏÉÅÏÑ∏ ÏÇ¨Ïñë, ÌÅ¨Í∏∞, Ïû¨Ïßà, Î¨¥Í≤å Îì± Íµ¨Ï≤¥Ï†ÅÏù∏ Ï†ïÎ≥¥ Ï†úÍ≥µ.",desc:"ÏÉÅÏÑ∏ ÏÇ¨Ïñë ÌÖåÏù¥Î∏î + Ï†úÌíà ÎîîÌÖåÏùº Ïù¥ÎØ∏ÏßÄ",icon:"üìê"},
  {n:5,name:"ÏÇ¨Ïö© ÏãúÎÇòÎ¶¨Ïò§ (Use Scenarios)",id:"use_scenarios",purpose:"Îã§ÏñëÌïú ÏÇ¨Ïö© ÏÉÅÌô©ÏùÑ Î≥¥Ïó¨Ï£ºÏñ¥ Í≥†Í∞ùÏù¥ ÏûêÏã†Ïùò ÎùºÏù¥ÌîÑÏä§ÌÉÄÏùºÏóêÏÑú Ï†úÌíàÏùÑ ÏÉÅÏÉÅÌï† Ïàò ÏûàÍ≤å Ìï®.",desc:"ÎùºÏù¥ÌîÑÏä§ÌÉÄÏùº Ïù¥ÎØ∏ÏßÄ + ÏÇ¨Ïö© ÏÉÅÌô© ÌÖçÏä§Ìä∏",icon:"üè†"},
  {n:6,name:"ÎπÑÍµê Ïö∞ÏúÑ (Competitive Edge)",id:"competitive_edge",purpose:"Í≤ΩÏüÅ Ï†úÌíà ÎåÄÎπÑ Ïö∞ÏúÑÏ†êÏùÑ ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú ÎπÑÍµê.",desc:"Í≤ΩÏüÅÏÇ¨ ÎåÄÎπÑ ÎπÑÍµêÌëú ÎòêÎäî Before/After",icon:"üèÜ"},
  {n:7,name:"ÏÜåÏû¨/Í∏∞Ïà† (Material & Tech)",id:"material_tech",purpose:"ÏÇ¨Ïö©Îêú ÏÜåÏû¨Ïùò Ïö∞ÏàòÏÑ±Ïù¥ÎÇò ÌäπÌóà Í∏∞Ïà† Îì±ÏùÑ ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú ÏÑ§Î™Ö.",desc:"ÏÜåÏû¨/Í∏∞Ïà†Î†• Í∞ïÏ°∞ Îã§ÌÅ¨ÌÜ§ ÏÑπÏÖò",icon:"üî¨"},
  {n:8,name:"Ïù∏Ï¶ù/ÏàòÏÉÅ (Certifications)",id:"certifications",purpose:"Ï†úÌíàÏù¥ Î∞õÏùÄ Ïù∏Ï¶ù, ÏàòÏÉÅ ÎÇ¥Ïó≠, ÌÖåÏä§Ìä∏ Í≤∞Í≥º Îì±ÏúºÎ°ú Ïã†Î¢∞ÎèÑ Íµ¨Ï∂ï.",desc:"Ïù∏Ï¶ùÎßàÌÅ¨/ÏàòÏÉÅÎÇ¥Ïó≠ Î∞∞ÏßÄ ÎÇòÏó¥",icon:"üèÖ"},
  {n:9,name:"Î¶¨Î∑∞/ÌõÑÍ∏∞ (Reviews)",id:"reviews",purpose:"Ïã§Ï†ú ÏÇ¨Ïö©Ïûê ÌõÑÍ∏∞Î•º ÌôúÏö©Ìïú ÏÇ¨ÌöåÏ†Å Ï¶ùÍ±∞.",desc:"Í≥†Í∞ù Î¶¨Î∑∞ Ïπ¥Îìú Î†àÏù¥ÏïÑÏõÉ",icon:"üí¨"},
  {n:10,name:"ÌÅ¨Í∏∞/Ïª¨Îü¨ Í∞ÄÏù¥Îìú",id:"size_color",purpose:"ÏÇ¨Ïù¥Ï¶à Ï∞®Ìä∏, Ïª¨Îü¨ ÏòµÏÖò Îì± ÏÑ†ÌÉùÏóê ÎèÑÏõÄÎêòÎäî Ï†ïÎ≥¥ Ï†úÍ≥µ.",desc:"ÏÇ¨Ïù¥Ï¶àÌëú + Ïª¨Îü¨ Ïä§ÏôÄÏπò ÏòµÏÖò",icon:"üé®"},
  {n:11,name:"ÌîÑÎ°úÎ™®ÏÖò (Promotion)",id:"promotion",purpose:"ÌäπÎ≥Ñ Ìï†Ïù∏, ÏÑ∏Ìä∏ Íµ¨ÏÑ±, ÏÇ¨ÏùÄÌíà Îì± Íµ¨Îß§ Ï¥âÏßÑ Ïù¥Î≤§Ìä∏ ÏÑπÏÖò.",desc:"Ìï†Ïù∏/Ïù¥Î≤§Ìä∏/ÏÑ∏Ìä∏ Íµ¨ÏÑ± ÌîÑÎ°úÎ™®ÏÖò Î∞∞ÎÑà",icon:"üéÅ"},
  {n:12,name:"Î∞∞ÏÜ°/Ìè¨Ïû• (Shipping)",id:"shipping",purpose:"Î∞∞ÏÜ° Ï†ïÎ≥¥, Ìè¨Ïû• ÏÉÅÌÉú, Ïñ∏Î∞ïÏã± Í≤ΩÌóò Îì±ÏùÑ Î≥¥Ïó¨Ï§å.",desc:"Î∞∞ÏÜ°Ï†ïÎ≥¥ + Ìå®ÌÇ§Ïßï Ïù¥ÎØ∏ÏßÄ",icon:"üì¶"},
  {n:13,name:"FAQ (ÏûêÏ£º Î¨ªÎäî ÏßàÎ¨∏)",id:"faq",purpose:"Í≥†Í∞ùÎì§Ïù¥ ÏûêÏ£º Î¨ªÎäî ÏßàÎ¨∏ÏùÑ ÎØ∏Î¶¨ ÎãµÎ≥ÄÌïòÏó¨ Íµ¨Îß§ Î∂àÏïà Ìï¥ÏÜå.",desc:"ÏïÑÏΩîÎîîÏñ∏ ÌòïÏãù FAQ ÏÑπÏÖò",icon:"‚ùì"},
  {n:14,name:"Î∏åÎûúÎìú Ïä§ÌÜ†Î¶¨",id:"brand_story",purpose:"Î∏åÎûúÎìúÏùò Ï≤†Ìïô, Ïä§ÌÜ†Î¶¨, Í∞ÄÏπòÎ•º Ï†ÑÎã¨ÌïòÏó¨ Í∞êÏÑ±Ï†Å Ïó∞Í≤∞ ÌòïÏÑ±.",desc:"Î∏åÎûúÎìú Ïä§ÌÜ†Î¶¨ÌÖîÎßÅ Îã§ÌÅ¨ ÏÑπÏÖò",icon:"üìñ"},
  {n:15,name:"CTA Ìë∏ÌÑ∞ (Footer)",id:"cta_footer",purpose:"ÏµúÏ¢Ö Íµ¨Îß§ Í≤∞Ï†ïÏùÑ Ïú†ÎèÑÌïòÎäî Í∞ïÎ†•Ìïú CTA.",desc:"ÏµúÏ¢Ö CTA + Í∞ÄÍ≤© + Íµ¨Îß§Î≤ÑÌäº",icon:"üõí"},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODEL CONFIG SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîë Îç∞Î™® Î™®Îìú ÏÑ§Ï†ï ‚Äî Ìï¥Ïª§ÌÜ§/ÏãúÏó∞Ïö© API ÌÇ§ ÏÇ¨Ï†Ñ ÎÇ¥Ïû•
// geminiKey, openaiKeyÎ•º Ï±ÑÏõåÎÑ£ÏúºÎ©¥ Î∞©Î¨∏ÏûêÍ∞Ä ÌÇ§ ÏûÖÎ†• ÏóÜÏù¥ Î∞îÎ°ú ÏÇ¨Ïö© Í∞ÄÎä•
// enabled: false Î°ú ÏÑ§Ï†ïÌïòÎ©¥ ÏùºÎ∞ò Î™®Îìú(API ÌÇ§ ÏûÖÎ†• Î™®Îã¨)Î°ú Î≥µÍ∑Ä
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEMO_CONFIG = {
  enabled: true,
  geminiKey: 'AIzaSyC6wKUVFRPY9eQ5Gh3HNHCCHz9NZVQY1KE',
  openaiKey: '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',
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LLM ÌîÑÎ°úÎ∞îÏù¥Îçî Î∞è Î™®Îç∏ Î™©Î°ù Ï†ïÏùò
const LLM_PROVIDERS = {
  gemini: {
    label: 'Google Gemini',
    icon: '‚ú¶',
    color: '#6366f1',
    models: [
      { id: 'gemini-2.0-flash',       label: 'Gemini 2.0 Flash',       desc: 'Îπ†Î¶Ñ ¬∑ Ï†ÄÎπÑÏö©',         inputPerM: 0.10,  outputPerM: 0.40  },
      { id: 'gemini-2.0-flash-lite',  label: 'Gemini 2.0 Flash Lite',  desc: 'ÏµúÏ†ÄÎπÑÏö©',              inputPerM: 0.075, outputPerM: 0.30  },
      { id: 'gemini-1.5-pro',         label: 'Gemini 1.5 Pro',         desc: 'Í≥†ÏÑ±Îä• ¬∑ Í∏¥ Ïª®ÌÖçÏä§Ìä∏',  inputPerM: 1.25,  outputPerM: 5.00  },
      { id: 'gemini-2.5-pro-preview', label: 'Gemini 2.5 Pro Preview', desc: 'ÏµúÍ≥†ÏÑ±Îä• (ÌîÑÎ¶¨Î∑∞)',      inputPerM: 1.25,  outputPerM: 10.00 },
    ],
  },
  openai: {
    label: 'OpenAI ChatGPT',
    icon: '‚óÜ',
    color: '#10a37f',
    models: [
      { id: 'gpt-4.1-nano', label: 'GPT-4.1 nano', desc: 'Ï¥àÏ†ÄÎπÑÏö© ¬∑ 1M Ïª®ÌÖçÏä§Ìä∏',    inputPerM: 0.10,  outputPerM: 0.40  },
      { id: 'gpt-4.1-mini', label: 'GPT-4.1 mini', desc: 'Ï†ÄÎπÑÏö© ¬∑ 1M Ïª®ÌÖçÏä§Ìä∏',      inputPerM: 0.40,  outputPerM: 1.60  },
      { id: 'o3',           label: 'o3',            desc: 'Ï∂îÎ°† ¬∑ Ï†ÄÎπÑÏö©',             inputPerM: 0.40,  outputPerM: 1.60  },
      { id: 'gpt-4o-mini',  label: 'GPT-4o mini',  desc: 'Îπ†Î¶Ñ ¬∑ Î©ÄÌã∞Î™®Îã¨',           inputPerM: 0.15,  outputPerM: 0.60  },
      { id: 'gpt-4.1',      label: 'GPT-4.1',      desc: 'Í≥†ÏÑ±Îä• ¬∑ 1M Ïª®ÌÖçÏä§Ìä∏',      inputPerM: 2.00,  outputPerM: 8.00  },
      { id: 'gpt-4o',       label: 'GPT-4o',        desc: 'Í≥†ÏÑ±Îä• ¬∑ Î©ÄÌã∞Î™®Îã¨',         inputPerM: 2.50,  outputPerM: 10.00 },
      { id: 'o4-mini',      label: 'o4-mini',       desc: 'Í≥†Í∏â Ï∂îÎ°† ¬∑ 200K Ïª®ÌÖçÏä§Ìä∏', inputPerM: 1.10,  outputPerM: 4.40  },
      { id: 'gpt-5',        label: 'GPT-5',         desc: 'ÏµúÍ∞ï ÌîåÎûòÍ∑∏Ïã≠',             inputPerM: 1.25,  outputPerM: 10.00 },
    ],
  },
};

// Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î™®Îç∏ Î™©Î°ù (Gemini Ï†ÑÏö©)
const IMAGE_MODELS = [
  { id: 'gemini-3-pro-image-preview',       label: 'Gemini 3 Pro Image Preview', desc: 'ÏµúÍ≥†ÌíàÏßà (Í∂åÏû•)',  inputPerM: 3.50,  outputPerM: 10.50, imageOut: 0.039 },
  { id: 'gemini-2.0-flash-exp-image-generation', label: 'Gemini 2.0 Flash Image', desc: 'Îπ†Î¶Ñ ¬∑ Ïã§ÌóòÏ†Å', inputPerM: 0.10,  outputPerM: 0.40,  imageOut: 0.02  },
];

// ÏÑ§Ï†ï Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞
function saveModelConfig(cfg) {
  try { localStorage.setItem('model_config', JSON.stringify(cfg)); } catch(e) {}
}
function loadModelConfig() {
  try {
    const raw = localStorage.getItem('model_config');
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return {
    llmProvider: 'openai',
    llmModel: 'gpt-4.1',
    imageModel: 'gemini-3-pro-image-preview',
    openaiKey: '',
    imageSizeMode: 'auto',   // 'auto' | 'custom'
    imageWidth: 860,          // px (custom Î™®Îìú Ïãú ÏÇ¨Ïö©)
    imageHeight: null,        // px or null (null = ÎπÑÏú® ÏûêÎèô Ïú†ÏßÄ)
  };
}
function saveOpenAIKey(key) {
  try { localStorage.setItem('openai_api_key', key); } catch(e) {}
}
function loadOpenAIKey() {
  try { return localStorage.getItem('openai_api_key') || ''; } catch(e) { return ''; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOKEN / COST TRACKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Í∞ÄÍ≤©ÌëúÎ•º ÎèôÏ†ÅÏúºÎ°ú Íµ¨ÏÑ± (LLM_PROVIDERS + IMAGE_MODELS Í∏∞Î∞ò)
function buildModelPricing() {
  const pricing = {};
  for (const prov of Object.values(LLM_PROVIDERS)) {
    for (const m of prov.models) {
      pricing[m.id] = { inputPerM: m.inputPerM, outputPerM: m.outputPerM, label: m.label, type: 'text' };
    }
  }
  for (const m of IMAGE_MODELS) {
    pricing[m.id] = { inputPerM: m.inputPerM, outputPerM: m.outputPerM, imageOut: m.imageOut, label: m.label, type: 'image' };
  }
  return pricing;
}
const MODEL_PRICING = buildModelPricing();

const tokenTracker = {
  sessions: {},   // modelId ‚Üí { inputTokens, outputTokens, calls, imageCount, costUSD }
  showDetail: false,

  // ÏÇ¨Ïö©Îüâ Í∏∞Î°ù
  record(modelId, inputTokens, outputTokens, isImage = false) {
    if (!this.sessions[modelId]) {
      this.sessions[modelId] = { inputTokens: 0, outputTokens: 0, calls: 0, imageCount: 0, costUSD: 0 };
    }
    const s = this.sessions[modelId];
    s.inputTokens  += inputTokens  || 0;
    s.outputTokens += outputTokens || 0;
    s.calls++;
    if (isImage) s.imageCount++;

    // ÎπÑÏö© Í≥ÑÏÇ∞
    const p = MODEL_PRICING[modelId];
    if (p) {
      const inCost  = (s.inputTokens  / 1_000_000) * p.inputPerM;
      const outCost = (s.outputTokens / 1_000_000) * p.outputPerM;
      const imgCost = p.imageOut ? s.imageCount * p.imageOut : 0;
      s.costUSD = inCost + outCost + imgCost;
    }
    this.save();
    this.renderBar();
  },

  // Ï†ÑÏ≤¥ Ìï©Í≥Ñ
  totals() {
    let totalIn = 0, totalOut = 0, totalCost = 0, totalCalls = 0;
    for (const s of Object.values(this.sessions)) {
      totalIn    += s.inputTokens;
      totalOut   += s.outputTokens;
      totalCost  += s.costUSD;
      totalCalls += s.calls;
    }
    return { totalIn, totalOut, totalCost, totalCalls };
  },

  // localStorage Ï†ÄÏû•
  save() {
    try { localStorage.setItem('token_tracker', JSON.stringify(this.sessions)); } catch(e) {}
  },

  // localStorage Î∂àÎü¨Ïò§Í∏∞
  load() {
    try {
      const raw = localStorage.getItem('token_tracker');
      if (raw) this.sessions = JSON.parse(raw);
    } catch(e) {}
  },

  reset() {
    this.sessions = {};
    try { localStorage.removeItem('token_tracker'); } catch(e) {}
    this.renderBar();
  },

  // ÌïòÎã® Î∞î Î†åÎçî
  renderBar() {
    let bar = document.getElementById('tokenBar');
    if (!bar) {
      bar = document.createElement('div');
      bar.id = 'tokenBar';
      bar.className = 'token-bar';
      document.body.appendChild(bar);
    }

    const { totalIn, totalOut, totalCost, totalCalls } = this.totals();
    const fmtN = n => n >= 1000 ? (n/1000).toFixed(1)+'K' : n;
    const fmtUSD = d => d < 0.001 ? '$0.000' : '$' + d.toFixed(4);
    const fmtKRW = d => '‚âà‚Ç©' + Math.round(d * 1380).toLocaleString();

    // ÎßàÏßÄÎßâ ÏÇ¨Ïö© Î™®Îç∏
    const lastModel = Object.keys(this.sessions).slice(-1)[0];
    const lastLabel = lastModel ? (MODEL_PRICING[lastModel]?.label || lastModel) : '-';
    const isImg = lastModel && MODEL_PRICING[lastModel]?.type === 'image';

    bar.innerHTML = `
      <span class="tb-label">üí∞ API ÎπÑÏö©</span>
      <span class="tb-cost" id="tbCostVal">${fmtUSD(totalCost)}</span>
      <span class="tb-cost" style="color:var(--warn)">${fmtKRW(totalCost)}</span>
      <span class="sep">‚îÇ</span>
      <span class="tb-label">ÏûÖÎ†•</span>
      <span class="tb-val" id="tbIn">${fmtN(totalIn)} tok</span>
      <span class="tb-label">Ï∂úÎ†•</span>
      <span class="tb-val" id="tbOut">${fmtN(totalOut)} tok</span>
      <span class="sep">‚îÇ</span>
      <span class="tb-label">Ìò∏Ï∂ú</span>
      <span class="tb-val">${totalCalls}Ìöå</span>
      <span class="sep">‚îÇ</span>
      <span class="tb-label">ÎßàÏßÄÎßâ Î™®Îç∏</span>
      <span class="tb-model ${isImg?'m-img':'m-flash'}">${lastLabel}</span>
      <span class="sep">‚îÇ</span>
      <button class="token-detail-btn" id="tbDetailBtn">ÏÉÅÏÑ∏Î≥¥Í∏∞ ‚ñ≤</button>
      <button class="tb-reset" id="tbResetBtn">Ï¥àÍ∏∞Ìôî</button>
    `;

    // ÌïòÎã® Î∞î ÎïåÎ¨∏Ïóê main Ìå®Îî© Ï∂îÍ∞Ä
    const main = document.querySelector('.main');
    if (main) main.style.paddingBottom = '52px';

    document.getElementById('tbDetailBtn')?.addEventListener('click', () => {
      this.showDetail = !this.showDetail;
      this.renderDetail();
    });
    document.getElementById('tbResetBtn')?.addEventListener('click', () => {
      if (confirm('ÌÜ†ÌÅ∞ ÏÇ¨Ïö© Í∏∞Î°ùÏùÑ Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?')) this.reset();
    });
  },

  // ÏÉÅÏÑ∏ Î™®Îã¨
  renderDetail() {
    let modal = document.getElementById('tokenModal');
    if (!this.showDetail) { modal?.remove(); return; }

    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'tokenModal';
      modal.className = 'token-modal';
      document.body.appendChild(modal);
    }

    const fmtUSD = d => '$' + d.toFixed(5);
    const fmtKRW = d => '‚Ç©' + Math.round(d * 1380).toLocaleString();
    const fmtN   = n => n.toLocaleString();

    let rows = '';
    for (const [modelId, s] of Object.entries(this.sessions)) {
      const p   = MODEL_PRICING[modelId];
      const lbl = p?.label || modelId;
      const typ = p?.type  || 'text';
      rows += `
        <div class="token-row">
          <div>
            <div style="font-weight:600">${lbl}</div>
            <div class="model-name">${modelId}</div>
          </div>
          <div style="text-align:right;font-size:11px;line-height:1.8">
            <div>ÏûÖÎ†• <b>${fmtN(s.inputTokens)}</b> tok</div>
            <div>Ï∂úÎ†• <b>${fmtN(s.outputTokens)}</b> tok</div>
            ${typ==='image' ? `<div>Ïù¥ÎØ∏ÏßÄ <b>${s.imageCount}</b>Ïû•</div>` : ''}
            <div>Ìò∏Ï∂ú <b>${s.calls}</b>Ìöå</div>
            <div style="color:var(--ok);font-weight:700">${fmtUSD(s.costUSD)} ${fmtKRW(s.costUSD)}</div>
          </div>
        </div>`;
    }

    const { totalCost } = this.totals();
    modal.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3 style="margin:0">üìä Î™®Îç∏Î≥Ñ ÏÇ¨Ïö©Îüâ ÏÉÅÏÑ∏</h3>
        <span style="cursor:pointer;font-size:18px;color:var(--text-m)" id="closeTokenModal">‚úï</span>
      </div>
      ${rows || '<div style="color:var(--text-m);font-size:13px">ÏïÑÏßÅ API Ìò∏Ï∂ú ÏóÜÏùå</div>'}
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-size:13px;font-weight:700">
        <span>Ï¥ù ÎπÑÏö©</span>
        <span style="color:var(--ok)">${fmtUSD(totalCost)} (${fmtKRW(totalCost)})</span>
      </div>
      <div style="margin-top:8px;font-size:10px;color:var(--text-m)">
        * ÌôòÏú® 1USD = 1,380Ïõê Í∏∞Ï§Ä | Gemini Í≥µÏãù Í∞ÄÍ≤© Í∏∞Ï§Ä (Î≥ÄÎèô Í∞ÄÎä•)
      </div>
    `;
    document.getElementById('closeTokenModal')?.addEventListener('click', () => {
      this.showDetail = false;
      modal.remove();
    });
  },
};

// Ïï± ÏãúÏûë Ïãú Ï†ÄÏû•Îêú ÏÇ¨Ïö©Îüâ Î≥µÏõê
tokenTracker.load();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEMINI API SERVICE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class GeminiAPI {
  constructor(apiKey, model) {
    this.apiKey = apiKey;
    this.model = model || 'gemini-2.0-flash';
    this.baseUrl = 'https://generativelanguage.googleapis.com/v1beta';
  }

  async analyzeImage(imageBase64, mimeType) {
    const prompt = `You are a professional e-commerce product analyst. Analyze this product image in extreme detail.
Return a JSON object with the following fields:
{
    "product_name": "detected product name in Korean",
    "product_name_en": "detected product name in English",
    "category": "product category",
    "brand": "brand name if visible",
    "colors": ["list of colors detected"],
    "materials": ["detected or estimated materials"],
    "shape": "product shape description",
    "size_estimate": "estimated size",
    "key_features": ["list of 5-10 key features"],
    "target_audience": "target customer demographic",
    "price_range_estimate": "estimated price range in KRW",
    "mood": "overall mood/aesthetic of the product",
    "use_cases": ["list of use cases"],
    "selling_points": ["list of unique selling points"],
    "style_keywords": ["style-related keywords for design"],
    "complementary_colors": ["colors that complement the product"],
    "text_color_recommendation": "recommended text color for overlay",
    "detailed_description": "A detailed Korean description for marketing"
}
Respond ONLY with the JSON object, no other text.`;

    const body = {
      contents: [{
        parts: [
          { text: prompt },
          { inline_data: { mime_type: mimeType, data: imageBase64 } }
        ]
      }],
      generationConfig: { temperature: 0.3, maxOutputTokens: 4096 }
    };

    const res = await fetch(`${this.baseUrl}/models/${this.model}:generateContent?key=${this.apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    tokenTracker.record(this.model, data.usageMetadata?.promptTokenCount, data.usageMetadata?.candidatesTokenCount);
    let text = data.candidates[0].content.parts[0].text.trim();
    text = text.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'');
    return JSON.parse(text);
  }

  async generateSectionContent(sectionDef, productAnalysis, customInstructions, competitorRef, referenceRatio) {
    const ratio = referenceRatio || { competitor: 80, own: 20 };
    const ratioInstruction = ratio.competitor >= 70
      ? 'Closely mirror competitor emphasis points, proven selling messages, and section structure from Coupang/Naver top sellers.'
      : ratio.own >= 70
        ? 'Focus primarily on unique product features from image analysis. Differentiate strongly from competitors.'
        : 'Balance competitor insights with product-specific unique features equally.';

    const prompt = `You are a Korean e-commerce detail page content creator.

== PRODUCT ANALYSIS (Own Image) ==
${JSON.stringify(productAnalysis, null, 2)}

${competitorRef ? `== COMPETITOR REFERENCE (Coupang & Naver) ==\n${competitorRef}` : ''}

== CONTENT REFERENCE RATIO ==
Competitor reference: ${ratio.competitor}% / Own product analysis: ${ratio.own}%
Instruction: ${ratioInstruction}

== SECTION TO CREATE ==
Section: ${sectionDef.name}
Number: ${sectionDef.n || 'Extra'}
Purpose: ${sectionDef.purpose}
User instructions: ${customInstructions || 'None'}

Generate content for this section. Return ONLY a JSON object:
{
    "headline": "Main headline text in Korean (impactful, short)",
    "subheadline": "Sub headline in Korean",
    "body_text": "Body copy in Korean (2-3 sentences)",
    "cta_text": "Call to action text if applicable, or empty string",
    "layout_suggestion": "Layout recommendation",
    "color_scheme": {
        "background": "#hex",
        "text_primary": "#hex",
        "text_secondary": "#hex",
        "accent": "#hex"
    },
    "font_suggestion": {
        "headline_font": "Noto Sans KR",
        "headline_size": "px value like 42px",
        "headline_weight": "700 or 900",
        "body_font": "Noto Sans KR",
        "body_size": "px value like 16px"
    },
    "image_description": "Detailed description of what the section image should look like",
    "product_placement": "Description of how the product image should be placed",
    "design_notes": "Additional design recommendations",
    "extra_elements": ["list of bullet points or features if applicable"]
}
Respond ONLY with the JSON object.`;

    const body = {
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
    };

    const res = await fetch(`${this.baseUrl}/models/${this.model}:generateContent?key=${this.apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    tokenTracker.record(this.model, data.usageMetadata?.promptTokenCount, data.usageMetadata?.candidatesTokenCount);
    let text = data.candidates[0].content.parts[0].text.trim();
    text = text.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'');
    return JSON.parse(text);
  }

  async generateImage(prompt, productImageBase64, mimeType, imageModel) {
    const imgMod = imageModel || getImageModel();
    const cfg = state.modelConfig;
    const sizeHint = (cfg.imageSizeMode === 'custom' && cfg.imageWidth)
      ? `Exact size: ${cfg.imageWidth}px wide${cfg.imageHeight ? ' √ó ' + cfg.imageHeight + 'px tall' : ''}.`
      : 'Size: 860px wide.';
    const parts = [
      { text: `Create a professional Korean e-commerce product detail page section image. ${prompt} Style: clean, modern, high-end Korean shopping mall aesthetic. ${sizeHint}` }
    ];
    if (productImageBase64) {
      parts.push({ inline_data: { mime_type: mimeType, data: productImageBase64 } });
    }

    const body = {
      contents: [{ parts }],
      generationConfig: {
        temperature: 0.8,
        responseModalities: ["TEXT", "IMAGE"]
      }
    };

    try {
      const res = await fetch(`${this.baseUrl}/models/${imgMod}:generateContent?key=${this.apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error.message);
      tokenTracker.record(imgMod, data.usageMetadata?.promptTokenCount, data.usageMetadata?.candidatesTokenCount, true);

      for (const part of data.candidates[0].content.parts) {
        let raw = null;
        if (part.inlineData && part.inlineData.mimeType?.startsWith('image/')) {
          raw = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
        } else if (part.inline_data && part.inline_data.mime_type?.startsWith('image/')) {
          raw = `data:${part.inline_data.mime_type};base64,${part.inline_data.data}`;
        }
        if (raw) return await applyImageSizeConfig(raw);
      }
      return null;
    } catch (e) {
      console.warn('Image generation failed:', e.message);
      return null;
    }
  }

  async searchSimilarProducts(productName, category, scrapedDataJson) {
    const scrapedSection = scrapedDataJson
      ? `\n\n== Ïã§Ï†ú Ïä§ÌÅ¨ÎûòÌïëÎêú Ï†úÌíà Îç∞Ïù¥ÌÑ∞ ==\n${scrapedDataJson}\nÏúÑ Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú Î∂ÑÏÑùÏùÑ Í∞ïÌôîÌïòÏÑ∏Ïöî.`
      : '\n\nÏã§Ï†ú Ïä§ÌÅ¨ÎûòÌïë Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå ‚Üí ÌïúÍµ≠ ÏáºÌïëÎ™∞ Ï†ÑÎ¨∏ ÏßÄÏãù Í∏∞Î∞òÏúºÎ°ú ÌòÑÏã§Ï†ÅÏù∏ Îç∞Ïù¥ÌÑ∞Î•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.';
    const prompt = `You are a Korean e-commerce market analyst specializing in Coupang and Naver Smart Store.
Analyze the market for product "${productName}" (category: "${category}").${scrapedSection}

Return ONLY a JSON object (no markdown):
{
  "coupang_products": [
    {
      "name": "Ï†úÌíàÎ™Ö (Korean)",
      "price_range": "Í∞ÄÍ≤©ÎåÄ (Ïòà: 15,000~25,000Ïõê)",
      "seller": "ÏÖÄÎü¨Î™Ö",
      "rating": "4.7",
      "review_count": "2,847",
      "url": null,
      "detail_page_emphasis": ["Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏1", "Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏2", "Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏3"],
      "key_selling_messages": ["ÌïµÏã¨ ÌåêÎß§ Î©îÏãúÏßÄ1", "ÌïµÏã¨ ÌåêÎß§ Î©îÏãúÏßÄ2"],
      "section_structure": ["Ìó§Îçî", "ÌïµÏã¨ÌäπÏßï", "ÏÉÅÏÑ∏Ïä§Ìéô", "ÏÇ¨Ïö©ÌõÑÍ∏∞", "Î∞∞ÏÜ°Ï†ïÎ≥¥"],
      "visual_style": "ÎπÑÏ£ºÏñº Ïä§ÌÉÄÏùº ÏÑ§Î™Ö"
    }
  ],
  "naver_products": [
    {
      "name": "Ï†úÌíàÎ™Ö (Korean)",
      "price_range": "Í∞ÄÍ≤©ÎåÄ",
      "store_name": "Ïä§ÎßàÌä∏Ïä§ÌÜ†Ïñ¥Î™Ö",
      "rating": "4.5",
      "review_count": "1,200",
      "url": null,
      "detail_page_emphasis": ["Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏1", "Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏2"],
      "key_selling_messages": ["ÌïµÏã¨ ÌåêÎß§ Î©îÏãúÏßÄ1", "ÌïµÏã¨ ÌåêÎß§ Î©îÏãúÏßÄ2"],
      "section_structure": ["ÏÑπÏÖò1", "ÏÑπÏÖò2", "ÏÑπÏÖò3"],
      "visual_style": "ÎπÑÏ£ºÏñº Ïä§ÌÉÄÏùº"
    }
  ],
  "market_insights": "ÏãúÏû• Î∂ÑÏÑù ÏöîÏïΩ (ÌïúÍµ≠Ïñ¥ 3-4Î¨∏Ïû•)",
  "detail_page_trends": ["Ìä∏Î†åÎìú1", "Ìä∏Î†åÎìú2", "Ìä∏Î†åÎìú3", "Ìä∏Î†åÎìú4"],
  "recommended_approach": "Ï∂îÏ≤ú ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ï†ÑÎûµ (ÌïúÍµ≠Ïñ¥)",
  "common_section_patterns": ["Í≥µÌÜµ ÏÑπÏÖò Ìå®ÌÑ¥1", "Ìå®ÌÑ¥2"],
  "top_selling_emphasis": ["Í≥µÌÜµ Í∞ïÏ°∞ ÏöîÏÜå1", "ÏöîÏÜå2", "ÏöîÏÜå3"]
}
Generate 3-5 products per platform. ONLY JSON, no other text.`;

    const body = {
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.5, maxOutputTokens: 3000 }
    };

    const res = await fetch(`${this.baseUrl}/models/${this.model}:generateContent?key=${this.apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    tokenTracker.record(this.model, data.usageMetadata?.promptTokenCount, data.usageMetadata?.candidatesTokenCount);
    let text = data.candidates[0].content.parts[0].text.trim();
    text = text.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'');
    return JSON.parse(text);
  }

  async generateExtraSectionSuggestions(productAnalysis, competitorData, existingSectionIds) {
    const prompt = `You are a Korean e-commerce detail page expert.

Product Analysis:
${JSON.stringify(productAnalysis, null, 2)}

Competitor Data (Coupang & Naver):
${JSON.stringify(competitorData, null, 2).substring(0, 2000)}

Existing standard sections (DO NOT suggest these): ${existingSectionIds.join(', ')}

Based on this specific product and competitor analysis, identify 2-5 ADDITIONAL sections
that would significantly improve this product's detail page beyond the standard sections.
Focus on sections that competitors specifically emphasize for this product category.

Return ONLY a JSON array:
[
  {
    "id": "unique_snake_case_id_no_korean",
    "name": "ÏÑπÏÖò Ïù¥Î¶Ñ (Korean)",
    "icon": "Í¥ÄÎ†® Ïù¥Î™®ÏßÄ",
    "purpose": "Ïù¥ ÏÑπÏÖòÏùò Î™©Ï†Å (Korean, 1-2Î¨∏Ïû•)",
    "desc": "ÏÑπÏÖò ÏÑ§Î™Ö (Korean, ÏßßÍ≤å)",
    "reason": "Ïôú Ïù¥ Ï†úÌíàÏóê ÌäπÌûà ÌïÑÏöîÌïúÏßÄ (Korean)"
  }
]
Respond ONLY with the JSON array.`;

    const body = {
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.6, maxOutputTokens: 2048 }
    };
    const res = await fetch(`${this.baseUrl}/models/${this.model}:generateContent?key=${this.apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    tokenTracker.record(this.model, data.usageMetadata?.promptTokenCount, data.usageMetadata?.candidatesTokenCount);
    let text = data.candidates[0].content.parts[0].text.trim();
    text = text.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'');
    return JSON.parse(text);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMAGE RESIZE HELPER (Canvas API ‚Äî Ï†ïÌôïÌïú ÌîΩÏÖÄ Í∞ïÏ†ú)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resizeImageDataUrl(dataUrl, targetW, targetH) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      try {
        const canvas = document.createElement('canvas');
        const ratio = img.naturalWidth / img.naturalHeight;
        const w = Math.round(targetW);
        // targetHÍ∞Ä nullÏù¥Î©¥ Í∞ÄÎ°ú/ÏÑ∏Î°ú ÎπÑÏú® Ïú†ÏßÄ
        const h = (targetH != null) ? Math.round(targetH) : Math.round(w / ratio);
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        // ÏÑ†Î™ÖÌïú Î†åÎçîÎßÅÏùÑ ÏúÑÌï¥ Ïù¥Ï§ë Ìå®Ïä§ Îã§Ïö¥Ïä§ÏºÄÏùº
        if (img.naturalWidth > w * 2 || img.naturalHeight > h * 2) {
          const tmp = document.createElement('canvas');
          tmp.width = Math.round(img.naturalWidth / 2);
          tmp.height = Math.round(img.naturalHeight / 2);
          tmp.getContext('2d').drawImage(img, 0, 0, tmp.width, tmp.height);
          ctx.drawImage(tmp, 0, 0, w, h);
        } else {
          ctx.drawImage(img, 0, 0, w, h);
        }
        resolve(canvas.toDataURL('image/png'));
      } catch(e) {
        // Î¶¨ÏÇ¨Ïù¥Ï¶à Ïã§Ìå® Ïãú ÏõêÎ≥∏ Î∞òÌôò
        console.warn('resizeImageDataUrl failed, using original:', e);
        resolve(dataUrl);
      }
    };
    img.onerror = () => resolve(dataUrl); // Î°úÎìú Ïã§Ìå® Ïãú ÏõêÎ≥∏ Î∞òÌôò
    img.src = dataUrl;
  });
}

// ÌòÑÏû¨ ÏÑ§Ï†ïÏóê Îî∞Îùº Ïù¥ÎØ∏ÏßÄÎ•º Î¶¨ÏÇ¨Ïù¥Ï¶à (auto Î™®ÎìúÎ©¥ Í∑∏ÎÉ• Î∞òÌôò)
async function applyImageSizeConfig(dataUrl) {
  const cfg = state.modelConfig;
  if (!dataUrl || cfg.imageSizeMode !== 'custom' || !cfg.imageWidth) return dataUrl;
  return resizeImageDataUrl(dataUrl, cfg.imageWidth, cfg.imageHeight || null);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OPENAI API SERVICE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class OpenAIAPI {
  constructor(apiKey, model) {
    this.apiKey = apiKey;
    this.model = model || 'gpt-4o-mini';
    this.baseUrl = 'https://api.openai.com/v1';
  }

  // JSON ÏùëÎãµ ÌååÏã± Ìó¨Ìçº
  _parseJSON(text) {
    text = text.trim().replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'');
    return JSON.parse(text);
  }

  async analyzeImage(imageBase64, mimeType) {
    const prompt = `You are a professional e-commerce product analyst. Analyze this product image in extreme detail.
Return a JSON object with the following fields:
{
    "product_name": "detected product name in Korean",
    "product_name_en": "detected product name in English",
    "category": "product category",
    "brand": "brand name if visible",
    "colors": ["list of colors detected"],
    "materials": ["detected or estimated materials"],
    "shape": "product shape description",
    "size_estimate": "estimated size",
    "key_features": ["list of 5-10 key features"],
    "target_audience": "target customer demographic",
    "price_range_estimate": "estimated price range in KRW",
    "mood": "overall mood/aesthetic of the product",
    "use_cases": ["list of use cases"],
    "selling_points": ["list of unique selling points"],
    "style_keywords": ["style-related keywords for design"],
    "complementary_colors": ["colors that complement the product"],
    "text_color_recommendation": "recommended text color for overlay",
    "detailed_description": "A detailed Korean description for marketing"
}
Respond ONLY with the JSON object, no other text.`;

    const body = {
      model: this.model,
      messages: [{
        role: 'user',
        content: [
          { type: 'text', text: prompt },
          { type: 'image_url', image_url: { url: `data:${mimeType};base64,${imageBase64}`, detail: 'high' } }
        ]
      }],
      max_tokens: 4096,
      temperature: 0.3,
    };

    const res = await fetch(`${this.baseUrl}/chat/completions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiKey}` },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    tokenTracker.record(this.model, data.usage?.prompt_tokens, data.usage?.completion_tokens);
    return this._parseJSON(data.choices[0].message.content);
  }

  async generateSectionContent(sectionDef, productAnalysis, customInstructions, competitorRef, referenceRatio) {
    const ratio = referenceRatio || { competitor: 80, own: 20 };
    const ratioInstruction = ratio.competitor >= 70
      ? 'Closely mirror competitor emphasis points, proven selling messages, and section structure from Coupang/Naver top sellers.'
      : ratio.own >= 70
        ? 'Focus primarily on unique product features from image analysis. Differentiate strongly from competitors.'
        : 'Balance competitor insights with product-specific unique features equally.';

    const prompt = `You are a Korean e-commerce detail page content creator.

== PRODUCT ANALYSIS (Own Image) ==
${JSON.stringify(productAnalysis, null, 2)}

${competitorRef ? `== COMPETITOR REFERENCE (Coupang & Naver) ==\n${competitorRef}` : ''}

== CONTENT REFERENCE RATIO ==
Competitor reference: ${ratio.competitor}% / Own product analysis: ${ratio.own}%
Instruction: ${ratioInstruction}

== SECTION TO CREATE ==
Section: ${sectionDef.name}
Number: ${sectionDef.n || 'Extra'}
Purpose: ${sectionDef.purpose}
User instructions: ${customInstructions || 'None'}

Generate content for this section. Return ONLY a JSON object:
{
    "headline": "Main headline text in Korean (impactful, short)",
    "subheadline": "Sub headline in Korean",
    "body_text": "Body copy in Korean (2-3 sentences)",
    "cta_text": "Call to action text if applicable, or empty string",
    "layout_suggestion": "Layout recommendation",
    "color_scheme": {
        "background": "#hex",
        "text_primary": "#hex",
        "text_secondary": "#hex",
        "accent": "#hex"
    },
    "font_suggestion": {
        "headline_font": "Noto Sans KR",
        "headline_size": "px value like 42px",
        "headline_weight": "700 or 900",
        "body_font": "Noto Sans KR",
        "body_size": "px value like 16px"
    },
    "image_description": "Detailed description of what the section image should look like",
    "product_placement": "Description of how the product image should be placed",
    "design_notes": "Additional design recommendations",
    "extra_elements": ["list of bullet points or features if applicable"]
}
Respond ONLY with the JSON object.`;

    const body = {
      model: this.model,
      messages: [{ role: 'user', content: prompt }],
      max_tokens: 2048,
      temperature: 0.7,
    };

    const res = await fetch(`${this.baseUrl}/chat/completions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiKey}` },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    tokenTracker.record(this.model, data.usage?.prompt_tokens, data.usage?.completion_tokens);
    return this._parseJSON(data.choices[0].message.content);
  }

  async searchSimilarProducts(productName, category, scrapedDataJson) {
    const scrapedSection = scrapedDataJson
      ? `\n\n== Ïã§Ï†ú Ïä§ÌÅ¨ÎûòÌïëÎêú Ï†úÌíà Îç∞Ïù¥ÌÑ∞ ==\n${scrapedDataJson}\nÏúÑ Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú Î∂ÑÏÑùÏùÑ Í∞ïÌôîÌïòÏÑ∏Ïöî.`
      : '\n\nÏã§Ï†ú Ïä§ÌÅ¨ÎûòÌïë Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå ‚Üí ÌïúÍµ≠ ÏáºÌïëÎ™∞ Ï†ÑÎ¨∏ ÏßÄÏãù Í∏∞Î∞òÏúºÎ°ú ÌòÑÏã§Ï†ÅÏù∏ Îç∞Ïù¥ÌÑ∞Î•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.';
    const prompt = `You are a Korean e-commerce market analyst specializing in Coupang and Naver Smart Store.
Analyze the market for product "${productName}" (category: "${category}").${scrapedSection}

Return ONLY a JSON object (no markdown):
{
  "coupang_products": [
    {
      "name": "Ï†úÌíàÎ™Ö (Korean)",
      "price_range": "Í∞ÄÍ≤©ÎåÄ (Ïòà: 15,000~25,000Ïõê)",
      "seller": "ÏÖÄÎü¨Î™Ö",
      "rating": "4.7",
      "review_count": "2,847",
      "url": null,
      "detail_page_emphasis": ["Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏1", "Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏2", "Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏3"],
      "key_selling_messages": ["ÌïµÏã¨ ÌåêÎß§ Î©îÏãúÏßÄ1", "ÌïµÏã¨ ÌåêÎß§ Î©îÏãúÏßÄ2"],
      "section_structure": ["Ìó§Îçî", "ÌïµÏã¨ÌäπÏßï", "ÏÉÅÏÑ∏Ïä§Ìéô", "ÏÇ¨Ïö©ÌõÑÍ∏∞", "Î∞∞ÏÜ°Ï†ïÎ≥¥"],
      "visual_style": "ÎπÑÏ£ºÏñº Ïä§ÌÉÄÏùº ÏÑ§Î™Ö"
    }
  ],
  "naver_products": [
    {
      "name": "Ï†úÌíàÎ™Ö (Korean)",
      "price_range": "Í∞ÄÍ≤©ÎåÄ",
      "store_name": "Ïä§ÎßàÌä∏Ïä§ÌÜ†Ïñ¥Î™Ö",
      "rating": "4.5",
      "review_count": "1,200",
      "url": null,
      "detail_page_emphasis": ["Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏1", "Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏2"],
      "key_selling_messages": ["ÌïµÏã¨ ÌåêÎß§ Î©îÏãúÏßÄ1", "ÌïµÏã¨ ÌåêÎß§ Î©îÏãúÏßÄ2"],
      "section_structure": ["ÏÑπÏÖò1", "ÏÑπÏÖò2", "ÏÑπÏÖò3"],
      "visual_style": "ÎπÑÏ£ºÏñº Ïä§ÌÉÄÏùº"
    }
  ],
  "market_insights": "ÏãúÏû• Î∂ÑÏÑù ÏöîÏïΩ (ÌïúÍµ≠Ïñ¥ 3-4Î¨∏Ïû•)",
  "detail_page_trends": ["Ìä∏Î†åÎìú1", "Ìä∏Î†åÎìú2", "Ìä∏Î†åÎìú3", "Ìä∏Î†åÎìú4"],
  "recommended_approach": "Ï∂îÏ≤ú ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ï†ÑÎûµ (ÌïúÍµ≠Ïñ¥)",
  "common_section_patterns": ["Í≥µÌÜµ ÏÑπÏÖò Ìå®ÌÑ¥1", "Ìå®ÌÑ¥2"],
  "top_selling_emphasis": ["Í≥µÌÜµ Í∞ïÏ°∞ ÏöîÏÜå1", "ÏöîÏÜå2", "ÏöîÏÜå3"]
}
Generate 3-5 products per platform. ONLY JSON, no other text.`;

    const body = {
      model: this.model,
      messages: [{ role: 'user', content: prompt }],
      max_tokens: 3000,
      temperature: 0.5,
    };

    const res = await fetch(`${this.baseUrl}/chat/completions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiKey}` },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    tokenTracker.record(this.model, data.usage?.prompt_tokens, data.usage?.completion_tokens);
    return this._parseJSON(data.choices[0].message.content);
  }

  async generateExtraSectionSuggestions(productAnalysis, competitorData, existingSectionIds) {
    const prompt = `You are a Korean e-commerce detail page expert.

Product Analysis:
${JSON.stringify(productAnalysis, null, 2)}

Competitor Data (Coupang & Naver):
${JSON.stringify(competitorData, null, 2).substring(0, 2000)}

Existing standard sections (DO NOT suggest these): ${existingSectionIds.join(', ')}

Based on this specific product and competitor analysis, identify 2-5 ADDITIONAL sections
that would significantly improve this product's detail page beyond the standard sections.
Focus on sections that competitors specifically emphasize for this product category.

Return ONLY a JSON array:
[
  {
    "id": "unique_snake_case_id_no_korean",
    "name": "ÏÑπÏÖò Ïù¥Î¶Ñ (Korean)",
    "icon": "Í¥ÄÎ†® Ïù¥Î™®ÏßÄ",
    "purpose": "Ïù¥ ÏÑπÏÖòÏùò Î™©Ï†Å (Korean, 1-2Î¨∏Ïû•)",
    "desc": "ÏÑπÏÖò ÏÑ§Î™Ö (Korean, ÏßßÍ≤å)",
    "reason": "Ïôú Ïù¥ Ï†úÌíàÏóê ÌäπÌûà ÌïÑÏöîÌïúÏßÄ (Korean)"
  }
]
Respond ONLY with the JSON array.`;

    const body = {
      model: this.model,
      messages: [{ role: 'user', content: prompt }],
      max_tokens: 2048,
      temperature: 0.6,
    };
    const res = await fetch(`${this.baseUrl}/chat/completions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.apiKey}` },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    tokenTracker.record(this.model, data.usage?.prompt_tokens, data.usage?.completion_tokens);
    return this._parseJSON(data.choices[0].message.content);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LLM ROUTER ‚Äî ÏÑ†ÌÉùÎêú ÌîÑÎ°úÎ∞îÏù¥Îçî/Î™®Îç∏Î°ú ÏûêÎèô Î∂ÑÍ∏∞
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getLLMClient() {
  const cfg = state.modelConfig;
  if (cfg.llmProvider === 'openai') {
    if (!state.openaiKey) throw new Error('OpenAI API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Î™®Îç∏ ÏÑ§Ï†ïÏóêÏÑú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
    return new OpenAIAPI(state.openaiKey, cfg.llmModel);
  }
  // gemini
  if (!state.apiKey) throw new Error('Gemini API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
  return new GeminiAPI(state.apiKey, cfg.llmModel);
}

function getImageModel() {
  return state.modelConfig.imageModel || 'gemini-3-pro-image-preview';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSISTENT STORAGE (works on file:// too)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveKey(key) {
  try { localStorage.setItem('gemini_api_key', key); } catch(e) {}
  try { document.cookie = `gemini_api_key=${encodeURIComponent(key)};max-age=31536000;path=/;SameSite=Lax`; } catch(e) {}
}
function loadKey() {
  let k = '';
  try { k = localStorage.getItem('gemini_api_key') || ''; } catch(e) {}
  if (!k) {
    try {
      const m = document.cookie.match(/gemini_api_key=([^;]+)/);
      if (m) k = decodeURIComponent(m[1]);
    } catch(e) {}
  }
  return k;
}

// ÏÑπÏÖòÎ≥Ñ ÏßÄÏãúÏÇ¨Ìï≠ Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞
function saveSectionInstructions(instructions) {
  try { localStorage.setItem('section_instructions', JSON.stringify(instructions)); } catch(e) {}
}
function loadSectionInstructions() {
  try {
    const raw = localStorage.getItem('section_instructions');
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return {};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEMO_CONFIG ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏúºÎ©¥ localStorageÏóê Ï£ºÏûÖ (Î™®Îã¨ ÏóÜÏù¥ Î∞îÎ°ú ÏÇ¨Ïö©)
if (DEMO_CONFIG.enabled && DEMO_CONFIG.geminiKey) {
  try { localStorage.setItem('gemini_api_key', DEMO_CONFIG.geminiKey); } catch(e) {}
}
if (DEMO_CONFIG.enabled && DEMO_CONFIG.openaiKey) {
  try { localStorage.setItem('openai_api_key', DEMO_CONFIG.openaiKey); } catch(e) {}
}

const _savedKey = loadKey();
const _savedInstructions = loadSectionInstructions();
const _savedModelConfig = loadModelConfig();
const state = {
  step: 'upload', // upload | analyzing | planning | searching | verifying | sections | generating | preview | modelsettings
  apiKey: _savedKey,
  showApiModal: (DEMO_CONFIG.enabled && DEMO_CONFIG.geminiKey) ? false : !_savedKey,
  modelConfig: _savedModelConfig,
  openaiKey: loadOpenAIKey(),
  productName: '',
  imagePreview: null,
  imageBase64: null,
  imageMime: null,
  analysis: null,
  competitorData: null,
  verificationMode: 'auto',       // 'auto' | 'manual'
  verificationResult: [],          // manual Î™®Îìú ÏÑ†ÌÉùÎêú Ï†úÌíà Ïù∏Îç±Ïä§
  extraSections: [],               // AIÍ∞Ä Í≤∞Ï†ïÌïú Ï∂îÍ∞Ä ÏÑπÏÖò Ï†ïÏùò
  extraSectionContents: {},        // Ï∂îÍ∞Ä ÏÑπÏÖò ÏΩòÌÖêÏ∏†
  extraSectionImages: {},          // Ï∂îÍ∞Ä ÏÑπÏÖò Ïù¥ÎØ∏ÏßÄ
  referenceRatio: JSON.parse(localStorage.getItem('reference_ratio') || '{"competitor":80,"own":20}'),
  scrapedProductList: [],          // Ïä§ÌÅ¨ÎûòÌïëÏúºÎ°ú Ï∞æÏùÄ Ï†úÌíà Î™©Î°ù
  searchStatus: {},                // { coupang: 'pending'|'ok:N'|'blocked'|'ai-sim', naver: ..., details: ... }
  doCompetitorSearch: true,        // planning ÌôîÎ©¥ÏóêÏÑú ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉù
  sectionInstructions: _savedInstructions,
  sectionContents: {},
  sectionImages: {},
  progress: 0,
  progressMsg: '',
  error: '',
  activeSectionEdit: null,
  editingPreviewSection: null,
  // ‚îÄ‚îÄ Image Cuts ‚îÄ‚îÄ
  cuts: {
    sourceBase64: null,
    sourceMime: null,
    sourcePreview: null,
    prompts: loadPrompts(),
    // ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑπÏÖò Î∞∞Ïπò: { sectionId: cutId }
    placement: JSON.parse(localStorage.getItem('cuts_placement') || '{}'),
  },
  // ‚îÄ‚îÄ Automation ‚îÄ‚îÄ
  auto: {
    driveConnected: false,
    accessToken: null,
    gdClientId: localStorage.getItem('gd_client_id') || '',
    inputFolderId: localStorage.getItem('auto_input_folder_id') || '',
    inputFolderName: localStorage.getItem('auto_input_folder_name') || '',
    outputFolderId: localStorage.getItem('auto_output_folder_id') || '',
    outputFolderName: localStorage.getItem('auto_output_folder_name') || '',
    intervalMin: parseInt(localStorage.getItem('auto_interval') || '20'),
    running: false,
    queue: [],
    completed: JSON.parse(localStorage.getItem('auto_completed') || '[]'),
    currentItem: null,
    currentProgress: 0,
    currentMsg: '',
    timerId: null,
    nextRunAt: null,
    totalProcessed: parseInt(localStorage.getItem('auto_total_processed') || '0'),
    processedFileIds: new Set(JSON.parse(localStorage.getItem('auto_processed_ids') || '[]')),
  },
};

let gemini = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() {
  const app = document.getElementById('app');
  app.innerHTML = `
    ${state.showApiModal ? renderApiModal() : ''}
    <div class="app">
      ${renderSidebar()}
      <main class="main">
        <div class="container">
          ${state.error ? renderError() : ''}
          ${state.step === 'upload' ? renderUpload() : ''}
          ${state.step === 'analyzing' ? renderAnalyzing() : ''}
          ${state.step === 'planning' ? renderPlanning() : ''}
          ${state.step === 'searching' ? renderSearching() : ''}
          ${state.step === 'verifying' ? renderVerifying() : ''}
          ${state.step === 'sections' ? renderSections() : ''}
          ${state.step === 'generating' ? renderGenerating() : ''}
          ${state.step === 'preview' ? renderPreview() : ''}
          ${state.step === 'imagecuts' ? renderImageCuts() : ''}
          ${state.step === 'automation' ? renderAutomation() : ''}
          ${state.step === 'modelsettings' ? renderModelSettings() : ''}
        </div>
      </main>
    </div>
  `;
  bindEvents();
}

function renderApiModal() {
  const hasSaved = !!state.apiKey;
  return `<div class="modal-overlay" id="apiModal">
    <div class="modal">
      <h2>üîë API ÌÇ§ ÏÑ§Ï†ï</h2>
      <p>Google Gemini API ÌÇ§Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî. <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--primary)">Ïó¨Í∏∞ÏÑú Î∞úÍ∏â</a> Î∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§.</p>
      ${hasSaved ? '<p style="margin-top:-12px;margin-bottom:12px;font-size:12px;color:var(--ok)">‚úÖ Ïù¥Ï†ÑÏóê Ï†ÄÏû•Ìïú API ÌÇ§Í∞Ä ÏûàÏäµÎãàÎã§.</p>' : ''}
      <div class="input-group">
        <label class="label">Gemini API Key</label>
        <div style="position:relative">
          <input type="text" class="input" id="apiKeyInput" value="${state.apiKey}" placeholder="AIza..." style="padding-right:40px;font-family:monospace;font-size:13px">
          <span class="material-icons-outlined" id="toggleKeyVis" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:var(--text-m)">visibility</span>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-primary" id="saveApiKey">
          <span class="material-icons-outlined" style="font-size:18px">save</span>
          Ï†ÄÏû• ÌõÑ ÏãúÏûë
        </button>
        ${hasSaved ? '<button class="btn-sm" id="skipApiModal" style="padding:12px 20px">Í∏∞Ï°¥ ÌÇ§Î°ú Í≥ÑÏÜç</button>' : ''}
      </div>
    </div>
  </div>`;
}

function renderSidebar() {
  const items = [
    {icon:'upload_file',label:'Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú',step:'upload',always:true},
    {icon:'analytics',label:'AI Î∂ÑÏÑù',step:'analyzing',need:'analysis'},
    {icon:'dashboard_customize',label:'ÏÑπÏÖò ÏÑ§Ï†ï',step:'sections',need:'analysis'},
    {icon:'auto_fix_high',label:'ÏûêÎèô ÏÉùÏÑ±',step:'generating',need:'analysis'},
    {icon:'preview',label:'ÎØ∏Î¶¨Î≥¥Í∏∞',step:'preview',need:'preview'},
    {icon:'auto_awesome',label:'Ïù¥ÎØ∏ÏßÄÏª∑ ÏÉùÏÑ±',step:'imagecuts',always:true},
    {icon:'cloud_sync',label:'ÏûêÎèôÌôî',step:'automation',always:true},
    {icon:'tune',label:'Î™®Îç∏ ÏÑ§Ï†ï',step:'modelsettings',always:true},
  ];
  const cfg = state.modelConfig;
  const prov = LLM_PROVIDERS[cfg.llmProvider];
  const mdl = prov?.models.find(m => m.id === cfg.llmModel);
  const imgMdl = IMAGE_MODELS.find(m => m.id === cfg.imageModel);

  return `<aside class="sidebar">
    <div class="logo">
      <span class="logo-icon">‚ú¶</span>
      <div><span class="logo-text">ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ</span><br><span class="logo-sub">Auto Generator</span></div>
    </div>
    ${DEMO_CONFIG.enabled && DEMO_CONFIG.geminiKey ? `<div style="margin:0 12px 4px;padding:6px 10px;background:linear-gradient(135deg,#7c3aed22,#2563eb22);border:1px solid #7c3aed44;border-radius:8px;font-size:10px;color:#a78bfa;text-align:center;font-weight:600">üéØ Îç∞Î™® Î™®Îìú ‚Äî API ÌÇ§ ÎÇ¥Ïû•Îê®</div>` : ''}
    <nav class="nav">
      ${items.map(it => {
        const active = state.step === it.step;
        const disabled = !it.always && it.need === 'analysis' && !state.analysis && state.step !== it.step;
        const disabledPreview = it.need === 'preview' && Object.keys(state.sectionContents).length === 0;
        return `<button class="nav-item ${active?'active':''} ${disabled||disabledPreview?'disabled':''}" data-nav="${it.step}">
          <span class="material-icons-outlined" style="font-size:20px">${it.icon}</span>
          <span>${it.label}</span>
        </button>`;
      }).join('')}
    </nav>
    <!-- ÌòÑÏû¨ Î™®Îç∏ ÌëúÏãú -->
    <div style="padding:8px 12px;border-top:1px solid var(--border);font-size:10px;color:var(--text-m)">
      <div style="margin-bottom:4px">LLM: <span style="color:${cfg.llmProvider==='openai'?'#10a37f':'var(--primary-h)'};font-weight:700">${mdl?.label||cfg.llmModel}</span></div>
      <div>IMG: <span style="color:var(--orange);font-weight:700">${imgMdl?.label||cfg.imageModel}</span></div>
    </div>
    <div style="padding:12px 16px;border-top:1px solid var(--border)">
      <button class="btn-sm" id="changeApiKey" style="width:100%;justify-content:center">
        <span class="material-icons-outlined" style="font-size:14px">key</span> API ÌÇ§ Î≥ÄÍ≤Ω
      </button>
    </div>
  </aside>`;
}

function renderError() {
  return `<div class="error-bar">
    <span class="material-icons-outlined" style="font-size:18px">error_outline</span>
    <span style="flex:1">${state.error}</span>
    <span class="material-icons-outlined" style="font-size:18px;cursor:pointer" id="closeError">close</span>
  </div>`;
}

function renderUpload() {
  return `<div class="fade-in">
    <h1 class="page-title">ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏûêÎèô ÏÉùÏÑ±</h1>
    <p class="page-desc">Ï†úÌíà Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÎ©¥ AIÍ∞Ä Î∂ÑÏÑùÌïòÏó¨ 15Í∞ú ÏÑπÏÖòÏùò ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ•º ÏûêÎèôÏúºÎ°ú ÏÉùÏÑ±Ìï©ÎãàÎã§.</p>

    <div class="upload-area ${state.imagePreview?'has-image':''}" id="uploadArea">
      ${state.imagePreview
        ? `<img src="${state.imagePreview}" class="preview-img" alt="preview">`
        : `<div style="display:flex;flex-direction:column;align-items:center">
            <span class="material-icons-outlined" style="font-size:48px;color:var(--primary);margin-bottom:12px">cloud_upload</span>
            <p style="font-size:16px;font-weight:500">ÌÅ¥Î¶≠ ÎòêÎäî ÎìúÎûòÍ∑∏ÌïòÏó¨ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</p>
            <p style="font-size:13px;color:var(--text-m);margin-top:6px">JPG, PNG, WEBP ÏßÄÏõê (ÏµúÎåÄ 50MB)</p>
          </div>`
      }
      <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>

    <div class="input-group">
      <label class="label">Ï†úÌíàÎ™Ö (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
      <input type="text" class="input" id="productNameInput" value="${state.productName}" placeholder="AIÍ∞Ä ÏûêÎèô Í∞êÏßÄÌïòÏßÄÎßå, ÏßÅÏ†ë ÏûÖÎ†•ÌïòÎ©¥ Îçî Ï†ïÌôïÌï©ÎãàÎã§">
    </div>

    <button class="btn-primary" id="startAnalysis" ${!state.imagePreview?'disabled':''}>
      <span class="material-icons-outlined" style="font-size:20px">auto_fix_high</span>
      AI Î∂ÑÏÑù ÏãúÏûë
    </button>

    <div class="feature-grid">
      <div class="feature-card"><div class="mi material-icons-outlined">visibility</div><h4>Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù</h4><p>Gemini AIÍ∞Ä Ï†úÌíà ÌäπÏßïÏùÑ ÏûêÎèô Î∂ÑÏÑù</p></div>
      <div class="feature-card"><div class="mi material-icons-outlined">search</div><h4>Í≤ΩÏüÅ Î∂ÑÏÑù</h4><p>Ïú†ÏÇ¨ Ï†úÌíàÏùò ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ï∞∏Ï°∞ Í≤ÄÏÉâ</p></div>
      <div class="feature-card"><div class="mi material-icons-outlined">dashboard</div><h4>15ÏÑπÏÖò ÏûêÎèôÏÉùÏÑ±</h4><p>Ìó§ÎçîÎ∂ÄÌÑ∞ CTAÍπåÏßÄ ÌíÄ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ</p></div>
      <div class="feature-card"><div class="mi material-icons-outlined">image</div><h4>Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±</h4><p>Í∞Å ÏÑπÏÖòÏóê ÎßûÎäî Ïù¥ÎØ∏ÏßÄ AI ÏÉùÏÑ±</p></div>
    </div>
  </div>`;
}

function renderAnalyzing() {
  return `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh">
    <div class="spinner-lg"></div>
    <h2 style="font-size:22px;margin-top:24px;margin-bottom:8px">AI Î∂ÑÏÑù ÏßÑÌñâ Ï§ë</h2>
    <p style="color:var(--text-d);margin-bottom:24px">${state.progressMsg}</p>
    <div class="progress-outer"><div class="progress-inner" style="width:${state.progress}%">${state.progress}%</div></div>
  </div>`;
}

function renderPlanning() {
  const a = state.analysis;
  if (!a) return '';
  const ratio = state.referenceRatio;
  return `<div class="fade-in">
    <h1 class="page-title">‚úÖ Î∂ÑÏÑù ÏôÑÎ£å ‚Äî ÏÉùÏÑ± Í≥ÑÌöç</h1>
    <p class="page-desc">AIÍ∞Ä Ï†úÌíàÏùÑ Î∂ÑÏÑùÌñàÏäµÎãàÎã§. Í≤ΩÏüÅÏÇ¨ Ï°∞ÏÇ¨ Ïó¨Î∂ÄÎ•º ÏÑ†ÌÉùÌïòÍ≥† ÏÉùÏÑ±ÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.</p>

    <!-- Î∂ÑÏÑù Í≤∞Í≥º Ïπ¥Îìú -->
    <div class="analysis-box" style="margin-bottom:20px">
      <div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap">
        ${state.imagePreview ? `<img src="${state.imagePreview}" style="width:90px;height:90px;object-fit:cover;border-radius:10px;border:1px solid var(--border);flex-shrink:0">` : ''}
        <div style="flex:1;min-width:200px">
          <h3 style="font-size:20px;font-weight:700">${a.product_name || 'Î∂ÑÏÑùÎêú Ï†úÌíà'}</h3>
          <p style="font-size:13px;color:var(--text-d);margin-top:4px">${a.category||''} ${a.mood?'¬∑ '+a.mood:''} ${a.target_audience?'¬∑ '+a.target_audience:''}</p>
          <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px">${(a.key_features||[]).slice(0,6).map(f=>`<span class="tag">${f}</span>`).join('')}</div>
        </div>
      </div>
    </div>

    <!-- ÏÑπÏÖò ÏÉùÏÑ± Í≥ÑÌöç -->
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:20px">
      <h3 style="font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:6px">
        <span class="material-icons-outlined" style="font-size:18px;color:var(--primary)">dashboard_customize</span>
        ÏÉùÏÑ±Îê† ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Íµ¨ÏÑ± (15ÏÑπÏÖò)
      </h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:6px">
        ${SECTIONS.map((s,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--bg);border-radius:8px;font-size:12px">
          <span class="material-icons-outlined" style="font-size:15px;color:var(--primary)">${s.icon}</span>
          <span style="font-weight:500;color:var(--text-d)">${String(i+1).padStart(2,'0')}. ${s.name}</span>
        </div>`).join('')}
      </div>
      <p style="font-size:12px;color:var(--text-m);margin-top:10px">üí° Í≤ΩÏüÅÏÇ¨ Ï°∞ÏÇ¨ Ïãú AIÍ∞Ä Ï∂îÍ∞Ä ÏÑπÏÖòÏùÑ ÏûêÎèôÏúºÎ°ú Í≤∞Ï†ï¬∑ÏÉùÏÑ±Ìï©ÎãàÎã§.</p>
    </div>

    <!-- Í≤ΩÏüÅÏÇ¨ Ï°∞ÏÇ¨ ÏòµÏÖò -->
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px">
      <h3 style="font-size:14px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px">
        <span class="material-icons-outlined" style="font-size:18px;color:var(--cyan)">travel_explore</span>
        Ïø†Ìå° ¬∑ ÎÑ§Ïù¥Î≤Ñ Ïä§ÎßàÌä∏Ïä§ÌÜ†Ïñ¥ Í≤ΩÏüÅÏÇ¨ Ï°∞ÏÇ¨
      </h3>
      <p style="font-size:13px;color:var(--text-d);margin-bottom:16px">Ïú†ÏÇ¨ Ï†úÌíàÏùÑ Í≤ÄÏÉâ¬∑Ïä§ÌÅ¨ÎûòÌïëÌïòÏó¨ Í≤ΩÏüÅÏÇ¨ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Íµ¨ÏÑ±ÏùÑ Î∂ÑÏÑùÌï©ÎãàÎã§. Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Ï∞∏Ï°∞Ìï¥ Îçî Í≤ΩÏüÅÎ†• ÏûàÎäî ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.</p>

      <!-- Í≤ÄÏ¶ù Î∞©Ïãù -->
      <div style="margin-bottom:14px">
        <p style="font-size:12px;font-weight:600;color:var(--text-m);margin-bottom:8px">Ï†úÌíà Îß§Ïπ≠ Í≤ÄÏ¶ù Î∞©Ïãù</p>
        <div style="display:flex;gap:8px">
          <button id="planVerifyAuto" style="padding:7px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid ${state.verificationMode==='auto'?'var(--primary)':'var(--border)'};background:${state.verificationMode==='auto'?'var(--primary-dim)':'transparent'};color:${state.verificationMode==='auto'?'var(--primary-h)':'var(--text-m)'}">
            <span class="material-icons-outlined" style="font-size:15px;vertical-align:middle">auto_fix_high</span> ÏûêÎèô Îß§Ïπ≠
          </button>
          <button id="planVerifyManual" style="padding:7px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid ${state.verificationMode==='manual'?'var(--cyan)':'var(--border)'};background:${state.verificationMode==='manual'?'rgba(6,182,212,.12)':'transparent'};color:${state.verificationMode==='manual'?'var(--cyan)':'var(--text-m)'}">
            <span class="material-icons-outlined" style="font-size:15px;vertical-align:middle">fact_check</span> ÏßÅÏ†ë ÌôïÏù∏
          </button>
        </div>
        <p style="font-size:12px;color:var(--text-m);margin-top:6px">${state.verificationMode==='auto'?'AIÍ∞Ä Í≤ÄÏÉâÎêú Ï†úÌíà Ï§ë Ïú†ÏÇ¨ Ï†úÌíàÏùÑ ÏûêÎèô ÏÑ†Î≥ÑÌï©ÎãàÎã§.':'Í≤ÄÏÉâÎêú Ï†úÌíà Î™©Î°ùÏùÑ ÏßÅÏ†ë Î≥¥Í≥† Ï∞∏Ï°∞Ìï† Ï†úÌíàÏùÑ ÏÑ†ÌÉùÌï©ÎãàÎã§.'}</p>
      </div>

      <!-- Ï∞∏Ï°∞ ÎπÑÏú® -->
      <div style="margin-bottom:16px">
        <p style="font-size:12px;font-weight:600;color:var(--text-m);margin-bottom:8px">ÏΩòÌÖêÏ∏† Ï∞∏Ï°∞ ÎπÑÏú®</p>
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-size:12px;color:var(--text-m);white-space:nowrap">ÏûêÏ≤¥Î∂ÑÏÑù</span>
          <input type="range" id="planRatioSlider" min="0" max="100" step="10" value="${ratio.competitor}" style="flex:1;accent-color:var(--primary)">
          <span style="font-size:12px;color:var(--text-m);white-space:nowrap">Í≤ΩÏüÅÏÇ¨</span>
        </div>
        <p id="planRatioLabel" style="font-size:13px;font-weight:600;color:var(--primary);text-align:center;margin-top:6px">Í≤ΩÏüÅÏÇ¨ ${ratio.competitor}% / ÏûêÏ≤¥Î∂ÑÏÑù ${ratio.own}%</p>
      </div>
    </div>

    <!-- ÌñâÎèô Î≤ÑÌäº -->
    <div style="display:flex;flex-direction:column;gap:10px">
      <button class="btn-primary" id="startWithSearch" style="padding:16px;font-size:16px">
        <span class="material-icons-outlined" style="font-size:20px">travel_explore</span>
        Í≤ΩÏüÅÏÇ¨ Ï°∞ÏÇ¨ ÌõÑ ÏÉùÏÑ±
      </button>
      <button class="btn-sm" id="startWithoutSearch" style="padding:13px;font-size:14px;justify-content:center">
        <span class="material-icons-outlined" style="font-size:17px">rocket_launch</span>
        Í≤ΩÏüÅÏÇ¨ Ï°∞ÏÇ¨ ÏóÜÏù¥ Î∞îÎ°ú ÏÉùÏÑ±
      </button>
    </div>
  </div>`;
}

function renderSearching() {
  const ss = state.searchStatus;
  const statusIcon = (s) => {
    if (!s || s === 'pending') return '<span class="material-icons-outlined" style="font-size:16px;color:var(--text-m)">hourglass_empty</span>';
    if (s === 'searching') return '<div class="spinner" style="width:16px;height:16px;border-width:2px"></div>';
    if (s.startsWith('ok:')) return `<span class="material-icons-outlined" style="font-size:16px;color:var(--ok)">check_circle</span>`;
    if (s === 'blocked') return '<span class="material-icons-outlined" style="font-size:16px;color:#f59e0b">block</span>';
    if (s === 'ai-sim') return '<span class="material-icons-outlined" style="font-size:16px;color:var(--cyan)">psychology</span>';
    return '<span class="material-icons-outlined" style="font-size:16px;color:#ef4444">error</span>';
  };
  const statusText = (key, s) => {
    if (!s || s === 'pending') return 'ÎåÄÍ∏∞ Ï§ë';
    if (s === 'searching') return 'Í≤ÄÏÉâ Ï§ë...';
    if (s.startsWith('ok:')) return `${s.split(':')[1]}Í∞ú Ï†úÌíà Î∞úÍ≤¨`;
    if (s === 'blocked') return 'Î¥á Ï∞®Îã® ‚Üí AI ÏãúÎÆ¨Î†àÏù¥ÏÖò Ï†ÑÌôò';
    if (s === 'ai-sim') return 'AI ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏôÑÎ£å';
    if (s === 'scraping') return 'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ïä§ÌÅ¨ÎûòÌïë Ï§ë...';
    if (s === 'done') return 'Ïä§ÌÅ¨ÎûòÌïë ÏôÑÎ£å';
    return s;
  };
  return `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh">
    <div class="spinner-lg"></div>
    <h2 style="font-size:22px;margin-top:24px;margin-bottom:8px">Í≤ΩÏüÅÏÇ¨ Ï°∞ÏÇ¨ Ï§ë</h2>
    <p style="color:var(--text-d);margin-bottom:28px">${state.progressMsg||'Ïø†Ìå°¬∑ÎÑ§Ïù¥Î≤ÑÏóêÏÑú Ïú†ÏÇ¨ Ï†úÌíà Í≤ÄÏÉâ Ï§ë...'}</p>
    <div style="width:100%;max-width:420px;display:flex;flex-direction:column;gap:10px">
      ${[
        {key:'coupang', label:'Ïø†Ìå° Í≤ÄÏÉâ', icon:'storefront'},
        {key:'naver', label:'ÎÑ§Ïù¥Î≤Ñ Ïä§ÎßàÌä∏Ïä§ÌÜ†Ïñ¥ Í≤ÄÏÉâ', icon:'shopping_bag'},
        {key:'details', label:'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ïä§ÌÅ¨ÎûòÌïë', icon:'pageview'},
        {key:'ai', label:'AI Î∂ÑÏÑù Î∞è Ïù∏ÏÇ¨Ïù¥Ìä∏ ÏÉùÏÑ±', icon:'psychology'}
      ].map(item=>`
        <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px">
          <span class="material-icons-outlined" style="font-size:20px;color:var(--primary)">${item.icon}</span>
          <span style="flex:1;font-size:13px;font-weight:500">${item.label}</span>
          <div style="display:flex;align-items:center;gap:6px">
            ${statusIcon(ss[item.key])}
            <span style="font-size:12px;color:var(--text-m)">${statusText(item.key, ss[item.key])}</span>
          </div>
        </div>
      `).join('')}
    </div>
  </div>`;
}

function renderVerifying() {
  const prods = state.scrapedProductList || [];
  return `<div class="fade-in">
    <h1 class="page-title">üîç Ïú†ÏÇ¨ Ï†úÌíà ÌôïÏù∏</h1>
    <p class="page-desc">Í≤ÄÏÉâÎêú Ï†úÌíà Ï§ë Ïã§Ï†ú ÎèôÏùº/Ïú†ÏÇ¨ Ï†úÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî. ÏÑ†ÌÉùÌïú Ï†úÌíàÏùò ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Íµ¨ÏÑ±Ïù¥ ÏΩòÌÖêÏ∏†Ïóê Î∞òÏòÅÎê©ÎãàÎã§.</p>

    ${prods.length === 0 ? `<div style="text-align:center;padding:40px;color:var(--text-m)">
      <span class="material-icons-outlined" style="font-size:48px;opacity:.3">search_off</span>
      <p style="margin-top:12px">Ïä§ÌÅ¨ÎûòÌïëÎêú Ï†úÌíàÏù¥ ÏóÜÏäµÎãàÎã§. Î∞îÎ°ú ÏÉùÏÑ±ÏùÑ ÏßÑÌñâÌï©ÎãàÎã§.</p>
    </div>` : `
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:24px">
      ${prods.map((p,i) => `
        <label style="display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border-radius:12px;cursor:pointer;border:2px solid ${(state.verificationResult||[]).includes(i)?'var(--primary)':'var(--border)'};background:${(state.verificationResult||[]).includes(i)?'var(--primary-dim)':'var(--bg-card)'}">
          <input type="checkbox" data-verify-idx="${i}" ${(state.verificationResult||[]).includes(i)?'checked':''} style="margin-top:3px;flex-shrink:0;accent-color:var(--primary);width:16px;height:16px">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
              <span style="font-size:11px;font-weight:700;padding:2px 8px;border-radius:4px;background:${p.platform==='coupang'?'#ef4444':'#22c55e'};color:#fff">${p.platform==='coupang'?'Ïø†Ìå°':'ÎÑ§Ïù¥Î≤Ñ'}</span>
              <span style="font-size:14px;font-weight:600;color:var(--text-d)">${p.name||p.product_name||'Ïù¥Î¶Ñ ÏóÜÏùå'}</span>
            </div>
            ${p.price_range ? `<p style="font-size:12px;color:var(--primary);font-weight:600">${p.price_range}</p>` : ''}
            ${p.detail_page_emphasis ? `<p style="font-size:12px;color:var(--text-m);margin-top:4px">${(p.detail_page_emphasis||[]).slice(0,2).join(' ¬∑ ')}</p>` : ''}
            ${p.url ? `<a href="${p.url}" target="_blank" style="font-size:11px;color:var(--cyan);text-decoration:none;margin-top:4px;display:inline-block">üîó ÏÉÅÌíà ÌéòÏù¥ÏßÄ Î≥¥Í∏∞</a>` : ''}
          </div>
        </label>
      `).join('')}
    </div>`}

    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn-primary" id="confirmVerify" style="flex:1;padding:14px;justify-content:center">
        <span class="material-icons-outlined" style="font-size:18px">check_circle</span>
        ÏÑ†ÌÉù ÏôÑÎ£å ‚Äî ÏÑπÏÖò ÏÑ§Ï†ïÏúºÎ°ú
      </button>
      <button class="btn-sm" id="skipVerify" style="padding:14px 20px">
        Ï†ÑÏ≤¥ Ï∞∏Ï°∞
      </button>
    </div>
  </div>`;
}

function renderSections() {
  const a = state.analysis;
  return `<div class="fade-in">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">
      <div>
        <h1 class="page-title">ÏÑπÏÖòÎ≥Ñ ÏÑ§Ï†ï</h1>
        <p class="page-desc">Í∞Å ÏÑπÏÖòÏóê ÏõêÌïòÎäî ÏßÄÏãúÏÇ¨Ìï≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî. ÎπÑÏõåÎëêÎ©¥ AIÍ∞Ä ÏûêÎèôÏúºÎ°ú ÏµúÏ†ÅÏùò ÏΩòÌÖêÏ∏†Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.</p>
      </div>
      <button class="btn-primary" id="generateAll">
        <span class="material-icons-outlined" style="font-size:20px">rocket_launch</span>
        Ï†ÑÏ≤¥ ÏÉùÏÑ± ÏãúÏûë
      </button>
    </div>

    ${a ? `<div class="analysis-box">
      <div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap">
        ${state.imagePreview ? `<img src="${state.imagePreview}" style="width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid var(--border)">` : ''}
        <div style="flex:1;min-width:200px">
          <h3 style="font-size:18px;font-weight:700">${a.product_name||'Î∂ÑÏÑùÎêú Ï†úÌíà'}</h3>
          <p style="font-size:13px;color:var(--text-d);margin-top:4px">${a.category||''} ${a.mood?'| '+a.mood:''}</p>
          <div style="margin-top:8px">${(a.key_features||[]).slice(0,5).map(f=>`<span class="tag">${f}</span>`).join('')}</div>
        </div>
      </div>
      ${state.competitorData ? `<div style="margin-top:16px;padding:12px 16px;background:var(--bg);border-radius:8px;font-size:13px">
        <span style="color:var(--text-m)">Í≤ΩÏüÅ Î∂ÑÏÑù ÏôÑÎ£å ‚Äî</span>
        <span style="color:#ef4444;font-weight:600;margin-left:4px">Ïø†Ìå° ${state.competitorData.coupang_products?.length||0}Í∞ú</span>
        <span style="color:var(--text-m);margin:0 4px">/</span>
        <span style="color:#22c55e;font-weight:600">ÎÑ§Ïù¥Î≤Ñ ${state.competitorData.naver_products?.length||0}Í∞ú</span>
        ${state.competitorData.recommended_approach ? `<div style="color:var(--text-d);margin-top:6px;font-size:12px">${state.competitorData.recommended_approach}</div>` : ''}
      </div>` : ''}
    </div>` : ''}

    ${state.competitorData ? `
    <!-- Ï†úÌíà Í≤ÄÏ¶ù Ìå®ÎÑê -->
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:12px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <h3 style="font-size:13px;font-weight:700;color:var(--text-d)">Ï†úÌíà Îß§Ïπ≠ Í≤ÄÏ¶ù Î∞©Ïãù</h3>
        <div style="display:flex;gap:6px">
          <button style="padding:5px 12px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid ${state.verificationMode==='auto'?'var(--primary)':'var(--border)'};background:${state.verificationMode==='auto'?'var(--primary-dim)':'transparent'};color:${state.verificationMode==='auto'?'var(--primary-h)':'var(--text-m)'}" id="verifyModeAuto">ÏûêÎèô Îß§Ïπ≠</button>
          <button style="padding:5px 12px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid ${state.verificationMode==='manual'?'var(--cyan)':'var(--border)'};background:${state.verificationMode==='manual'?'rgba(6,182,212,.12)':'transparent'};color:${state.verificationMode==='manual'?'var(--cyan)':'var(--text-m)'}" id="verifyModeManual">ÏàòÎèô ÌôïÏù∏</button>
        </div>
      </div>
      ${state.verificationMode === 'auto'
        ? `<p style="font-size:12px;color:var(--text-m)">AIÍ∞Ä Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Í≤∞Í≥ºÏôÄ Í≤ÄÏÉâÎêú Ïø†Ìå°/ÎÑ§Ïù¥Î≤Ñ Ï†úÌíàÏùÑ ÏûêÎèôÏúºÎ°ú Îß§Ïπ≠ÌïòÏó¨ ÏΩòÌÖêÏ∏† ÏÉùÏÑ±Ïóê Î∞òÏòÅÌï©ÎãàÎã§.</p>`
        : (() => {
            const all = [
              ...(state.competitorData.coupang_products||[]).map(p=>({...p,platform:'Ïø†Ìå°'})),
              ...(state.competitorData.naver_products||[]).map(p=>({...p,platform:'ÎÑ§Ïù¥Î≤Ñ'}))
            ];
            return `<p style="font-size:12px;color:var(--text-d);margin-bottom:8px">Ï∞∏Ï°∞Ìï† Ï†úÌíàÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî (Î≥µÏàò ÏÑ†ÌÉù Í∞ÄÎä•). ÏÑ†ÌÉùÌïú Ï†úÌíàÏùò ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ìå®ÌÑ¥Ïù¥ ÏΩòÌÖêÏ∏†Ïóê Î∞òÏòÅÎê©ÎãàÎã§.</p>
            <div style="display:flex;flex-direction:column;gap:5px;max-height:200px;overflow-y:auto">
              ${all.map((p,i) => `
                <label style="display:flex;align-items:flex-start;gap:8px;padding:7px 10px;border-radius:8px;cursor:pointer;border:1px solid ${(state.verificationResult||[]).includes(i)?'var(--primary)':'var(--border)'};background:${(state.verificationResult||[]).includes(i)?'var(--primary-dim)':'transparent'}">
                  <input type="checkbox" data-verify-idx="${i}" ${(state.verificationResult||[]).includes(i)?'checked':''} style="margin-top:2px;flex-shrink:0">
                  <div>
                    <span style="font-size:10px;padding:1px 6px;border-radius:10px;background:${p.platform==='Ïø†Ìå°'?'rgba(239,68,68,.15)':'rgba(34,197,94,.15)'};color:${p.platform==='Ïø†Ìå°'?'#ef4444':'#22c55e'}">${p.platform}</span>
                    <span style="font-size:13px;font-weight:600;margin-left:5px">${p.name}</span>
                    <div style="font-size:11px;color:var(--text-m);margin-top:2px">${p.price_range||''} ${p.rating?'| ‚≠ê'+p.rating:''} ${p.review_count?'('+p.review_count+')':''}</div>
                  </div>
                </label>`).join('')}
            </div>`;
          })()
      }
    </div>

    <!-- Ï∞∏Ï°∞ ÎπÑÏú® Ïä¨ÎùºÏù¥Îçî -->
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <h3 style="font-size:13px;font-weight:700;color:var(--text-d)">ÏΩòÌÖêÏ∏† Ï∞∏Ï°∞ ÎπÑÏú®</h3>
        <div style="font-size:12px">
          <span style="color:#22c55e;font-weight:700">Í≤ΩÏüÅÏÇ¨ ${state.referenceRatio.competitor}%</span>
          <span style="color:var(--text-m);margin:0 4px">/</span>
          <span style="color:var(--primary-h);font-weight:700">ÏûêÏ≤¥Î∂ÑÏÑù ${state.referenceRatio.own}%</span>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:10px;color:var(--text-m);white-space:nowrap">ÏûêÏ≤¥Î∂ÑÏÑù</span>
        <input type="range" id="ratioSlider" min="0" max="100" step="10" value="${state.referenceRatio.competitor}" style="flex:1;accent-color:#22c55e">
        <span style="font-size:10px;color:var(--text-m);white-space:nowrap">Í≤ΩÏüÅÏÇ¨</span>
      </div>
      <div style="display:flex;height:6px;border-radius:3px;overflow:hidden;margin-top:8px">
        <div style="width:${state.referenceRatio.own}%;background:var(--primary);transition:.3s"></div>
        <div style="width:${state.referenceRatio.competitor}%;background:#22c55e;transition:.3s"></div>
      </div>
      <p style="font-size:11px;color:var(--text-m);margin-top:6px">
        ${state.referenceRatio.competitor >= 70
          ? 'Í≤ΩÏüÅÏÇ¨ ÎπÑÏú®Ïù¥ ÎÜíÏúºÎ©¥ Ïø†Ìå°/ÎÑ§Ïù¥Î≤Ñ ÏÉÅÏúÑ ÌåêÎß§ Ï†úÌíàÏùò Í∞ïÏ°∞ Ìè¨Ïù∏Ìä∏ÏôÄ Î©îÏãúÏßÄÎ•º Ï†ÅÍ∑π Î∞òÏòÅÌï©ÎãàÎã§.'
          : state.referenceRatio.own >= 70
            ? 'ÏûêÏ≤¥Î∂ÑÏÑù ÎπÑÏú®Ïù¥ ÎÜíÏúºÎ©¥ Ïù¥ Ï†úÌíàÎßåÏùò Í≥†Ïú†Ìïú ÌäπÏßïÏùÑ Í∞ïÏ°∞Ìïú Ï∞®Î≥ÑÌôî ÏΩòÌÖêÏ∏†Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.'
            : 'Í≤ΩÏüÅÏÇ¨ Ï∞∏Ï°∞ÏôÄ Ï†úÌíà Í≥†Ïú† Î∂ÑÏÑùÏùÑ Í∑†ÌòïÏûàÍ≤å Î∞òÏòÅÌï©ÎãàÎã§.'}
      </p>
    </div>` : ''}

    <div class="section-grid">
      ${SECTIONS.map(s => `
        <div class="section-card" data-section-toggle="${s.id}">
          <div class="head">
            <span class="icon">${s.icon}</span>
            <div class="info">
              <h4>${s.n}. ${s.name}</h4>
              <p>${s.desc}</p>
            </div>
            <span class="material-icons-outlined" style="color:var(--text-m);font-size:20px">${state.activeSectionEdit===s.id?'expand_less':'expand_more'}</span>
          </div>
          ${state.activeSectionEdit===s.id ? `<div style="margin-top:12px" onclick="event.stopPropagation()">
            <textarea class="textarea" data-section-input="${s.id}" rows="3" placeholder="Ïù¥ ÏÑπÏÖòÏóê ÏõêÌïòÎäî ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...\nÏòà: ${s.purpose}">${state.sectionInstructions[s.id]||''}</textarea>
          </div>` : ''}
          ${state.sectionInstructions[s.id] && state.activeSectionEdit!==s.id ? `<div class="custom-badge">‚úé Ïª§Ïä§ÌÖÄ ÏßÄÏãúÏÇ¨Ìï≠ ÏûÖÎ†•Îê®</div>` : ''}
        </div>
      `).join('')}
    </div>

    <div style="text-align:center;margin-top:32px;display:flex;flex-direction:column;align-items:center;gap:12px">
      <button class="btn-primary" id="generateAll2" style="padding:16px 48px;font-size:16px">
        <span class="material-icons-outlined" style="font-size:22px">rocket_launch</span>
        15Í∞ú ÏÑπÏÖò ÏùºÍ¥Ñ ÏÉùÏÑ± ÏãúÏûë
      </button>
      ${Object.keys(state.sectionContents).length > 0 ? `
      <button class="btn-sm" id="generateExtra" style="padding:10px 24px;font-size:13px;border-color:var(--cyan);color:var(--cyan)">
        <span class="material-icons-outlined" style="font-size:16px">add_circle</span>
        Í≤ΩÏüÅÏÇ¨ Î∂ÑÏÑù Í∏∞Î∞ò Ï∂îÍ∞Ä ÏÑπÏÖò ÏûêÎèô ÏÉùÏÑ±
        ${state.extraSections.length > 0 ? `(${state.extraSections.length}Í∞ú ÏôÑÎ£å)` : ''}
      </button>` : ''}
    </div>
  </div>`;
}

function renderGenerating() {
  const icons = SECTIONS.map(s=>s.icon);
  const doneCount = Object.keys(state.sectionContents).length;
  return `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh">
    <div class="spinner-lg"></div>
    <h2 style="font-size:24px;margin-top:32px;margin-bottom:8px">ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÉùÏÑ± Ï§ë</h2>
    <p style="color:var(--text-d);margin-bottom:24px;text-align:center">${state.progressMsg}</p>
    <div class="progress-outer"><div class="progress-inner" style="width:${state.progress}%">${state.progress}%</div></div>
    <p style="font-size:12px;color:var(--text-m);margin-top:16px">15Í∞ú ÏÑπÏÖò √ó (ÏΩòÌÖêÏ∏† + Ïù¥ÎØ∏ÏßÄ) ÏÉùÏÑ± Ï§ë ‚Äî Gemini API Ìò∏Ï∂ú</p>
    <div class="gen-icons">
      ${icons.map((ic,i) => `<div class="gen-icon ${i<doneCount?'done':''}">${ic}</div>`).join('')}
    </div>
  </div>`;
}

function renderPreview() {
  return `<div class="fade-in">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">
      <div>
        <h1 class="page-title">ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞</h1>
        <p class="page-desc">ÏÉùÏÑ±Îêú ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ•º ÌôïÏù∏ÌïòÍ≥† Í∞úÎ≥Ñ ÏÑπÏÖòÏùÑ ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-primary" id="exportHTML">
          <span class="material-icons-outlined" style="font-size:18px">download</span>
          HTML ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        </button>
      </div>
    </div>

    <div class="preview-wrap">
      ${SECTIONS.map(s => {
        const content = state.sectionContents[s.id];
        if (!content) return `<div style="padding:20px;text-align:center;color:var(--text-m);border-bottom:1px solid var(--border)">
          <span>${s.icon} ${s.n}. ${s.name} - ÎØ∏ÏÉùÏÑ±</span>
        </div>`;

        const c = content.color_scheme || {};
        const f = content.font_suggestion || {};
        const img = state.sectionImages[s.id];
        const isEditing = state.editingPreviewSection === s.id;

        return `
          <div style="position:relative">
            <div class="section-ctrl">
              <span style="font-size:16px">${s.icon}</span>
              <span class="name">${s.n}. ${s.name}</span>
              <div style="flex:1"></div>
              <button class="btn-sm" data-edit-preview="${s.id}">
                <span class="material-icons-outlined" style="font-size:16px">edit</span> ÏàòÏ†ï
              </button>
              <button class="btn-sm" data-regen="${s.id}">
                <span class="material-icons-outlined" style="font-size:16px">refresh</span> Ïû¨ÏÉùÏÑ±
              </button>
            </div>
            ${isEditing ? `<div class="edit-panel" onclick="event.stopPropagation()">
              <textarea class="textarea" data-edit-input="${s.id}" rows="2" placeholder="Ïù¥ ÏÑπÏÖòÏóê ÎåÄÌïú ÏàòÏ†ï ÏßÄÏãúÏÇ¨Ìï≠...">${state.sectionInstructions[s.id]||''}</textarea>
              <button class="btn-sm" style="margin-top:8px" data-apply-edit="${s.id}">ÏßÄÏãúÏÇ¨Ìï≠ Ï†ÅÏö© ÌõÑ Ïû¨ÏÉùÏÑ±</button>
            </div>` : ''}
            <div style="background:${c.background||'#FFFFFF'};padding:48px 20px;text-align:center">
              <div style="max-width:860px;margin:0 auto">
                <h2 style="font-size:${f.headline_size||'36px'};color:${c.text_primary||'#333'};font-weight:${f.headline_weight||'700'};margin-bottom:10px">
                  ${content.headline || `[${s.name}]`}
                </h2>
                <h3 style="font-size:18px;color:${c.text_secondary||'#666'};font-weight:400;margin-bottom:20px">
                  ${content.subheadline || ''}
                </h3>
                ${img ? `<img src="${img}" alt="${s.name}" style="max-width:100%;border-radius:12px;margin-bottom:20px">` : ''}
                <p style="font-size:${f.body_size||'16px'};color:${c.text_secondary||'#666'};line-height:1.8;max-width:680px;margin:0 auto">
                  ${content.body_text || ''}
                </p>
                ${content.extra_elements?.length ? `<div style="margin-top:20px;text-align:left;max-width:600px;margin-left:auto;margin-right:auto">
                  ${content.extra_elements.map(e => `<div style="padding:8px 0;color:${c.text_secondary||'#555'};font-size:14px;border-bottom:1px solid rgba(0,0,0,.05)">‚Ä¢ ${e}</div>`).join('')}
                </div>` : ''}
                ${content.cta_text ? `<div style="display:inline-block;margin-top:20px;padding:12px 36px;background:${c.accent||'#6366f1'};color:#fff;border-radius:8px;font-weight:600;font-size:16px">${content.cta_text}</div>` : ''}
              </div>
            </div>
          </div>`;
      }).join('')}

      ${state.extraSections.length > 0 ? `
        <div style="padding:14px 20px;background:linear-gradient(135deg,rgba(99,102,241,.12),rgba(6,182,212,.08));border-top:2px solid var(--primary);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
          <span style="font-size:16px">‚ú®</span>
          <span style="font-size:13px;font-weight:700;color:var(--primary-h)">AI Ï∂îÍ∞Ä ÏÑπÏÖò (Í≤ΩÏüÅÏÇ¨ Î∂ÑÏÑù Í∏∞Î∞ò)</span>
          <span style="font-size:11px;padding:2px 8px;border-radius:10px;background:var(--primary-dim);color:var(--primary-h)">${state.extraSections.length}Í∞ú</span>
        </div>
        ${state.extraSections.map(s => {
          const content = state.extraSectionContents[s.id];
          if (!content) return '';
          const c = content.color_scheme || {};
          const f = content.font_suggestion || {};
          const img = state.extraSectionImages[s.id];
          return `
            <div style="position:relative">
              <div class="section-ctrl" style="background:rgba(99,102,241,.05)">
                <span style="font-size:16px">${s.icon}</span>
                <span class="name">${s.name}</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:10px;background:var(--primary-dim);color:var(--primary-h);margin-left:4px">AI Ï∂îÍ∞Ä</span>
                <div style="flex:1"></div>
              </div>
              <div style="background:${c.background||'#FFFFFF'};padding:48px 20px;text-align:center">
                <div style="max-width:860px;margin:0 auto">
                  <h2 style="font-size:${f.headline_size||'36px'};color:${c.text_primary||'#333'};font-weight:${f.headline_weight||'700'};margin-bottom:10px">
                    ${content.headline || `[${s.name}]`}
                  </h2>
                  <h3 style="font-size:18px;color:${c.text_secondary||'#666'};font-weight:400;margin-bottom:20px">
                    ${content.subheadline || ''}
                  </h3>
                  ${img ? `<img src="${img}" alt="${s.name}" style="max-width:100%;border-radius:12px;margin-bottom:20px">` : ''}
                  <p style="font-size:${f.body_size||'16px'};color:${c.text_secondary||'#666'};line-height:1.8;max-width:680px;margin:0 auto">
                    ${content.body_text || ''}
                  </p>
                  ${content.extra_elements?.length ? `<div style="margin-top:20px;text-align:left;max-width:600px;margin-left:auto;margin-right:auto">
                    ${content.extra_elements.map(e => `<div style="padding:8px 0;color:${c.text_secondary||'#555'};font-size:14px;border-bottom:1px solid rgba(0,0,0,.05)">‚Ä¢ ${e}</div>`).join('')}
                  </div>` : ''}
                  ${content.cta_text ? `<div style="display:inline-block;margin-top:20px;padding:12px 36px;background:${c.accent||'#6366f1'};color:#fff;border-radius:8px;font-weight:600;font-size:16px">${content.cta_text}</div>` : ''}
                </div>
              </div>
            </div>`;
        }).join('')}
      ` : ''}
    </div>

    ${Object.keys(state.sectionContents).length > 0 && !state.extraSections.length ? `
    <div style="text-align:center;margin-top:20px">
      <button class="btn-sm" id="generateExtraFromPreview" style="padding:10px 24px;font-size:13px;border-color:var(--cyan);color:var(--cyan)">
        <span class="material-icons-outlined" style="font-size:16px">add_circle</span>
        Í≤ΩÏüÅÏÇ¨ Î∂ÑÏÑù Í∏∞Î∞ò Ï∂îÍ∞Ä ÏÑπÏÖò ÏÉùÏÑ±
      </button>
    </div>` : ''}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENT BINDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bindEvents() {
  // API Key modal
  const saveBtn = document.getElementById('saveApiKey');
  if (saveBtn) {
    saveBtn.onclick = () => {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (!key) return;
      state.apiKey = key;
      saveKey(key);
      gemini = new GeminiAPI(key);
      state.showApiModal = false;
      render();
    };
  }

  const skipBtn = document.getElementById('skipApiModal');
  if (skipBtn) {
    skipBtn.onclick = () => {
      gemini = new GeminiAPI(state.apiKey);
      state.showApiModal = false;
      render();
    };
  }

  const toggleVis = document.getElementById('toggleKeyVis');
  if (toggleVis) {
    toggleVis.onclick = () => {
      const inp = document.getElementById('apiKeyInput');
      if (inp.type === 'text') { inp.type = 'password'; toggleVis.textContent = 'visibility'; }
      else { inp.type = 'text'; toggleVis.textContent = 'visibility_off'; }
    };
  }

  const changeApiBtn = document.getElementById('changeApiKey');
  if (changeApiBtn) {
    changeApiBtn.onclick = () => { state.showApiModal = true; render(); };
  }

  // Navigation
  document.querySelectorAll('[data-nav]').forEach(btn => {
    btn.onclick = () => {
      if (btn.classList.contains('disabled')) return;
      const target = btn.dataset.nav;
      if (target === 'preview' && Object.keys(state.sectionContents).length === 0) return;
      state.step = target;
      render();
    };
  });

  // Error close
  const closeErr = document.getElementById('closeError');
  if (closeErr) closeErr.onclick = () => { state.error = ''; render(); };

  // File upload
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  if (uploadArea) {
    uploadArea.onclick = () => fileInput.click();
    uploadArea.ondragover = (e) => e.preventDefault();
    uploadArea.ondrop = (e) => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) handleFile(file);
    };
  }
  if (fileInput) {
    fileInput.onchange = (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); };
  }

  // Product name
  const nameInput = document.getElementById('productNameInput');
  if (nameInput) nameInput.oninput = (e) => { state.productName = e.target.value; };

  // Start analysis
  const startBtn = document.getElementById('startAnalysis');
  if (startBtn) startBtn.onclick = startAnalysis;

  // Generate all
  const genAll = document.getElementById('generateAll');
  const genAll2 = document.getElementById('generateAll2');
  if (genAll) genAll.onclick = generateAllSections;
  if (genAll2) genAll2.onclick = generateAllSections;

  // Section toggles
  document.querySelectorAll('[data-section-toggle]').forEach(el => {
    el.onclick = () => {
      const id = el.dataset.sectionToggle;
      state.activeSectionEdit = state.activeSectionEdit === id ? null : id;
      render();
    };
  });

  // Section instruction inputs
  document.querySelectorAll('[data-section-input]').forEach(el => {
    el.oninput = (e) => { state.sectionInstructions[el.dataset.sectionInput] = e.target.value; saveSectionInstructions(state.sectionInstructions); };
    el.onclick = (e) => e.stopPropagation();
  });

  // Preview edit
  document.querySelectorAll('[data-edit-preview]').forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.editPreview;
      state.editingPreviewSection = state.editingPreviewSection === id ? null : id;
      render();
    };
  });

  // Regenerate section
  document.querySelectorAll('[data-regen]').forEach(btn => {
    btn.onclick = () => regenerateSection(btn.dataset.regen);
  });

  // Apply edit
  document.querySelectorAll('[data-apply-edit]').forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.applyEdit;
      const textarea = document.querySelector(`[data-edit-input="${id}"]`);
      if (textarea) state.sectionInstructions[id] = textarea.value;
      saveSectionInstructions(state.sectionInstructions);
      state.editingPreviewSection = null;
      regenerateSection(id);
    };
  });

  // Edit input
  document.querySelectorAll('[data-edit-input]').forEach(el => {
    el.oninput = (e) => { state.sectionInstructions[el.dataset.editInput] = e.target.value; saveSectionInstructions(state.sectionInstructions); };
  });

  // Export
  const exportBtn = document.getElementById('exportHTML');
  if (exportBtn) exportBtn.onclick = exportHTML;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleFile(file) {
  state.imageMime = file.type;
  const reader = new FileReader();
  reader.onload = (e) => {
    state.imagePreview = e.target.result;
    state.imageBase64 = e.target.result.split(',')[1];
    render();
  };
  reader.readAsDataURL(file);
}

async function startAnalysis() {
  if (!state.imageBase64) { state.error = 'Ï†úÌíà Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.'; render(); return; }

  let llm;
  try { llm = getLLMClient(); } catch(e) {
    if (state.modelConfig.llmProvider === 'openai') { state.error = e.message; render(); return; }
    state.showApiModal = true; render(); return;
  }

  state.error = '';
  state.step = 'analyzing';
  state.progress = 10;
  state.progressMsg = 'Ï†úÌíà Ïù¥ÎØ∏ÏßÄ AI Î∂ÑÏÑù Ï§ë...';
  render();

  try {
    // 1. Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑùÎßå ÏàòÌñâ (Í≤ΩÏüÅÏÇ¨ Í≤ÄÏÉâÏùÄ planningÏóêÏÑú ÏÇ¨Ïö©ÏûêÍ∞Ä Í≤∞Ï†ï)
    const analysis = await llm.analyzeImage(state.imageBase64, state.imageMime);
    if (state.productName) analysis.product_name = state.productName;
    state.analysis = analysis;
    state.competitorData = null;
    state.scrapedProductList = [];
    state.verificationResult = [];
    state.extraSections = [];
    state.extraSectionContents = {};
    state.extraSectionImages = {};

    state.progress = 100;
    state.progressMsg = 'Î∂ÑÏÑù ÏôÑÎ£å!';
    state.step = 'planning';
    render();
  } catch (e) {
    state.error = `Î∂ÑÏÑù Ïã§Ìå®: ${e.message}`;
    state.step = 'upload';
    render();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCRAPING UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function fetchWithProxy(url) {
  const proxies = [
    () => fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, { signal: AbortSignal.timeout(12000) })
      .then(r => r.json()).then(d => d.contents),
    () => fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, { signal: AbortSignal.timeout(12000) })
      .then(r => r.ok ? r.text() : null),
  ];
  for (const fn of proxies) {
    try {
      const html = await fn();
      if (html && html.length > 500) return html;
    } catch(e) { /* try next */ }
  }
  return null;
}

function cleanHtml(html) {
  return html
    .replace(/<script[\s\S]*?<\/script>/gi, '')
    .replace(/<style[\s\S]*?<\/style>/gi, '')
    .replace(/<!--[\s\S]*?-->/g, '')
    .replace(/<[^>]+>/g, ' ')
    .replace(/&nbsp;/g, ' ')
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/\s{2,}/g, ' ')
    .trim();
}

function parseCoupangHTML(html) {
  const products = [];
  // Coupang product links pattern
  const patterns = [
    /href="(\/vp\/products\/\d+[^"]*)"[^>]*>[\s\S]{0,500}?class="[^"]*name[^"]*"[^>]*>([\s\S]{0,200}?)<\//gi,
    /"productId":(\d+),"productName":"([^"]{5,100})"/gi,
  ];
  const seen = new Set();
  for (const re of patterns) {
    let m;
    while ((m = re.exec(html)) !== null && products.length < 5) {
      const rawName = m[2].replace(/<[^>]+>/g, '').trim();
      const name = rawName.substring(0, 80);
      const url = m[1].startsWith('/') ? 'https://www.coupang.com' + m[1].split('?')[0] : null;
      if (name && name.length >= 5 && !seen.has(name)) {
        seen.add(name);
        products.push({ name, url, platform: 'coupang', price_range: '', detail_page_emphasis: [], key_selling_messages: [] });
      }
    }
  }
  // fallback: extract any product-like names from text
  if (products.length < 2) {
    const text = cleanHtml(html);
    const lines = text.split(/[|\n,]/).map(l=>l.trim()).filter(l=>l.length>8 && l.length<80);
    for (const line of lines.slice(0,5)) {
      if (!seen.has(line)) {
        seen.add(line);
        products.push({ name: line, url: null, platform: 'coupang', price_range: '', detail_page_emphasis: [], key_selling_messages: [] });
      }
      if (products.length >= 5) break;
    }
  }
  return products;
}

function parseNaverHTML(html) {
  const products = [];
  const seen = new Set();
  // Naver product data patterns
  const patterns = [
    /"productName":"([^"]{5,100})","mallName":"([^"]{1,50})","price":(\d+)/gi,
    /"title":"([^"]{5,100})","link":"(https:\/\/[^"]+)"/gi,
  ];
  for (const re of patterns) {
    let m;
    while ((m = re.exec(html)) !== null && products.length < 5) {
      const name = m[1].trim().substring(0, 80);
      const url = m[2] || null;
      const price = m[3] ? parseInt(m[3]).toLocaleString() + 'Ïõê' : '';
      if (name && !seen.has(name)) {
        seen.add(name);
        products.push({ name, url, platform: 'naver', price_range: price, detail_page_emphasis: [], key_selling_messages: [] });
      }
    }
  }
  return products;
}

async function scrapeDetailText(url) {
  if (!url) return '';
  try {
    const html = await fetchWithProxy(url);
    if (!html) return '';
    return cleanHtml(html).substring(0, 1500);
  } catch(e) { return ''; }
}

async function searchCompetitors() {
  state.step = 'searching';
  state.searchStatus = { coupang: 'pending', naver: 'pending', details: 'pending', ai: 'pending' };
  state.progressMsg = 'Ïø†Ìå° ¬∑ ÎÑ§Ïù¥Î≤ÑÏóêÏÑú Ïú†ÏÇ¨ Ï†úÌíà Í≤ÄÏÉâ Ï§ë...';
  render();

  const query = state.analysis.product_name || state.productName || '';
  let coupangProds = [];
  let naverProds = [];

  // ‚îÄ‚îÄ Ïø†Ìå° Í≤ÄÏÉâ ‚îÄ‚îÄ
  state.searchStatus.coupang = 'searching';
  render();
  try {
    const html = await fetchWithProxy(`https://www.coupang.com/np/search?q=${encodeURIComponent(query)}&listSize=36`);
    if (html && !html.toLowerCase().includes('captcha') && html.length > 1000) {
      coupangProds = parseCoupangHTML(html);
      state.searchStatus.coupang = `ok:${coupangProds.length}`;
    } else {
      state.searchStatus.coupang = 'blocked';
    }
  } catch(e) { state.searchStatus.coupang = 'blocked'; }
  render();

  // ‚îÄ‚îÄ ÎÑ§Ïù¥Î≤Ñ Í≤ÄÏÉâ ‚îÄ‚îÄ
  state.searchStatus.naver = 'searching';
  render();
  try {
    const html = await fetchWithProxy(`https://search.shopping.naver.com/search/all?query=${encodeURIComponent(query)}`);
    if (html && !html.toLowerCase().includes('captcha') && html.length > 1000) {
      naverProds = parseNaverHTML(html);
      state.searchStatus.naver = `ok:${naverProds.length}`;
    } else {
      state.searchStatus.naver = 'blocked';
    }
  } catch(e) { state.searchStatus.naver = 'blocked'; }
  render();

  // ‚îÄ‚îÄ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ïä§ÌÅ¨ÎûòÌïë ‚îÄ‚îÄ
  state.searchStatus.details = 'scraping';
  state.progressMsg = 'Í∞Å Ï†úÌíà ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Ïä§ÌÅ¨ÎûòÌïë Ï§ë...';
  render();
  const allFound = [...coupangProds, ...naverProds];
  for (const p of allFound.slice(0, 6)) {
    if (p.url) {
      const txt = await scrapeDetailText(p.url);
      if (txt) p.scraped_text = txt;
    }
  }
  state.searchStatus.details = 'done';

  // ‚îÄ‚îÄ AI Î∂ÑÏÑù ‚îÄ‚îÄ
  state.searchStatus.ai = 'searching';
  state.progressMsg = 'AIÍ∞Ä Í≤ΩÏüÅÏÇ¨ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...';
  render();
  try {
    const llm = getLLMClient();
    if (allFound.length >= 2) {
      // Ïä§ÌÅ¨ÎûòÌïë ÏÑ±Í≥µ Ïãú AIÎ°ú enrichment
      const enriched = await llm.searchSimilarProducts(query, state.analysis.category, JSON.stringify(allFound.slice(0,6)));
      // Ïä§ÌÅ¨ÎûòÌïë Í≤∞Í≥ºÏôÄ AI Î∂ÑÏÑù Í≤∞Ìï©
      state.competitorData = {
        ...enriched,
        coupang_products: coupangProds.length > 0 ? coupangProds : enriched.coupang_products,
        naver_products: naverProds.length > 0 ? naverProds : enriched.naver_products,
        scraped: allFound.length > 0,
      };
    } else {
      // Ïä§ÌÅ¨ÎûòÌïë Ïã§Ìå® ‚Üí ÏôÑÏ†Ñ AI ÏãúÎÆ¨Î†àÏù¥ÏÖò
      const competitors = await llm.searchSimilarProducts(query, state.analysis.category, null);
      state.competitorData = competitors;
      state.searchStatus.coupang = 'ai-sim';
      state.searchStatus.naver = 'ai-sim';
    }
    state.searchStatus.ai = 'done';
  } catch(e) {
    state.searchStatus.ai = 'failed';
  }

  // Ïä§ÌÅ¨ÎûòÌïë Í≤∞Í≥ºÎ•º scrapedProductListÏóêÎèÑ Ï†ÄÏû• (verifying ÌôîÎ©¥Ïö©)
  const cd = state.competitorData;
  state.scrapedProductList = [
    ...(cd?.coupang_products||[]).map(p=>({...p, platform:'coupang'})),
    ...(cd?.naver_products||[]).map(p=>({...p, platform:'naver'})),
  ];

  render();
  await new Promise(r => setTimeout(r, 600)); // ÏôÑÎ£å ÏÉÅÌÉú Ïû†Íπê ÌëúÏãú

  if (state.verificationMode === 'manual' && state.scrapedProductList.length > 0) {
    state.step = 'verifying';
  } else {
    state.step = 'sections';
  }
  render();
}

function buildCompRef() {
  if (!state.competitorData) return '';
  if (state.verificationMode === 'manual' && state.verificationResult?.length > 0) {
    const cd = state.competitorData;
    const all = [
      ...(cd.coupang_products||[]).map(p=>({...p, platform:'Ïø†Ìå°'})),
      ...(cd.naver_products||[]).map(p=>({...p, platform:'ÎÑ§Ïù¥Î≤Ñ'}))
    ];
    const selected = state.verificationResult.map(i=>all[i]).filter(Boolean);
    return JSON.stringify({...cd, selected_references: selected}).substring(0, 2500);
  }
  return JSON.stringify(state.competitorData).substring(0, 2500);
}

async function generateAllSections() {
  state.step = 'generating';
  state.progress = 35;
  state.sectionContents = {};
  state.sectionImages = {};
  render();

  let llm;
  try { llm = getLLMClient(); } catch(e) { state.error = e.message; state.step = 'sections'; render(); return; }
  // gemini Ïù∏Ïä§ÌÑ¥Ïä§ÎèÑ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïö©ÏúºÎ°ú Ïú†ÏßÄ
  const geminiForImage = new GeminiAPI(state.apiKey);

  const total = SECTIONS.length;
  const compRef = buildCompRef();

  for (let i = 0; i < total; i++) {
    const s = SECTIONS[i];
    const pct = Math.round(35 + ((i / total) * 60));
    state.progress = pct;
    state.progressMsg = `[${i+1}/${total}] ${s.name} ÏΩòÌÖêÏ∏† ÏÉùÏÑ± Ï§ë...`;
    render();

    try {
      // Generate content via selected LLM
      const content = await llm.generateSectionContent(
        s, state.analysis, state.sectionInstructions[s.id] || '', compRef, state.referenceRatio
      );
      state.sectionContents[s.id] = content;

      // Try to generate image (Ìï≠ÏÉÅ Gemini Ïù¥ÎØ∏ÏßÄ Î™®Îç∏ ÏÇ¨Ïö©)
      if (state.apiKey) {
        state.progressMsg = `[${i+1}/${total}] ${s.name} Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...`;
        render();
        try {
          const imgPrompt = content.image_description || content.design_notes || s.purpose;
          const img = await geminiForImage.generateImage(imgPrompt, state.imageBase64, state.imageMime);
          if (img) state.sectionImages[s.id] = img;
        } catch (e) {
          console.warn(`Image gen failed for ${s.id}:`, e);
        }
      }

    } catch (e) {
      console.error(`Section ${s.id} failed:`, e);
      state.sectionContents[s.id] = {
        headline: s.name,
        subheadline: 'ÏÉùÏÑ± Ïã§Ìå® - Ïû¨ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî',
        body_text: e.message,
        color_scheme: { background: '#FFF5F5', text_primary: '#C53030', text_secondary: '#E53E3E', accent: '#FC8181' },
        font_suggestion: { headline_size: '32px', body_size: '14px' }
      };
    }

    // Small delay for rate limiting
    await new Promise(r => setTimeout(r, 500));
  }

  state.progress = 100;
  state.progressMsg = 'Î™®Îì† ÏÑπÏÖò ÏÉùÏÑ± ÏôÑÎ£å!';
  state.step = 'preview';
  render();
}

async function regenerateSection(sectionId) {
  const s = SECTIONS.find(x => x.id === sectionId);
  if (!s) return;

  state.progressMsg = `${s.name} Ïû¨ÏÉùÏÑ± Ï§ë...`;
  const compRef = buildCompRef();

  let llm;
  try { llm = getLLMClient(); } catch(e) { state.error = e.message; render(); return; }

  try {
    const content = await llm.generateSectionContent(
      s, state.analysis, state.sectionInstructions[sectionId] || '', compRef, state.referenceRatio
    );
    state.sectionContents[sectionId] = content;

    if (state.apiKey) {
      try {
        const geminiForImage = new GeminiAPI(state.apiKey);
        const imgPrompt = content.image_description || content.design_notes || s.purpose;
        const img = await geminiForImage.generateImage(imgPrompt, state.imageBase64, state.imageMime);
        if (img) state.sectionImages[sectionId] = img;
      } catch (e) {}
    }

    render();
  } catch (e) {
    state.error = `Ïû¨ÏÉùÏÑ± Ïã§Ìå®: ${e.message}`;
    render();
  }
}

async function generateExtraSections() {
  if (!state.analysis || !state.competitorData) {
    state.error = 'Î®ºÏ†Ä Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑùÍ≥º Í≤ΩÏüÅÏÇ¨ Í≤ÄÏÉâÏùÑ ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî.';
    render(); return;
  }
  let llm;
  try { llm = getLLMClient(); } catch(e) { state.error = e.message; render(); return; }
  const geminiForImage = new GeminiAPI(state.apiKey);

  state.step = 'generating';
  state.progress = 0;
  state.progressMsg = 'Í≤ΩÏüÅÏÇ¨ Î∂ÑÏÑù Í∏∞Î∞ò Ï∂îÍ∞Ä ÏÑπÏÖò Í≤∞Ï†ï Ï§ë...';
  render();

  let suggestions;
  try {
    suggestions = await llm.generateExtraSectionSuggestions(
      state.analysis, state.competitorData, SECTIONS.map(s => s.id)
    );
    if (!Array.isArray(suggestions)) suggestions = [];
  } catch(e) {
    state.error = `Ï∂îÍ∞Ä ÏÑπÏÖò Í≤∞Ï†ï Ïã§Ìå®: ${e.message}`;
    state.step = 'preview'; render(); return;
  }

  state.extraSections = suggestions;
  state.extraSectionContents = {};
  state.extraSectionImages = {};

  for (let i = 0; i < suggestions.length; i++) {
    const s = suggestions[i];
    const pct = Math.round(((i / suggestions.length) * 80));
    state.progress = pct;
    state.progressMsg = `Ï∂îÍ∞Ä ÏÑπÏÖò [${i+1}/${suggestions.length}] ${s.name} ÏÉùÏÑ± Ï§ë...`;
    render();
    try {
      const content = await llm.generateSectionContent(
        s, state.analysis, '', buildCompRef(), state.referenceRatio
      );
      state.extraSectionContents[s.id] = content;
      if (state.apiKey) {
        try {
          const imgPrompt = content.image_description || content.design_notes || s.purpose;
          const img = await geminiForImage.generateImage(imgPrompt, state.imageBase64, state.imageMime);
          if (img) state.extraSectionImages[s.id] = img;
        } catch(e) {}
      }
    } catch(e) {
      console.warn(`Extra section ${s.id} failed:`, e);
    }
    await new Promise(r => setTimeout(r, 500));
  }

  state.progress = 100;
  state.progressMsg = `Ï∂îÍ∞Ä ÏÑπÏÖò ${suggestions.length}Í∞ú ÏÉùÏÑ± ÏôÑÎ£å!`;
  state.step = 'preview';
  render();
}

function exportHTML() {
  const product = state.analysis || {};
  let sectionsHtml = '';

  for (const s of SECTIONS) {
    const content = state.sectionContents[s.id];
    if (!content) continue;
    const c = content.color_scheme || {};
    const f = content.font_suggestion || {};
    const img = state.sectionImages[s.id];

    sectionsHtml += `
    <section style="background:${c.background||'#FFFFFF'};padding:60px 20px;text-align:center;">
      <div style="max-width:860px;margin:0 auto;">
        <h2 style="font-size:${f.headline_size||'36px'};color:${c.text_primary||'#333'};margin-bottom:12px;font-weight:${f.headline_weight||'700'};">
          ${content.headline||''}
        </h2>
        <h3 style="font-size:20px;color:${c.text_secondary||'#666'};margin-bottom:24px;font-weight:400;">
          ${content.subheadline||''}
        </h3>
        ${img ? `<img src="${img}" alt="${s.name}" style="max-width:100%;border-radius:12px;margin:20px 0;">` : ''}
        <p style="font-size:${f.body_size||'16px'};color:${c.text_secondary||'#666'};line-height:1.8;max-width:680px;margin:0 auto;">
          ${content.body_text||''}
        </p>
        ${content.extra_elements?.length ? `<div style="margin-top:20px;text-align:left;max-width:600px;margin:0 auto;">
          ${content.extra_elements.map(e=>`<div style="padding:8px 0;color:${c.text_secondary||'#555'};font-size:14px;border-bottom:1px solid rgba(0,0,0,.05);">‚Ä¢ ${e}</div>`).join('')}
        </div>` : ''}
        ${content.cta_text ? `<a href="#" style="display:inline-block;margin-top:24px;padding:14px 40px;background:${c.accent||'#6366f1'};color:#fff;border-radius:8px;text-decoration:none;font-size:18px;font-weight:600;">${content.cta_text}</a>` : ''}
      </div>
    </section>`;
  }

  const html = `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${product.product_name||'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ'}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans KR',sans-serif;color:#333}
        img{max-width:100%;height:auto}
        section{width:100%}
    </style>
</head>
<body>${sectionsHtml}</body>
</html>`;

  const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${product.product_name||'detail-page'}_ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ.html`;
  a.click();
  URL.revokeObjectURL(url);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE DRIVE SERVICE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DRIVE_API = 'https://www.googleapis.com/drive/v3';
const GD_CLIENT_ID = localStorage.getItem('gd_client_id') || '';

// URLÏù¥Îì† IDÎßåÏù¥Îì† Ìè¥Îçî IDÎ•º Ï∂îÏ∂ú
function extractFolderId(input) {
  if (!input) return '';
  input = input.trim();
  // https://drive.google.com/drive/folders/XXXXX?usp=... ÌòïÌÉú
  const m1 = input.match(/folders\/([a-zA-Z0-9_-]+)/);
  if (m1) return m1[1];
  // https://drive.google.com/drive/u/0/folders/XXXXX ÌòïÌÉú
  const m2 = input.match(/drive[^"]*folders\/([a-zA-Z0-9_-]+)/);
  if (m2) return m2[1];
  // Ïù¥ÎØ∏ ÏàúÏàò ID (Í≥µÎ∞±, Ïä¨ÎûòÏãú ÏóÜÏùå)
  if (/^[a-zA-Z0-9_-]+$/.test(input)) return input;
  return input;
}

class DriveService {
  constructor(token) {
    this.token = token;
    this.tokenExpiresAt = Date.now() + 3500 * 1000; // ~58Î∂Ñ ÌõÑ ÎßåÎ£å ÏòàÏÉÅ
  }
  headers() { return { 'Authorization': `Bearer ${this.token}` }; }

  // ÌÜ†ÌÅ∞ ÎßåÎ£å Ï≤¥ÌÅ¨ ÌõÑ ÏûêÎèô Í∞±Ïã†
  async ensureToken() {
    if (Date.now() > this.tokenExpiresAt) {
      autoLog('info', 'ÌÜ†ÌÅ∞ ÎßåÎ£åÎê® ‚Äî ÏûêÎèô Í∞±Ïã† Ï§ë...');
      await refreshDriveToken();
    }
  }

  // 401 ÏóêÎü¨ Ïãú ÌÜ†ÌÅ∞ Í∞±Ïã† ÌõÑ Ïû¨ÏãúÎèÑÌïòÎäî ÎûòÌçº
  async fetchWithRetry(url, options = {}) {
    await this.ensureToken();
    let res = await fetch(url, { ...options, headers: { ...this.headers(), ...(options.headers||{}) } });
    if (res.status === 401) {
      autoLog('info', '401 Ïù∏Ï¶ù ÎßåÎ£å ‚Äî ÌÜ†ÌÅ∞ Í∞±Ïã† ÌõÑ Ïû¨ÏãúÎèÑ...');
      await refreshDriveToken();
      res = await fetch(url, { ...options, headers: { ...this.headers(), ...(options.headers||{}) } });
    }
    return res;
  }

  async listImages(folderId) {
    const q = encodeURIComponent(`'${folderId}' in parents and mimeType contains 'image/' and trashed=false`);
    const res = await this.fetchWithRetry(`${DRIVE_API}/files?q=${q}&fields=files(id,name,mimeType,createdTime,size)&orderBy=createdTime&pageSize=100`);
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return data.files || [];
  }

  async downloadFile(fileId) {
    const res = await this.fetchWithRetry(`${DRIVE_API}/files/${fileId}?alt=media`);
    if (!res.ok) throw new Error('Download failed');
    const blob = await res.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve({ base64: reader.result.split(',')[1], dataUrl: reader.result, mime: blob.type });
      reader.readAsDataURL(blob);
    });
  }

  async uploadHtml(folderId, fileName, htmlContent) {
    await this.ensureToken();
    const metadata = { name: fileName, mimeType: 'text/html', parents: [folderId] };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', new Blob([htmlContent], { type: 'text/html' }));

    let res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink', {
      method: 'POST', headers: { 'Authorization': `Bearer ${this.token}` }, body: form
    });
    if (res.status === 401) {
      autoLog('info', 'ÏóÖÎ°úÎìú 401 ‚Äî ÌÜ†ÌÅ∞ Í∞±Ïã† ÌõÑ Ïû¨ÏãúÎèÑ...');
      await refreshDriveToken();
      const form2 = new FormData();
      form2.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form2.append('file', new Blob([htmlContent], { type: 'text/html' }));
      res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink', {
        method: 'POST', headers: { 'Authorization': `Bearer ${this.token}` }, body: form2
      });
    }
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return data;
  }

  async getFolderName(folderId) {
    const res = await this.fetchWithRetry(`${DRIVE_API}/files/${folderId}?fields=name`);
    const data = await res.json();
    return data.name || folderId;
  }
}

let driveService = null;
let tokenClient = null;

// ÌÜ†ÌÅ∞ ÏûêÎèô Í∞±Ïã† ‚Äî ÏÇ¨Ïö©Ïûê ÌåùÏóÖ ÏóÜÏù¥ silent ÏãúÎèÑ, Ïã§Ìå® Ïãú ÌåùÏóÖ
function refreshDriveToken() {
  return new Promise((resolve, reject) => {
    const clientId = state.auto.gdClientId || localStorage.getItem('gd_client_id') || '';
    if (!clientId || !google?.accounts?.oauth2) {
      reject(new Error('Google OAuth Ï¥àÍ∏∞Ìôî Ïïà Îê®'));
      return;
    }
    const client = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
      prompt: '',  // silent Í∞±Ïã† ÏãúÎèÑ
      callback: (resp) => {
        if (resp.access_token) {
          state.auto.accessToken = resp.access_token;
          state.auto.driveConnected = true;
          if (driveService) {
            driveService.token = resp.access_token;
            driveService.tokenExpiresAt = Date.now() + 3500 * 1000;
          } else {
            driveService = new DriveService(resp.access_token);
          }
          autoLog('ok', 'ÌÜ†ÌÅ∞ ÏûêÎèô Í∞±Ïã† ÏôÑÎ£å');
          resolve();
        } else {
          autoLog('err', 'ÌÜ†ÌÅ∞ Í∞±Ïã† Ïã§Ìå® ‚Äî Google Drive Ïû¨Ïó∞Í≤∞ ÌïÑÏöî');
          state.auto.driveConnected = false;
          render();
          reject(new Error('Token refresh failed'));
        }
      },
    });
    client.requestAccessToken();
  });
}

function initGoogleAuth() {
  const clientId = state.auto.gdClientId || GD_CLIENT_ID;
  if (!clientId) return;
  try {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
      callback: (resp) => {
        if (resp.access_token) {
          state.auto.accessToken = resp.access_token;
          state.auto.driveConnected = true;
          driveService = new DriveService(resp.access_token);
          autoLog('info', 'Google Drive Ïó∞Í≤∞ ÏôÑÎ£å');
          render();
        }
      },
    });
  } catch(e) { console.warn('Google auth init failed:', e); }
}

function connectDrive() {
  const clientId = document.getElementById('gdClientId')?.value.trim() || GD_CLIENT_ID;
  if (!clientId) {
    state.error = 'Google Cloud OAuth Client IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.';
    render();
    return;
  }
  localStorage.setItem('gd_client_id', clientId);
  state.auto.gdClientId = clientId;
  try {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
      callback: (resp) => {
        if (resp.error) {
          state.error = `Drive Ïù∏Ï¶ù Ïã§Ìå®: ${resp.error}`;
          render();
          return;
        }
        state.auto.accessToken = resp.access_token;
        state.auto.driveConnected = true;
        driveService = new DriveService(resp.access_token);
        autoLog('info', 'Google Drive Ïó∞Í≤∞ ÏôÑÎ£å');
        render();
      },
    });
    tokenClient.requestAccessToken();
  } catch(e) {
    state.error = `Google Ïù∏Ï¶ù Ïò§Î•ò: ${e.message}`;
    render();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTOMATION LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const autoLogs = [];
function autoLog(type, msg) {
  const t = new Date().toLocaleTimeString('ko-KR');
  autoLogs.unshift({ type, msg, time: t });
  if (autoLogs.length > 200) autoLogs.length = 200;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTOMATION RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODEL SETTINGS UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderModelSettings() {
  const cfg = state.modelConfig;
  const geminiProv = LLM_PROVIDERS.gemini;
  const openaiProv = LLM_PROVIDERS.openai;

  const renderModelCard = (m, selectedId, colorClass) => {
    const sel = m.id === selectedId;
    return `<div class="model-card ${sel ? colorClass : ''}" data-pick-model="${m.id}">
      <div class="mc-label">${m.label}</div>
      <div class="mc-id">${m.id}</div>
      <div class="mc-desc">${m.desc}</div>
      <div class="mc-price">in $${m.inputPerM}/M ¬∑ out $${m.outputPerM}/M</div>
      ${sel ? '<div style="margin-top:6px;font-size:11px;color:var(--ok);font-weight:700">‚úî ÏÑ†ÌÉùÎê®</div>' : ''}
    </div>`;
  };

  const renderImgModelCard = (m) => {
    const sel = m.id === cfg.imageModel;
    return `<div class="model-card ${sel ? 'selected' : ''}" data-pick-imgmodel="${m.id}">
      <div class="mc-label">${m.label}</div>
      <div class="mc-id">${m.id}</div>
      <div class="mc-desc">${m.desc}</div>
      <div class="mc-price">in $${m.inputPerM}/M ¬∑ out $${m.outputPerM}/M ¬∑ img $${m.imageOut}/Ïû•</div>
      ${sel ? '<div style="margin-top:6px;font-size:11px;color:var(--ok);font-weight:700">‚úî ÏÑ†ÌÉùÎê®</div>' : ''}
    </div>`;
  };

  return `<div class="fade-in">
    <h1 class="page-title">‚öôÔ∏è Î™®Îç∏ ÏÑ§Ï†ï</h1>
    <p class="page-desc">LLM ÌîÑÎ°úÎ∞îÏù¥ÎçîÏôÄ Î™®Îç∏ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±ÏùÄ Ìï≠ÏÉÅ Gemini Î™®Îç∏ÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§.</p>

    <!-- ‚îÄ‚îÄ LLM ÌîÑÎ°úÎ∞îÏù¥Îçî ÏÑ†ÌÉù ‚îÄ‚îÄ -->
    <div class="settings-section">
      <h3><span class="material-icons-outlined" style="font-size:18px;color:var(--primary)">psychology</span> LLM ÌîÑÎ°úÎ∞îÏù¥Îçî (ÌÖçÏä§Ìä∏/Î∂ÑÏÑù)</h3>

      <div class="provider-tabs">
        <div class="provider-tab ${cfg.llmProvider==='gemini' ? 'active-gemini' : ''}" data-pick-provider="gemini">
          <div class="pt-icon" style="color:#6366f1">‚ú¶</div>
          <div class="pt-label">Google Gemini</div>
          <div class="pt-sub">Gemini API Key ÏÇ¨Ïö©</div>
        </div>
        <div class="provider-tab ${cfg.llmProvider==='openai' ? 'active-openai' : ''}" data-pick-provider="openai">
          <div class="pt-icon" style="color:#10a37f">‚óÜ</div>
          <div class="pt-label">OpenAI ChatGPT</div>
          <div class="pt-sub">OpenAI API Key ÏÇ¨Ïö©</div>
        </div>
      </div>

      <!-- Gemini LLM Î™®Îç∏ Î™©Î°ù -->
      ${cfg.llmProvider === 'gemini' ? `
      <p style="font-size:12px;color:var(--text-m);margin-bottom:10px">Gemini ÌÖçÏä§Ìä∏ Î™®Îç∏ ÏÑ†ÌÉù</p>
      <div class="model-list">
        ${geminiProv.models.map(m => renderModelCard(m, cfg.llmModel, 'selected')).join('')}
      </div>
      <div class="input-group">
        <label class="label">Gemini API Key</label>
        <div style="position:relative">
          <input type="password" class="input" id="geminiKeyInput" value="${state.apiKey}" placeholder="AIza..." style="font-family:monospace;font-size:13px;padding-right:40px">
          <span class="material-icons-outlined" id="toggleGeminiKey" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:var(--text-m)">visibility</span>
        </div>
      </div>
      ` : `
      <!-- OpenAI LLM Î™®Îç∏ Î™©Î°ù -->
      <p style="font-size:12px;color:var(--text-m);margin-bottom:10px">OpenAI Î™®Îç∏ ÏÑ†ÌÉù</p>
      <div class="model-list">
        ${openaiProv.models.map(m => renderModelCard(m, cfg.llmModel, 'selected-green')).join('')}
      </div>
      <div class="input-group">
        <label class="label">OpenAI API Key</label>
        <div style="position:relative">
          <input type="password" class="input" id="openaiKeyInput" value="${state.openaiKey}" placeholder="sk-..." style="font-family:monospace;font-size:13px;padding-right:40px">
          <span class="material-icons-outlined" id="toggleOpenAIKey" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:var(--text-m)">visibility</span>
        </div>
      </div>
      `}
    </div>

    <!-- ‚îÄ‚îÄ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î™®Îç∏ ‚îÄ‚îÄ -->
    <div class="settings-section">
      <h3><span class="material-icons-outlined" style="font-size:18px;color:var(--orange)">image</span> Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î™®Îç∏ (Gemini Ï†ÑÏö©)</h3>
      <p style="font-size:12px;color:var(--text-m);margin-bottom:12px">ÏÑπÏÖò Ïù¥ÎØ∏ÏßÄ Î∞è Ïù¥ÎØ∏ÏßÄÏª∑ ÏÉùÏÑ± Ïãú ÏÇ¨Ïö©Îê©ÎãàÎã§. Gemini API KeyÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.</p>
      <div class="model-list">
        ${IMAGE_MODELS.map(m => renderImgModelCard(m)).join('')}
      </div>
      ${cfg.llmProvider === 'openai' ? `
      <div class="input-group" style="margin-top:4px">
        <label class="label">Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïö© Gemini API Key (OpenAI ÏÇ¨Ïö© ÏãúÏóêÎèÑ ÌïÑÏöî)</label>
        <div style="position:relative">
          <input type="password" class="input" id="geminiKeyInput" value="${state.apiKey}" placeholder="AIza..." style="font-family:monospace;font-size:13px;padding-right:40px">
          <span class="material-icons-outlined" id="toggleGeminiKey" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:var(--text-m)">visibility</span>
        </div>
      </div>
      ` : ''}
    </div>

    <!-- ‚îÄ‚îÄ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞(ÌîΩÏÖÄ) ÏÑ§Ï†ï ‚îÄ‚îÄ -->
    <div class="settings-section">
      <h3><span class="material-icons-outlined" style="font-size:18px;color:var(--cyan)">photo_size_select_large</span> Ïù¥ÎØ∏ÏßÄ Ï∂úÎ†• ÌÅ¨Í∏∞</h3>
      <p style="font-size:12px;color:var(--text-m);margin-bottom:14px">
        AIÍ∞Ä ÏÉùÏÑ±Ìïú Ïù¥ÎØ∏ÏßÄÎ•º ÏßÄÏ†ïÌïú ÌîΩÏÖÄÎ°ú <b>Ï†ïÌôïÌïòÍ≤å</b> Ï∂úÎ†•Ìï©ÎãàÎã§. (Canvas Î¶¨ÏÇ¨Ïù¥Ï¶à Ï†ÅÏö©)<br>
        auto Î™®ÎìúÎäî AIÍ∞Ä ÏûêÏú†Î°≠Í≤å ÌÅ¨Í∏∞Î•º Í≤∞Ï†ïÌï©ÎãàÎã§.
      </p>

      <!-- Î™®Îìú ÌÜ†Í∏Ä -->
      <div style="display:flex;gap:8px;margin-bottom:16px">
        <button class="provider-tab ${cfg.imageSizeMode==='auto' ? 'active-gemini' : ''}"
          id="imgSizeModeAuto" style="flex:1;padding:10px">
          <div class="pt-icon" style="font-size:16px;color:var(--text-d)">üîÑ</div>
          <div class="pt-label" style="font-size:13px">auto</div>
          <div class="pt-sub">AIÍ∞Ä ÌÅ¨Í∏∞ ÏûêÎèô Í≤∞Ï†ï</div>
        </button>
        <button class="provider-tab ${cfg.imageSizeMode==='custom' ? 'active-gemini' : ''}"
          id="imgSizeModeCustom" style="flex:1;padding:10px">
          <div class="pt-icon" style="font-size:16px;color:var(--cyan)">üìê</div>
          <div class="pt-label" style="font-size:13px">custom px</div>
          <div class="pt-sub">Ï†ïÌôïÌïú ÌîΩÏÖÄ ÏßÄÏ†ï</div>
        </button>
      </div>

      <!-- ÌîΩÏÖÄ ÏûÖÎ†• (custom Î™®ÎìúÏóêÏÑúÎßå ÌôúÏÑ±Ìôî) -->
      <div style="display:flex;gap:12px;align-items:flex-end;${cfg.imageSizeMode!=='custom'?'opacity:.4;pointer-events:none':''}">
        <div class="input-group" style="margin-bottom:0;flex:1">
          <label class="label">Í∞ÄÎ°ú (W) px</label>
          <input type="number" class="input" id="imgWidthInput"
            value="${cfg.imageWidth || 860}" min="64" max="4096" step="1"
            placeholder="860" style="font-family:monospace"
            ${cfg.imageSizeMode!=='custom' ? 'disabled' : ''}>
        </div>
        <div style="padding-bottom:10px;color:var(--text-m);font-size:18px">√ó</div>
        <div class="input-group" style="margin-bottom:0;flex:1">
          <label class="label">ÏÑ∏Î°ú (H) px <span style="font-weight:400;color:var(--text-m)">(ÎπÑÏõåÎëêÎ©¥ ÎπÑÏú® Ïú†ÏßÄ)</span></label>
          <input type="number" class="input" id="imgHeightInput"
            value="${cfg.imageHeight || ''}" min="64" max="4096" step="1"
            placeholder="ÎπÑÏú® Ïú†ÏßÄ" style="font-family:monospace"
            ${cfg.imageSizeMode!=='custom' ? 'disabled' : ''}>
        </div>
      </div>

      ${cfg.imageSizeMode === 'custom' ? `
      <div style="margin-top:10px;padding:8px 12px;background:rgba(6,182,212,.08);border:1px solid rgba(6,182,212,.2);border-radius:6px;font-size:12px;color:var(--cyan)">
        üìê ÏÑ§Ï†ïÎê®: ${cfg.imageWidth}px √ó ${cfg.imageHeight ? cfg.imageHeight+'px' : '(ÎπÑÏú® Ïú†ÏßÄ)'}
        ‚Äî AI ÏÉùÏÑ± ÌõÑ CanvasÎ°ú Ï†ïÌôïÌûà Î¶¨ÏÇ¨Ïù¥Ï¶àÎê©ÎãàÎã§
      </div>` : `
      <div style="margin-top:10px;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--text-m)">
        üîÑ auto Î™®Îìú ‚Äî AIÍ∞Ä ÏûêÏú†Î°≠Í≤å ÌÅ¨Í∏∞Î•º Í≤∞Ï†ïÌï©ÎãàÎã§
      </div>`}
    </div>

    <!-- ‚îÄ‚îÄ Ï†ÄÏû• Î≤ÑÌäº ‚îÄ‚îÄ -->
    <div style="display:flex;gap:12px;align-items:center">
      <button class="btn-primary" id="saveModelSettings">
        <span class="material-icons-outlined" style="font-size:18px">save</span>
        ÏÑ§Ï†ï Ï†ÄÏû•
      </button>
      <div id="modelSaveMsg" style="font-size:13px;color:var(--ok);display:none">‚úÖ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!</div>
    </div>

    <!-- ‚îÄ‚îÄ ÌòÑÏû¨ ÏÑ§Ï†ï ÏöîÏïΩ ‚îÄ‚îÄ -->
    <div style="margin-top:24px;padding:16px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;font-size:12px;line-height:2">
      <div style="font-weight:700;margin-bottom:8px;color:var(--text-d)">ÌòÑÏû¨ ÏÑ§Ï†ï ÏöîÏïΩ</div>
      <div>LLM ÌîÑÎ°úÎ∞îÏù¥Îçî: <b style="color:${cfg.llmProvider==='openai'?'#10a37f':'var(--primary-h)'}">${LLM_PROVIDERS[cfg.llmProvider]?.label}</b></div>
      <div>LLM Î™®Îç∏: <code style="background:var(--bg);padding:1px 6px;border-radius:4px;font-size:11px">${cfg.llmModel}</code></div>
      <div>Ïù¥ÎØ∏ÏßÄ Î™®Îç∏: <code style="background:var(--bg);padding:1px 6px;border-radius:4px;font-size:11px">${cfg.imageModel}</code></div>
      <div>Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞: <b style="color:var(--cyan)">${cfg.imageSizeMode === 'custom' ? (cfg.imageWidth + 'px √ó ' + (cfg.imageHeight ? cfg.imageHeight+'px' : 'ÎπÑÏú®Ïú†ÏßÄ')) : 'auto'}</b></div>
      <div>Gemini Key: <span style="color:${state.apiKey?'var(--ok)':'var(--err)'}">${state.apiKey ? '‚úÖ ÏÑ§Ï†ïÎê®' : '‚ùå ÎØ∏ÏÑ§Ï†ï'}</span></div>
      <div>OpenAI Key: <span style="color:${state.openaiKey?'var(--ok)':'var(--text-m)'}">${state.openaiKey ? '‚úÖ ÏÑ§Ï†ïÎê®' : '‚Äî ÎØ∏ÏÑ§Ï†ï'}</span></div>
    </div>
  </div>`;
}

function renderAutomation() {
  const a = state.auto;
  const connected = a.driveConnected;
  const savedClientId = localStorage.getItem('gd_client_id') || '';

  return `<div class="fade-in">
    <h1 class="page-title">üîÑ ÏûêÎèôÌôî ÏãúÏä§ÌÖú</h1>
    <p class="page-desc">Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏å Ìè¥ÎçîÎ•º Ïó∞Í≤∞ÌïòÎ©¥ ÏÑ§Ï†ïÌïú Í∞ÑÍ≤©ÎßàÎã§ ÏûêÎèôÏúºÎ°ú ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.</p>

    <!-- Drive Connection -->
    <div class="auto-card">
      <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--primary)">cloud</span> Google Drive Ïó∞Í≤∞
        ${connected ? '<span class="auto-status running">‚óè Ïó∞Í≤∞Îê®</span>' : '<span class="auto-status stopped">‚óè ÎØ∏Ïó∞Í≤∞</span>'}
      </h3>
      ${!connected ? `
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px">
          <p style="font-size:13px;color:var(--warn);font-weight:600;margin-bottom:8px">‚ö†Ô∏è Î∞òÎìúÏãú start.batÏúºÎ°ú Ïã§ÌñâÌïòÏÑ∏Ïöî</p>
          <p style="font-size:12px;color:var(--text-d);margin-bottom:4px">Google OAuthÎäî <code style="background:var(--bg-card);padding:2px 6px;border-radius:4px;color:var(--cyan)">http://localhost:8080</code> ÏóêÏÑúÎßå ÏûëÎèôÌï©ÎãàÎã§.</p>
          <p style="font-size:11px;color:var(--text-m)">file:///Î°ú Ïó¥Î©¥ Ïù∏Ï¶ùÏù¥ Ï∞®Îã®Îê©ÎãàÎã§. start.bat ÎçîÎ∏îÌÅ¥Î¶≠ ‚Üí Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú localhost:8080 Ï†ëÏÜç</p>
        </div>
        <p style="font-size:13px;color:var(--text-d);margin-bottom:12px">
          <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color:var(--primary)">Google Cloud Console</a>ÏóêÏÑú OAuth 2.0 Client IDÎ•º Î∞úÍ∏â Î∞õÏúºÏÑ∏Ïöî.
        </p>
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px;font-size:12px;color:var(--text-d)">
          <p style="font-weight:600;margin-bottom:6px">üìã ÏÑ§Ï†ï Î∞©Î≤ï:</p>
          <p>1. Ïú†Ìòï: <strong>Ïõπ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò</strong></p>
          <p>2. ÏäπÏù∏Îêú JavaScript ÏõêÎ≥∏ Ï∂îÍ∞Ä:</p>
          <code style="display:block;background:var(--bg-card);padding:8px 12px;border-radius:6px;margin:6px 0;color:var(--cyan);font-size:13px">http://localhost:8080</code>
          <p>3. Google Drive API ÌôúÏÑ±Ìôî ÌïÑÏöî (<a href="https://console.cloud.google.com/apis/library/drive.googleapis.com" target="_blank" style="color:var(--primary)">Ïó¨Í∏∞ÏÑú ÌôúÏÑ±Ìôî</a>)</p>
        </div>
        <div class="input-group" style="margin-bottom:12px">
          <label class="label">OAuth Client ID</label>
          <input type="text" class="input" id="gdClientId" value="${savedClientId}" placeholder="xxxx.apps.googleusercontent.com" style="font-size:12px;font-family:monospace">
        </div>
        <button class="btn-primary" id="connectDriveBtn">
          <span class="material-icons-outlined" style="font-size:18px">login</span>
          Google Drive Ïó∞Í≤∞
        </button>
      ` : `
        <p style="font-size:13px;color:var(--ok)">‚úÖ Google DriveÍ∞Ä Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.</p>
      `}
    </div>

    ${connected ? `
    <!-- Folder Settings -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="auto-card">
        <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--orange)">folder_open</span> ÏûÖÎ†• Ìè¥Îçî (Ï†úÌíà Ïù¥ÎØ∏ÏßÄ)</h3>
        <div class="input-group" style="margin-bottom:8px">
          <label class="label">Google Drive Ìè¥Îçî ID</label>
          <input type="text" class="input" id="inputFolderId" value="${a.inputFolderId}" placeholder="Ìè¥Îçî URL Ï†ÑÏ≤¥ ÎòêÎäî ID Î∂ôÏó¨ÎÑ£Í∏∞" style="font-size:12px;font-family:monospace">
        </div>
        ${a.inputFolderName ? `<p style="font-size:12px;color:var(--ok)">üìÅ ${a.inputFolderName}</p>` : ''}
        <button class="btn-sm" id="setInputFolder" style="margin-top:4px">
          <span class="material-icons-outlined" style="font-size:14px">check</span> Ìè¥Îçî ÏÑ§Ï†ï
        </button>
        <p style="font-size:11px;color:var(--text-m);margin-top:8px">
          üí° ÎìúÎùºÏù¥Î∏å Ìè¥Îçî Ïó¥Í≥† URLÏóêÏÑú <code>folders/</code> Îí§Ïùò Î¨∏ÏûêÏó¥Ïù¥ IDÏûÖÎãàÎã§
        </p>
      </div>

      <div class="auto-card">
        <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--cyan)">drive_file_move</span> Ï∂úÎ†• Ìè¥Îçî (ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ)</h3>
        <div class="input-group" style="margin-bottom:8px">
          <label class="label">Google Drive Ìè¥Îçî ID</label>
          <input type="text" class="input" id="outputFolderId" value="${a.outputFolderId}" placeholder="Ìè¥Îçî URL Ï†ÑÏ≤¥ ÎòêÎäî ID Î∂ôÏó¨ÎÑ£Í∏∞" style="font-size:12px;font-family:monospace">
        </div>
        ${a.outputFolderName ? `<p style="font-size:12px;color:var(--ok)">üìÅ ${a.outputFolderName}</p>` : ''}
        <button class="btn-sm" id="setOutputFolder" style="margin-top:4px">
          <span class="material-icons-outlined" style="font-size:14px">check</span> Ìè¥Îçî ÏÑ§Ï†ï
        </button>
      </div>
    </div>

    <!-- Interval & Control -->
    <div class="auto-card">
      <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--warn)">timer</span> Ïã§Ìñâ Í∞ÑÍ≤©</h3>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
        <input type="range" min="5" max="60" step="5" value="${a.intervalMin}" class="interval-slider" id="intervalSlider">
        <span style="font-size:24px;font-weight:700;color:var(--primary);min-width:60px;text-align:center" id="intervalDisplay">${a.intervalMin}Î∂Ñ</span>
      </div>
      <p style="font-size:12px;color:var(--text-m)">ÏûÖÎ†• Ìè¥ÎçîÏóêÏÑú ÏïÑÏßÅ Ï≤òÎ¶¨ Ïïà Îêú Ïù¥ÎØ∏ÏßÄÎ•º 1Ïû•Ïî© Í∞ÄÏ†∏ÏôÄ 15ÏÑπÏÖò ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄÎ•º ÏÉùÏÑ± ÌõÑ Ï∂úÎ†• Ìè¥ÎçîÏóê Ï†ÄÏû•Ìï©ÎãàÎã§.</p>

      <div style="display:flex;gap:10px;margin-top:16px;align-items:center">
        ${!a.running ? `
          <button class="btn-primary" id="startAutoBtn" ${!a.inputFolderId||!a.outputFolderId?'disabled':''}>
            <span class="material-icons-outlined" style="font-size:18px">play_arrow</span>
            ÏûêÎèôÌôî ÏãúÏûë
          </button>
        ` : `
          <button class="btn-primary" id="stopAutoBtn" style="background:var(--err)">
            <span class="material-icons-outlined" style="font-size:18px">stop</span>
            ÏûêÎèôÌôî Ï§ëÏßÄ
          </button>
        `}
        <button class="btn-sm" id="runOnceBtn" ${!a.inputFolderId||!a.outputFolderId||a.running?'disabled':''} style="padding:10px 16px">
          <span class="material-icons-outlined" style="font-size:16px">play_circle</span>
          1Ìöå Ï¶âÏãú Ïã§Ìñâ
        </button>
        <button class="btn-sm" id="resetProcessedBtn" style="padding:10px 16px">
          <span class="material-icons-outlined" style="font-size:16px">restart_alt</span>
          Ï≤òÎ¶¨Í∏∞Î°ù Ï¥àÍ∏∞Ìôî
        </button>
        ${a.running ? `<span class="auto-status running" style="margin-left:auto">‚óè ÏûëÎèô Ï§ë ${a.nextRunAt ? '| Îã§Ïùå Ïã§Ìñâ: '+a.nextRunAt : ''}</span>` : ''}
      </div>
    </div>

    <!-- Current Processing -->
    ${a.currentItem ? `
    <div class="auto-card" style="border-color:var(--warn)">
      <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--warn)">hourglass_top</span> ÌòÑÏû¨ Ï≤òÎ¶¨ Ï§ë</h3>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:13px;font-weight:600">${a.currentItem.name}</span>
        <span style="font-size:12px;color:var(--text-m)">${a.currentMsg}</span>
      </div>
      <div class="progress-outer" style="max-width:100%"><div class="progress-inner" style="width:${a.currentProgress}%">${a.currentProgress}%</div></div>
    </div>
    ` : ''}

    <!-- Stats -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
      <div class="auto-card" style="text-align:center">
        <div style="font-size:32px;font-weight:900;color:var(--primary)">${a.totalProcessed}</div>
        <div style="font-size:12px;color:var(--text-d)">Ï¥ù Ï≤òÎ¶¨ ÏôÑÎ£å</div>
      </div>
      <div class="auto-card" style="text-align:center">
        <div style="font-size:32px;font-weight:900;color:var(--warn)">${a.queue.length}</div>
        <div style="font-size:12px;color:var(--text-d)">ÎåÄÍ∏∞ Ï§ë</div>
      </div>
      <div class="auto-card" style="text-align:center">
        <div style="font-size:32px;font-weight:900;color:var(--ok)">${a.processedFileIds.size}</div>
        <div style="font-size:12px;color:var(--text-d)">ÎàÑÏ†Å Ï≤òÎ¶¨ (Ïä§ÌÇµ)</div>
      </div>
    </div>

    <!-- Recent Completed -->
    ${a.completed.length ? `
    <div class="auto-card">
      <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--ok)">check_circle</span> ÏµúÍ∑º ÏôÑÎ£å</h3>
      ${a.completed.slice(0, 10).map(c => `
        <div class="queue-item">
          <div class="q-status ${c.error?'error':'done'}"></div>
          <span style="flex:1">${c.name}</span>
          <span style="font-size:11px;color:var(--text-m)">${c.finishedAt || ''}</span>
          ${c.error ? `<span style="font-size:11px;color:var(--err)">${c.error}</span>` : '<span style="font-size:11px;color:var(--ok)">‚úÖ ÏôÑÎ£å</span>'}
        </div>
      `).join('')}
    </div>` : ''}

    <!-- Log -->
    <div class="auto-card">
      <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--text-d)">terminal</span> Î°úÍ∑∏</h3>
      <div class="log-box" id="autoLogBox">
        ${autoLogs.length === 0 ? '<div class="log-line" style="color:var(--text-m)">ÏïÑÏßÅ Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>' : ''}
        ${autoLogs.slice(0, 50).map(l => `<div class="log-line ${l.type}">[${l.time}] ${l.msg}</div>`).join('')}
      </div>
    </div>
    ` : `
    <div class="auto-card" style="text-align:center;padding:40px">
      <span class="material-icons-outlined" style="font-size:48px;color:var(--text-m);margin-bottom:12px">cloud_off</span>
      <p style="color:var(--text-d)">Google DriveÎ•º Î®ºÏ†Ä Ïó∞Í≤∞ÌïòÏÑ∏Ïöî.</p>
    </div>
    `}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTOMATION ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function autoProcessOne() {
  if (!driveService) {
    autoLog('err', 'DriveÍ∞Ä Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå');
    return;
  }
  if (!state.auto.inputFolderId || !state.auto.outputFolderId) {
    autoLog('err', 'ÏûÖÎ†•/Ï∂úÎ†• Ìè¥ÎçîÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùå');
    return;
  }

  let autoLLM;
  try { autoLLM = getLLMClient(); } catch(e) { autoLog('err', e.message); return; }
  const autoGeminiImage = new GeminiAPI(state.apiKey);

  // 1. List images in input folder
  autoLog('info', 'ÏûÖÎ†• Ìè¥Îçî Ïä§Ï∫î Ï§ë...');
  state.auto.currentMsg = 'Ìè¥Îçî Ïä§Ï∫î Ï§ë...';
  state.auto.currentProgress = 0;
  render();

  let files;
  try {
    files = await driveService.listImages(state.auto.inputFolderId);
  } catch(e) {
    // Ïù∏Ï¶ù ÎßåÎ£åÏù∏ Í≤ΩÏö∞ ÏûêÎèô Í∞±Ïã† ÏãúÎèÑ
    if (e.message.includes('invalid authentication') || e.message.includes('401') || e.message.includes('Request had invalid')) {
      autoLog('info', 'ÌÜ†ÌÅ∞ ÎßåÎ£å Í∞êÏßÄ ‚Äî ÏûêÎèô Í∞±Ïã† ÏãúÎèÑ...');
      try {
        await refreshDriveToken();
        files = await driveService.listImages(state.auto.inputFolderId);
      } catch(e2) {
        autoLog('err', `ÌÜ†ÌÅ∞ Í∞±Ïã† ÌõÑÏóêÎèÑ Ïã§Ìå®: ${e2.message}`);
        state.auto.currentItem = null;
        render();
        return;
      }
    } else {
      autoLog('err', `Ìè¥Îçî Ïä§Ï∫î Ïã§Ìå®: ${e.message}`);
      state.auto.currentItem = null;
      render();
      return;
    }
  }

  // 2. Filter already processed
  const unprocessed = files.filter(f => !state.auto.processedFileIds.has(f.id));
  autoLog('info', `Ï†ÑÏ≤¥ ${files.length}Ïû•, ÎØ∏Ï≤òÎ¶¨ ${unprocessed.length}Ïû•`);

  if (unprocessed.length === 0) {
    autoLog('info', 'Ï≤òÎ¶¨Ìï† ÏÉà Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§. ÎåÄÍ∏∞Ìï©ÎãàÎã§.');
    state.auto.currentItem = null;
    render();
    return;
  }

  // 3. Pick the first unprocessed file
  const file = unprocessed[0];
  state.auto.currentItem = { id: file.id, name: file.name };
  state.auto.currentProgress = 5;
  state.auto.currentMsg = `${file.name} Îã§Ïö¥Î°úÎìú Ï§ë...`;
  autoLog('info', `Ï≤òÎ¶¨ ÏãúÏûë: ${file.name}`);
  render();

  try {
    // 4. Download the image
    const imgData = await driveService.downloadFile(file.id);
    state.auto.currentProgress = 15;
    state.auto.currentMsg = 'AI Î∂ÑÏÑù Ï§ë...';
    render();

    // 5. Analyze with selected LLM
    const analysis = await autoLLM.analyzeImage(imgData.base64, imgData.mime);
    autoLog('ok', `Î∂ÑÏÑù ÏôÑÎ£å: ${analysis.product_name || file.name}`);
    state.auto.currentProgress = 25;
    state.auto.currentMsg = 'Í≤ΩÏüÅ Î∂ÑÏÑù Ï§ë...';
    render();

    // 6. Competitor search
    let compRef = '';
    try {
      const comp = await autoLLM.searchSimilarProducts(analysis.product_name || analysis.product_name_en, analysis.category);
      compRef = JSON.stringify(comp).substring(0, 1000);
      autoLog('ok', `Í≤ΩÏüÅ Î∂ÑÏÑù ÏôÑÎ£å: ${comp.similar_products?.length || 0}Í∞ú`);
    } catch(e) {
      autoLog('err', 'Í≤ΩÏüÅ Î∂ÑÏÑù Ïä§ÌÇµ: ' + e.message);
    }
    state.auto.currentProgress = 30;

    // 7. Generate all 15 sections
    const sectionContents = {};
    const sectionImages = {};
    const instructions = state.sectionInstructions; // use saved instructions

    for (let i = 0; i < SECTIONS.length; i++) {
      const s = SECTIONS[i];
      const pct = Math.round(30 + ((i / SECTIONS.length) * 60));
      state.auto.currentProgress = pct;
      state.auto.currentMsg = `[${i+1}/15] ${s.name} ÏÉùÏÑ± Ï§ë...`;
      render();

      try {
        const content = await autoLLM.generateSectionContent(s, analysis, instructions[s.id] || '', compRef, state.referenceRatio);
        sectionContents[s.id] = content;

        // Image (Ìï≠ÏÉÅ Gemini Ïù¥ÎØ∏ÏßÄ Î™®Îç∏)
        if (state.apiKey) {
          try {
            const imgPrompt = content.image_description || content.design_notes || s.purpose;
            const img = await autoGeminiImage.generateImage(imgPrompt, imgData.base64, imgData.mime);
            if (img) sectionImages[s.id] = img;
          } catch(e) {}
        }
      } catch(e) {
        autoLog('err', `ÏÑπÏÖò ${s.name} Ïã§Ìå®: ${e.message}`);
        sectionContents[s.id] = { headline: s.name, subheadline: 'ÏÉùÏÑ± Ïã§Ìå®', body_text: e.message, color_scheme: {background:'#fff',text_primary:'#c00',text_secondary:'#e00'}, font_suggestion:{headline_size:'32px',body_size:'14px'} };
      }
      await new Promise(r => setTimeout(r, 500));
    }

    state.auto.currentProgress = 92;
    state.auto.currentMsg = 'HTML ÏÉùÏÑ± Î∞è ÏóÖÎ°úÎìú Ï§ë...';
    render();

    // 8. Build HTML
    const htmlContent = buildExportHtml(analysis, sectionContents, sectionImages);

    // 9. Upload to Drive
    const productName = analysis.product_name || file.name.replace(/\.[^.]+$/, '');
    const fileName = `${productName}_ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ_${new Date().toISOString().slice(0,10)}.html`;
    const uploaded = await driveService.uploadHtml(state.auto.outputFolderId, fileName, htmlContent);
    autoLog('ok', `‚úÖ ÏóÖÎ°úÎìú ÏôÑÎ£å: ${fileName}`);

    // 10. Mark as processed
    state.auto.processedFileIds.add(file.id);
    localStorage.setItem('auto_processed_ids', JSON.stringify([...state.auto.processedFileIds]));
    state.auto.totalProcessed++;
    localStorage.setItem('auto_total_processed', state.auto.totalProcessed);
    state.auto.completed.unshift({ name: file.name, finishedAt: new Date().toLocaleTimeString('ko-KR'), error: null });
    if (state.auto.completed.length > 50) state.auto.completed.length = 50;
    localStorage.setItem('auto_completed', JSON.stringify(state.auto.completed));
    state.auto.currentItem = null;
    state.auto.currentProgress = 100;
    state.auto.currentMsg = '';
    render();

  } catch(e) {
    autoLog('err', `Ï≤òÎ¶¨ Ïã§Ìå® (${file.name}): ${e.message}`);
    state.auto.completed.unshift({ name: file.name, finishedAt: new Date().toLocaleTimeString('ko-KR'), error: e.message });
    if (state.auto.completed.length > 50) state.auto.completed.length = 50;
    localStorage.setItem('auto_completed', JSON.stringify(state.auto.completed));
    state.auto.currentItem = null;
    render();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMAGE CUTS ‚Äî RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderImageCuts() {
  const c = state.cuts;
  const hasSrc = !!c.sourcePreview;
  const anyResult = c.prompts.some(p => p.result);

  return `<div class="fade-in">
    <h1 class="page-title">‚ú® Ïù¥ÎØ∏ÏßÄÏª∑ ÏÉùÏÑ±</h1>
    <p class="page-desc">Ï†úÌíà Ïù¥ÎØ∏ÏßÄÎ•º Ïò¨Î¶¨Í≥† 4Í∞ÄÏßÄ ÌîÑÎ°¨ÌîÑÌä∏Î°ú Í∞ÅÍ∞Å Îã§Î•∏ Ïù¥ÎØ∏ÏßÄÏª∑ÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§. ÏÉùÏÑ±Îêú Ïª∑ÏùÄ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏõêÌïòÎäî ÏÑπÏÖòÏóê Î∞∞ÏπòÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
    <p style="font-size:12px;color:var(--primary);margin-bottom:20px;background:var(--primary-dim);padding:8px 12px;border-radius:8px;display:inline-block">
      ü§ñ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î™®Îç∏: <strong>gemini-3-pro-image-preview</strong>
    </p>

    <!-- ÏÜåÏä§ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú -->
    <div class="source-upload" id="cutsUploadArea">
      ${hasSrc
        ? `<img src="${c.sourcePreview}" style="max-height:200px;max-width:100%;border-radius:8px;object-fit:contain">`
        : `<span class="material-icons-outlined" style="font-size:40px;color:var(--primary);display:block;margin-bottom:8px">add_photo_alternate</span>
           <p style="font-size:15px;font-weight:500">Ï†úÌíà Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</p>
           <p style="font-size:12px;color:var(--text-m);margin-top:4px">ÌÅ¥Î¶≠ ÎòêÎäî ÎìúÎûòÍ∑∏&amp;ÎìúÎ°≠</p>`
      }
      <input type="file" id="cutsFileInput" accept="image/*" style="display:none">
    </div>

    <!-- 4Í∞ú Ïª∑ Ïπ¥Îìú -->
    <div class="cuts-grid">
      ${c.prompts.map((p, i) => `
        <div class="cut-card ${p.result ? 'has-result' : ''}">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <span class="cut-label">${p.label}</span>
            <div style="display:flex;gap:6px">
              <button class="btn-sm" data-rename-cut="${i}">‚úèÔ∏è Ïù¥Î¶ÑÎ≥ÄÍ≤Ω</button>
              ${p.result ? `<a class="btn-sm" href="${p.result}" download="cut${i+1}.png">‚¨áÔ∏è Ï†ÄÏû•</a>` : ''}
            </div>
          </div>

          <!-- ÎØ∏Î¶¨Î≥¥Í∏∞ -->
          <div class="cut-preview">
            ${p.generating
              ? `<div class="cut-spinner"></div>`
              : p.result
                ? `<img src="${p.result}" alt="cut${i+1}">`
                : `<span style="color:var(--text-m);font-size:12px">ÏÉùÏÑ± Ï†Ñ</span>`
            }
          </div>

          <!-- ÌîÑÎ°¨ÌîÑÌä∏ ÏûÖÎ†• -->
          <textarea class="textarea" data-cut-prompt="${i}" rows="3"
            placeholder="Ïòà) Ìù∞ Î∞∞Í≤ΩÏóê Ï†úÌíàÏùÑ Ï§ëÏïô Î∞∞Ïπò, Í∑∏Î¶ºÏûê ÏóÜÏù¥ ÍπîÎÅîÌïòÍ≤å&#10;Ïòà) ÎùºÏù¥ÌîÑÏä§ÌÉÄÏùº Í∞êÏÑ±, Ïπ¥Ìéò ÌÖåÏù¥Î∏î ÏúÑÏóê ÎÜìÏù∏ Î™®Ïäµ&#10;Ïòà) Îã§ÌÅ¨ÌÜ§ Îü≠ÏÖîÎ¶¨, Í≤ÄÏùÄ Î∞∞Í≤Ω Í≥®Îìú Ï°∞Î™Ö"
            style="font-size:12px">${p.prompt}</textarea>

          <!-- Í∞úÎ≥Ñ ÏÉùÏÑ± Î≤ÑÌäº -->
          <button class="btn-primary" data-gen-cut="${i}"
            style="font-size:13px;padding:9px 16px;justify-content:center"
            ${!hasSrc || p.generating ? 'disabled' : ''}>
            <span class="material-icons-outlined" style="font-size:16px">${p.generating ? 'hourglass_empty' : 'auto_fix_high'}</span>
            ${p.generating ? 'ÏÉùÏÑ± Ï§ë...' : 'Ïù¥ Ïª∑ ÏÉùÏÑ±'}
          </button>
        </div>
      `).join('')}
    </div>

    <!-- 4Í∞ú Ï†ÑÏ≤¥ ÏÉùÏÑ± Î≤ÑÌäº -->
    <div style="display:flex;gap:10px;margin-bottom:32px">
      <button class="btn-primary" id="genAllCutsBtn"
        style="padding:14px 32px;font-size:15px"
        ${!hasSrc ? 'disabled' : ''}>
        <span class="material-icons-outlined" style="font-size:20px">auto_fix_high</span>
        4Í∞ú Ïª∑ Ï†ÑÏ≤¥ ÏÉùÏÑ±
      </button>
      ${anyResult ? `<button class="btn-sm" id="clearAllCutsBtn" style="padding:12px 20px">
        <span class="material-icons-outlined" style="font-size:16px">delete_sweep</span>
        Í≤∞Í≥º Ï¥àÍ∏∞Ìôî
      </button>` : ''}
    </div>

    <!-- ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ Î∞∞Ïπò ÏÑ§Ï†ï -->
    ${anyResult ? `
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px">
      <h3 style="font-size:15px;font-weight:700;margin-bottom:4px">üìå ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑπÏÖòÏóê Î∞∞Ïπò</h3>
      <p style="font-size:12px;color:var(--text-m);margin-bottom:16px">Í∞Å ÏÑπÏÖòÏóê Ïñ¥Îñ§ Ïù¥ÎØ∏ÏßÄÏª∑ÏùÑ ÎÑ£ÏùÑÏßÄ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. ÎØ∏Î¶¨Î≥¥Í∏∞¬∑HTML ÎÇ¥Î≥¥ÎÇ¥Í∏∞Ïóê Î∞òÏòÅÎê©ÎãàÎã§.</p>
      <div>
        ${SECTIONS.map(s => {
          const placed = c.placement[s.id];
          const placedCut = c.prompts.find(p => p.id === placed);
          return `<div class="placement-row">
            <span style="font-size:16px">${s.icon}</span>
            <span style="flex:1;font-size:13px">${s.n}. ${s.name}</span>
            ${placedCut?.result ? `<img class="cut-thumb" src="${placedCut.result}" alt="">` : '<div class="cut-thumb" style="opacity:.3"></div>'}
            <select class="placement-select" data-place-section="${s.id}">
              <option value="">-- Î∞∞Ïπò Ïïà Ìï®</option>
              ${c.prompts.map(p => p.result ? `<option value="${p.id}" ${placed===p.id?'selected':''}>${p.label}</option>` : '').join('')}
            </select>
          </div>`;
        }).join('')}
      </div>
      <div style="margin-top:16px;display:flex;gap:8px">
        <button class="btn-primary" id="applyPlacementBtn" style="font-size:13px;padding:10px 20px">
          <span class="material-icons-outlined" style="font-size:16px">check</span>
          Î∞∞Ïπò Ï†ÅÏö©
        </button>
        <span style="font-size:12px;color:var(--text-m);align-self:center">ÎØ∏Î¶¨Î≥¥Í∏∞ ÌÉ≠ÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî</span>
      </div>
    </div>
    ` : `
    <div style="background:var(--bg-card);border:1px dashed var(--border);border-radius:12px;padding:24px;text-align:center;color:var(--text-m);font-size:13px">
      Ïù¥ÎØ∏ÏßÄÏª∑ÏùÑ ÏÉùÏÑ±ÌïòÎ©¥ ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ ÏÑπÏÖòÏóê Î∞∞ÏπòÌï† Ïàò ÏûàÏäµÎãàÎã§.
    </div>
    `}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMAGE CUTS ‚Äî GENERATION LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateCut(idx) {
  const c = state.cuts;
  const p = c.prompts[idx];
  if (!c.sourceBase64 || !p.prompt.trim()) {
    state.error = 'Ïù¥ÎØ∏ÏßÄÏôÄ ÌîÑÎ°¨ÌîÑÌä∏Î•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
    render();
    return;
  }

  gemini = gemini || new GeminiAPI(state.apiKey);
  p.generating = true;
  render();

  try {
    const cfg = state.modelConfig;
    const sizeHint = (cfg.imageSizeMode === 'custom' && cfg.imageWidth)
      ? `Exact output size: ${cfg.imageWidth}px wide${cfg.imageHeight ? ' √ó ' + cfg.imageHeight + 'px tall' : ''}.`
      : 'Aspect ratio 4:3.';
    const fullPrompt = `Create a professional Korean e-commerce product detail page image cut.
Product image is provided. Apply the following creative direction:
${p.prompt}
Requirements: High quality, clean, professional Korean e-commerce style.
Maintain the product as the focal point. ${sizeHint}`;

    const parts = [
      { text: fullPrompt },
      { inline_data: { mime_type: c.sourceMime, data: c.sourceBase64 } }
    ];
    const body = {
      contents: [{ parts }],
      generationConfig: { temperature: 0.8, responseModalities: ['TEXT', 'IMAGE'] }
    };

    // ÏÑ†ÌÉùÎêú Ïù¥ÎØ∏ÏßÄ Î™®Îç∏ ÏÇ¨Ïö©
    const cutImgModel = getImageModel();
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/${cutImgModel}:generateContent?key=${state.apiKey}`,
      { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }
    );
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    tokenTracker.record(cutImgModel, data.usageMetadata?.promptTokenCount, data.usageMetadata?.candidatesTokenCount, true);

    let imgResult = null;
    for (const part of data.candidates[0].content.parts) {
      const id = part.inlineData || part.inline_data;
      if (id && id.mime_type?.startsWith('image/')) {
        imgResult = `data:${id.mime_type};base64,${id.data}`;
        break;
      }
      if (id && id.mimeType?.startsWith('image/')) {
        imgResult = `data:${id.mimeType};base64,${id.data}`;
        break;
      }
    }
    if (!imgResult) throw new Error('Ïù¥ÎØ∏ÏßÄÍ∞Ä Î∞òÌôòÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§');

    // ÌîΩÏÖÄ ÏÑ§Ï†ïÏù¥ customÏù¥Î©¥ CanvasÎ°ú Ï†ïÌôïÌûà Î¶¨ÏÇ¨Ïù¥Ï¶à
    imgResult = await applyImageSizeConfig(imgResult);

    p.result = imgResult;
    p.generating = false;
    savePrompts();
    render();
  } catch(e) {
    p.generating = false;
    state.error = `Ïª∑ ${idx+1} ÏÉùÏÑ± Ïã§Ìå®: ${e.message}`;
    render();
  }
}

async function generateAllCuts() {
  for (let i = 0; i < state.cuts.prompts.length; i++) {
    await generateCut(i);
    await new Promise(r => setTimeout(r, 800));
  }
}

function savePrompts() {
  // result(base64)Îäî Ïö©Îüâ Î¨∏Ï†úÎ°ú Ï†ÄÏû• Ïïà Ìï® ‚Äî prompt/labelÎßå Ï†ÄÏû•
  const toSave = state.cuts.prompts.map(p => ({
    id: p.id,
    label: p.label,
    prompt: p.prompt,
    result: null,
    generating: false,
  }));
  try { localStorage.setItem('cuts_prompts', JSON.stringify(toSave)); } catch(e) {}
  try {
    document.cookie = `cuts_prompts=${encodeURIComponent(JSON.stringify(toSave))};max-age=31536000;path=/;SameSite=Lax`;
  } catch(e) {}
}

function loadPrompts() {
  let data = null;
  try {
    const raw = localStorage.getItem('cuts_prompts');
    if (raw) data = JSON.parse(raw);
  } catch(e) {}
  if (!data) {
    try {
      const m = document.cookie.match(/cuts_prompts=([^;]+)/);
      if (m) data = JSON.parse(decodeURIComponent(m[1]));
    } catch(e) {}
  }
  return data || [
    { id:'cut1', label:'Ïª∑ 1', prompt:'', result:null, generating:false },
    { id:'cut2', label:'Ïª∑ 2', prompt:'', result:null, generating:false },
    { id:'cut3', label:'Ïª∑ 3', prompt:'', result:null, generating:false },
    { id:'cut4', label:'Ïª∑ 4', prompt:'', result:null, generating:false },
    { id:'cut5', label:'Ïª∑ 5', prompt:'', result:null, generating:false },
  ];
}

function savePlacement() {
  localStorage.setItem('cuts_placement', JSON.stringify(state.cuts.placement));
}

// Î∞∞Ïπò Ï†ÅÏö© ‚Äî sectionImagesÏóê Ïù¥ÎØ∏ÏßÄÏª∑ Î∞òÏòÅ
function applyPlacement() {
  const c = state.cuts;
  for (const [sectionId, cutId] of Object.entries(c.placement)) {
    const cut = c.prompts.find(p => p.id === cutId);
    if (cut?.result) {
      state.sectionImages[sectionId] = cut.result;
    } else {
      delete state.sectionImages[sectionId];
    }
  }
  savePlacement();
  state.step = 'preview';
  render();
}

// ‚îÄ‚îÄ bindEvents ÌôïÏû• (Ïù¥ÎØ∏ÏßÄÏª∑) ‚îÄ‚îÄ
const _origBind2 = bindEvents;
bindEvents = function() {
  _origBind2();

  // ÏÜåÏä§ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
  const cutsArea = document.getElementById('cutsUploadArea');
  const cutsInput = document.getElementById('cutsFileInput');
  if (cutsArea) {
    cutsArea.onclick = () => cutsInput.click();
    cutsArea.ondragover = e => e.preventDefault();
    cutsArea.ondrop = e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file?.type.startsWith('image/')) loadCutSource(file);
    };
  }
  if (cutsInput) cutsInput.onchange = e => { if (e.target.files[0]) loadCutSource(e.target.files[0]); };

  // ÌîÑÎ°¨ÌîÑÌä∏ ÏûÖÎ†• Ï†ÄÏû•
  document.querySelectorAll('[data-cut-prompt]').forEach(el => {
    el.oninput = e => {
      state.cuts.prompts[+el.dataset.cutPrompt].prompt = e.target.value;
      savePrompts();
    };
  });

  // Í∞úÎ≥Ñ ÏÉùÏÑ±
  document.querySelectorAll('[data-gen-cut]').forEach(btn => {
    btn.onclick = () => generateCut(+btn.dataset.genCut);
  });

  // Ïù¥Î¶Ñ Î≥ÄÍ≤Ω
  document.querySelectorAll('[data-rename-cut]').forEach(btn => {
    btn.onclick = () => {
      const i = +btn.dataset.renameCut;
      const newName = prompt('Ïª∑ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', state.cuts.prompts[i].label);
      if (newName?.trim()) {
        state.cuts.prompts[i].label = newName.trim();
        savePrompts();
        render();
      }
    };
  });

  // Ï†ÑÏ≤¥ ÏÉùÏÑ±
  const genAllBtn = document.getElementById('genAllCutsBtn');
  if (genAllBtn) genAllBtn.onclick = generateAllCuts;

  // Í≤∞Í≥º Ï¥àÍ∏∞Ìôî
  const clearBtn = document.getElementById('clearAllCutsBtn');
  if (clearBtn) clearBtn.onclick = () => {
    state.cuts.prompts.forEach(p => { p.result = null; p.generating = false; });
    state.cuts.placement = {};
    savePlacement();
    render();
  };

  // Î∞∞Ïπò ÏÑ†ÌÉù
  document.querySelectorAll('[data-place-section]').forEach(sel => {
    sel.onchange = e => {
      const sid = sel.dataset.placeSection;
      if (e.target.value) state.cuts.placement[sid] = e.target.value;
      else delete state.cuts.placement[sid];
    };
  });

  // Î∞∞Ïπò Ï†ÅÏö©
  const applyBtn = document.getElementById('applyPlacementBtn');
  if (applyBtn) applyBtn.onclick = applyPlacement;

  // ‚îÄ‚îÄ Î™®Îç∏ ÏÑ§Ï†ï Ïù¥Î≤§Ìä∏ ‚îÄ‚îÄ
  // ÌîÑÎ°úÎ∞îÏù¥Îçî ÏÑ†ÌÉù
  document.querySelectorAll('[data-pick-provider]').forEach(el => {
    el.onclick = () => {
      const prov = el.dataset.pickProvider;
      state.modelConfig.llmProvider = prov;
      // ÌîÑÎ°úÎ∞îÏù¥Îçî Î≥ÄÍ≤Ω Ïãú Ìï¥Îãπ ÌîÑÎ°úÎ∞îÏù¥ÎçîÏùò Ï≤´ Î≤àÏß∏ Î™®Îç∏Î°ú ÏûêÎèô ÏÑ†ÌÉù
      const firstModel = LLM_PROVIDERS[prov]?.models[0]?.id;
      if (firstModel) state.modelConfig.llmModel = firstModel;
      render();
    };
  });

  // LLM Î™®Îç∏ ÏÑ†ÌÉù
  document.querySelectorAll('[data-pick-model]').forEach(el => {
    el.onclick = () => {
      state.modelConfig.llmModel = el.dataset.pickModel;
      render();
    };
  });

  // Ïù¥ÎØ∏ÏßÄ Î™®Îç∏ ÏÑ†ÌÉù
  document.querySelectorAll('[data-pick-imgmodel]').forEach(el => {
    el.onclick = () => {
      state.modelConfig.imageModel = el.dataset.pickImgmodel;
      render();
    };
  });

  // Gemini ÌÇ§ visibility ÌÜ†Í∏Ä
  const toggleGemini = document.getElementById('toggleGeminiKey');
  if (toggleGemini) {
    toggleGemini.onclick = () => {
      const inp = document.getElementById('geminiKeyInput');
      if (!inp) return;
      if (inp.type === 'password') { inp.type = 'text'; toggleGemini.textContent = 'visibility_off'; }
      else { inp.type = 'password'; toggleGemini.textContent = 'visibility'; }
    };
  }

  // OpenAI ÌÇ§ visibility ÌÜ†Í∏Ä
  const toggleOAI = document.getElementById('toggleOpenAIKey');
  if (toggleOAI) {
    toggleOAI.onclick = () => {
      const inp = document.getElementById('openaiKeyInput');
      if (!inp) return;
      if (inp.type === 'password') { inp.type = 'text'; toggleOAI.textContent = 'visibility_off'; }
      else { inp.type = 'password'; toggleOAI.textContent = 'visibility'; }
    };
  }

  // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Î™®Îìú ÌÜ†Í∏Ä
  const imgSizeModeAuto = document.getElementById('imgSizeModeAuto');
  if (imgSizeModeAuto) {
    imgSizeModeAuto.onclick = () => {
      state.modelConfig.imageSizeMode = 'auto';
      render();
    };
  }
  const imgSizeModeCustom = document.getElementById('imgSizeModeCustom');
  if (imgSizeModeCustom) {
    imgSizeModeCustom.onclick = () => {
      state.modelConfig.imageSizeMode = 'custom';
      render();
    };
  }

  // ÏÑ§Ï†ï Ï†ÄÏû•
  const saveModelBtn = document.getElementById('saveModelSettings');
  if (saveModelBtn) {
    saveModelBtn.onclick = () => {
      // Gemini ÌÇ§
      const geminiInp = document.getElementById('geminiKeyInput');
      if (geminiInp && geminiInp.value.trim()) {
        state.apiKey = geminiInp.value.trim();
        saveKey(state.apiKey);
      }
      // OpenAI ÌÇ§
      const openaiInp = document.getElementById('openaiKeyInput');
      if (openaiInp && openaiInp.value.trim()) {
        state.openaiKey = openaiInp.value.trim();
        saveOpenAIKey(state.openaiKey);
      }
      // Ïù¥ÎØ∏ÏßÄ ÌîΩÏÖÄ ÏÑ§Ï†ï
      const wInp = document.getElementById('imgWidthInput');
      const hInp = document.getElementById('imgHeightInput');
      if (wInp) {
        const w = parseInt(wInp.value);
        if (w >= 64 && w <= 4096) state.modelConfig.imageWidth = w;
      }
      if (hInp) {
        const h = parseInt(hInp.value);
        state.modelConfig.imageHeight = (hInp.value.trim() === '' || isNaN(h)) ? null : Math.max(64, Math.min(4096, h));
      }
      // Î™®Îç∏ ÏÑ§Ï†ï Ï†ÄÏû•
      saveModelConfig(state.modelConfig);
      // Ï†ÄÏû• ÏôÑÎ£å Î©îÏãúÏßÄ
      const msg = document.getElementById('modelSaveMsg');
      if (msg) { msg.style.display = 'inline'; setTimeout(() => { msg.style.display = 'none'; }, 2000); }
      render(); // ÏÇ¨Ïù¥ÎìúÎ∞î ÏöîÏïΩ Î∞è ÏÑ§Ï†ï ÏöîÏïΩ Í∞±Ïã†
    };
  }
};

function loadCutSource(file) {
  state.cuts.sourceMime = file.type;
  const reader = new FileReader();
  reader.onload = e => {
    state.cuts.sourcePreview = e.target.result;
    state.cuts.sourceBase64 = e.target.result.split(',')[1];
    render();
  };
  reader.readAsDataURL(file);
}

function buildExportHtml(analysis, sectionContents, sectionImages, extraSections, extraSectionContents, extraSectionImages) {
  let sectionsHtml = '';
  const renderSectionHtml = (s, content, img) => {
    const c = content.color_scheme || {};
    const f = content.font_suggestion || {};
    return `
    <section style="background:${c.background||'#FFFFFF'};padding:60px 20px;text-align:center;">
      <div style="max-width:860px;margin:0 auto;">
        <h2 style="font-size:${f.headline_size||'36px'};color:${c.text_primary||'#333'};margin-bottom:12px;font-weight:${f.headline_weight||'700'};">${content.headline||''}</h2>
        <h3 style="font-size:20px;color:${c.text_secondary||'#666'};margin-bottom:24px;font-weight:400;">${content.subheadline||''}</h3>
        ${img ? `<img src="${img}" alt="${s.name}" style="max-width:100%;border-radius:12px;margin:20px 0;">` : ''}
        <p style="font-size:${f.body_size||'16px'};color:${c.text_secondary||'#666'};line-height:1.8;max-width:680px;margin:0 auto;">${content.body_text||''}</p>
        ${content.extra_elements?.length ? `<div style="margin-top:20px;text-align:left;max-width:600px;margin:0 auto;">${content.extra_elements.map(e=>`<div style="padding:8px 0;color:${c.text_secondary||'#555'};font-size:14px;border-bottom:1px solid rgba(0,0,0,.05);">‚Ä¢ ${e}</div>`).join('')}</div>` : ''}
        ${content.cta_text ? `<a href="#" style="display:inline-block;margin-top:24px;padding:14px 40px;background:${c.accent||'#6366f1'};color:#fff;border-radius:8px;text-decoration:none;font-size:18px;font-weight:600;">${content.cta_text}</a>` : ''}
      </div>
    </section>`;
  };
  for (const s of SECTIONS) {
    const content = sectionContents[s.id];
    if (!content) continue;
    sectionsHtml += renderSectionHtml(s, content, sectionImages[s.id]);
  }
  // Ï∂îÍ∞Ä ÏÑπÏÖò Ìè¨Ìï®
  const exSecs = extraSections || state.extraSections || [];
  const exContents = extraSectionContents || state.extraSectionContents || {};
  const exImages = extraSectionImages || state.extraSectionImages || {};
  for (const s of exSecs) {
    const content = exContents[s.id];
    if (!content) continue;
    sectionsHtml += renderSectionHtml(s, content, exImages[s.id]);
  }
  return `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>${analysis.product_name||'ÏÉÅÏÑ∏ÌéòÏù¥ÏßÄ'}</title><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Noto Sans KR',sans-serif;color:#333}img{max-width:100%;height:auto}section{width:100%}</style></head><body>${sectionsHtml}</body></html>`;
}

function startAutomation() {
  if (state.auto.running) return;
  state.auto.running = true;
  autoLog('info', `ÏûêÎèôÌôî ÏãúÏûë (${state.auto.intervalMin}Î∂Ñ Í∞ÑÍ≤©)`);

  // Run immediately
  autoProcessOne();

  // Schedule
  state.auto.timerId = setInterval(() => {
    if (!state.auto.currentItem) { // Ïù¥Ï†Ñ ÏûëÏóÖ ÏôÑÎ£åÎêú Í≤ΩÏö∞Îßå
      const now = new Date();
      state.auto.nextRunAt = new Date(now.getTime() + state.auto.intervalMin * 60000).toLocaleTimeString('ko-KR');
      autoProcessOne();
    }
  }, state.auto.intervalMin * 60 * 1000);

  const now = new Date();
  state.auto.nextRunAt = new Date(now.getTime() + state.auto.intervalMin * 60000).toLocaleTimeString('ko-KR');
  render();
}

function stopAutomation() {
  state.auto.running = false;
  if (state.auto.timerId) {
    clearInterval(state.auto.timerId);
    state.auto.timerId = null;
  }
  state.auto.nextRunAt = null;
  autoLog('info', 'ÏûêÎèôÌôî Ï§ëÏßÄÎê®');
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BIND AUTOMATION EVENTS (add to bindEvents)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _origBind = bindEvents;
bindEvents = function() {
  _origBind();

  const connectBtn = document.getElementById('connectDriveBtn');
  if (connectBtn) connectBtn.onclick = connectDrive;

  const setInput = document.getElementById('setInputFolder');
  if (setInput) setInput.onclick = async () => {
    const raw = document.getElementById('inputFolderId')?.value.trim();
    if (!raw) return;
    const id = extractFolderId(raw);
    state.auto.inputFolderId = id;
    localStorage.setItem('auto_input_folder_id', id);
    autoLog('info', `ÏûÖÎ†• Ìè¥Îçî ID Ï∂îÏ∂ú: ${id}`);
    try {
      const name = await driveService.getFolderName(id);
      state.auto.inputFolderName = name;
      localStorage.setItem('auto_input_folder_name', name);
      autoLog('ok', `ÏûÖÎ†• Ìè¥Îçî ÏÑ§Ï†ï ÏôÑÎ£å: ${name}`);
    } catch(e) {
      state.auto.inputFolderName = id;
      autoLog('err', 'Ìè¥Îçî Ïù¥Î¶Ñ Ï°∞Ìöå Ïã§Ìå®: ' + e.message);
    }
    render();
  };

  const setOutput = document.getElementById('setOutputFolder');
  if (setOutput) setOutput.onclick = async () => {
    const raw = document.getElementById('outputFolderId')?.value.trim();
    if (!raw) return;
    const id = extractFolderId(raw);
    state.auto.outputFolderId = id;
    localStorage.setItem('auto_output_folder_id', id);
    autoLog('info', `Ï∂úÎ†• Ìè¥Îçî ID Ï∂îÏ∂ú: ${id}`);
    try {
      const name = await driveService.getFolderName(id);
      state.auto.outputFolderName = name;
      localStorage.setItem('auto_output_folder_name', name);
      autoLog('ok', `Ï∂úÎ†• Ìè¥Îçî ÏÑ§Ï†ï: ${name}`);
    } catch(e) {
      state.auto.outputFolderName = id;
      autoLog('err', 'Ìè¥Îçî Ïù¥Î¶Ñ Ï°∞Ìöå Ïã§Ìå®, IDÎ°ú ÏÑ§Ï†ïÎê®');
    }
    render();
  };

  const intervalSlider = document.getElementById('intervalSlider');
  if (intervalSlider) {
    intervalSlider.oninput = () => {
      const v = parseInt(intervalSlider.value);
      state.auto.intervalMin = v;
      localStorage.setItem('auto_interval', v);
      const disp = document.getElementById('intervalDisplay');
      if (disp) disp.textContent = v + 'Î∂Ñ';
    };
  }

  const startBtn = document.getElementById('startAutoBtn');
  if (startBtn) startBtn.onclick = startAutomation;

  const stopBtn = document.getElementById('stopAutoBtn');
  if (stopBtn) stopBtn.onclick = stopAutomation;

  const runOnce = document.getElementById('runOnceBtn');
  if (runOnce) runOnce.onclick = () => {
    autoLog('info', 'ÏàòÎèô 1Ìöå Ïã§Ìñâ');
    autoProcessOne();
  };

  const resetBtn = document.getElementById('resetProcessedBtn');
  if (resetBtn) resetBtn.onclick = () => {
    state.auto.processedFileIds.clear();
    localStorage.removeItem('auto_processed_ids');
    state.auto.totalProcessed = 0;
    localStorage.setItem('auto_total_processed', '0');
    state.auto.completed = [];
    localStorage.setItem('auto_completed', '[]');
    autoLog('info', 'Ï≤òÎ¶¨ Í∏∞Î°ù Ï¥àÍ∏∞ÌôîÎê®');
    render();
  };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BIND COMPETITOR & PLANNING EVENTS (add to bindEvents)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _origBind3 = bindEvents;
bindEvents = function() {
  _origBind3();

  // ‚îÄ‚îÄ Planning ÌôîÎ©¥ ‚îÄ‚îÄ
  const planVerAuto = document.getElementById('planVerifyAuto');
  if (planVerAuto) planVerAuto.onclick = () => { state.verificationMode = 'auto'; render(); };
  const planVerManual = document.getElementById('planVerifyManual');
  if (planVerManual) planVerManual.onclick = () => { state.verificationMode = 'manual'; render(); };

  const planRatio = document.getElementById('planRatioSlider');
  if (planRatio) planRatio.oninput = () => {
    const competitor = parseInt(planRatio.value, 10);
    state.referenceRatio = { competitor, own: 100 - competitor };
    try { localStorage.setItem('reference_ratio', JSON.stringify(state.referenceRatio)); } catch(e) {}
    const lbl = document.getElementById('planRatioLabel');
    if (lbl) lbl.textContent = `Í≤ΩÏüÅÏÇ¨ ${competitor}% / ÏûêÏ≤¥Î∂ÑÏÑù ${100 - competitor}%`;
  };

  const startWithSearch = document.getElementById('startWithSearch');
  if (startWithSearch) startWithSearch.onclick = () => searchCompetitors();

  const startWithoutSearch = document.getElementById('startWithoutSearch');
  if (startWithoutSearch) startWithoutSearch.onclick = () => {
    state.competitorData = null;
    state.step = 'sections';
    render();
  };

  // ‚îÄ‚îÄ Verifying ÌôîÎ©¥ ‚îÄ‚îÄ
  document.querySelectorAll('[data-verify-idx]').forEach(cb => {
    cb.onchange = () => {
      const idx = parseInt(cb.dataset.verifyIdx, 10);
      if (!state.verificationResult) state.verificationResult = [];
      if (cb.checked) {
        if (!state.verificationResult.includes(idx)) state.verificationResult.push(idx);
      } else {
        state.verificationResult = state.verificationResult.filter(i => i !== idx);
      }
      // ÎùºÎ≤® Î∞∞Í≤ΩÏÉâ Ï¶âÏãú Î∞òÏòÅ
      const label = cb.closest('label');
      if (label) {
        label.style.borderColor = cb.checked ? 'var(--primary)' : 'var(--border)';
        label.style.background = cb.checked ? 'var(--primary-dim)' : 'var(--bg-card)';
      }
    };
  });

  const confirmVerify = document.getElementById('confirmVerify');
  if (confirmVerify) confirmVerify.onclick = () => { state.step = 'sections'; render(); };

  const skipVerify = document.getElementById('skipVerify');
  if (skipVerify) skipVerify.onclick = () => {
    // Ï†ÑÏ≤¥ ÏÑ†ÌÉù
    state.verificationResult = state.scrapedProductList.map((_,i) => i);
    state.step = 'sections';
    render();
  };

  // ‚îÄ‚îÄ Sections ÌôîÎ©¥ ÎÇ¥ Í≤ÄÏ¶ù ÌÜ†Í∏Ä ‚îÄ‚îÄ
  const vAuto = document.getElementById('verifyModeAuto');
  if (vAuto) vAuto.onclick = () => { state.verificationMode = 'auto'; render(); };
  const vManual = document.getElementById('verifyModeManual');
  if (vManual) vManual.onclick = () => { state.verificationMode = 'manual'; render(); };

  // Ï∞∏Ï°∞ ÎπÑÏú® Ïä¨ÎùºÏù¥Îçî (sections ÌôîÎ©¥)
  const ratioSlider = document.getElementById('ratioSlider');
  if (ratioSlider) {
    ratioSlider.oninput = () => {
      const competitor = parseInt(ratioSlider.value, 10);
      state.referenceRatio = { competitor, own: 100 - competitor };
      try { localStorage.setItem('reference_ratio', JSON.stringify(state.referenceRatio)); } catch(e) {}
      const ratioLabel = document.getElementById('ratioLabel');
      if (ratioLabel) ratioLabel.textContent = `Í≤ΩÏüÅÏÇ¨ ${competitor}% / ÏûêÏ≤¥Î∂ÑÏÑù ${100 - competitor}%`;
    };
  }

  // Ï∂îÍ∞Ä ÏÑπÏÖò ÏÉùÏÑ± Î≤ÑÌäº
  const genExtra = document.getElementById('generateExtra');
  if (genExtra) genExtra.onclick = () => generateExtraSections();
  const genExtraPreview = document.getElementById('generateExtraFromPreview');
  if (genExtraPreview) genExtraPreview.onclick = () => generateExtraSections();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if (state.apiKey) {
  gemini = new GeminiAPI(state.apiKey);
}
// Try init Google auth if client ID exists
setTimeout(() => { try { initGoogleAuth(); } catch(e) {} }, 1000);
render();
</script>
</body>
</html>
