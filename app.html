<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìƒì„¸í˜ì´ì§€ ìë™ ìƒì„±ê¸°</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#6366f1;--primary-h:#818cf8;--primary-dim:rgba(99,102,241,.15);
  --bg:#0f0f13;--bg-card:#1a1a23;--bg-input:#13131a;
  --border:#2a2a36;--border-h:#3a3a4a;
  --text:#e4e4e7;--text-d:#9494a5;--text-m:#6b6b7b;
  --ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
  --cyan:#06b6d4;--orange:#f97316;
}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.fade-in{animation:fadeIn .3s ease-out}

/* Layout */
.app{display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;flex-shrink:0}
.logo{display:flex;align-items:center;gap:10px;padding:20px 16px;border-bottom:1px solid var(--border)}
.logo-icon{font-size:28px;color:var(--primary);font-weight:900}
.logo-text{font-weight:700;font-size:15px;line-height:1.3}
.logo-sub{font-weight:400;font-size:12px;color:var(--text-d)}
.nav{padding:12px 8px;display:flex;flex-direction:column;gap:2px;flex:1}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:.15s;color:var(--text-d);font-size:13px;border:none;background:none;width:100%;text-align:left;font-family:inherit}
.nav-item:hover{background:rgba(255,255,255,.03)}
.nav-item.active{background:var(--primary-dim);color:var(--primary-h)}
.nav-item.disabled{opacity:.4;cursor:not-allowed}
.main{flex:1;min-width:0;padding:24px 32px;overflow-y:auto}
.container{max-width:1100px;margin:0 auto}

/* Typography */
.page-title{font-size:26px;font-weight:800;margin-bottom:6px}
.page-desc{font-size:14px;color:var(--text-d);margin-bottom:24px}

/* Upload */
.upload-area{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;cursor:pointer;background:var(--bg-card);margin-bottom:24px;min-height:240px;display:flex;align-items:center;justify-content:center;transition:.2s}
.upload-area:hover{border-color:var(--primary);background:rgba(99,102,241,.03)}
.upload-area.has-image{border-style:solid;border-color:var(--border)}
.preview-img{max-height:300px;max-width:100%;border-radius:12px;object-fit:contain}

/* Form */
.input-group{margin-bottom:20px}
.label{display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:var(--text-d)}
.input,.textarea{width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;outline:none;font-family:inherit;transition:border .2s}
.input:focus,.textarea:focus{border-color:var(--primary)}
.textarea{resize:vertical;line-height:1.5;font-size:13px}

/* Buttons */
.btn-primary{display:inline-flex;align-items:center;gap:8px;padding:12px 28px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;transition:.15s}
.btn-primary:hover{background:var(--primary-h)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-sm{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;background:var(--bg-card);color:var(--text-d);border:1px solid var(--border);border-radius:6px;font-size:12px;cursor:pointer;font-family:inherit}
.btn-sm:hover{border-color:var(--border-h);color:var(--text)}

/* Cards */
.feature-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:40px}
.feature-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center}
.feature-card .mi{font-size:28px;color:var(--primary);margin-bottom:8px}
.feature-card h4{font-weight:600;font-size:14px;margin-bottom:4px}
.feature-card p{font-size:12px;color:var(--text-d)}

/* Analysis Summary */
.analysis-box{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:24px}
.tag{display:inline-block;padding:3px 10px;background:var(--primary-dim);color:var(--primary-h);border-radius:20px;font-size:11px;font-weight:500;margin:2px}

/* Section Cards */
.section-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:10px}
.section-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;cursor:pointer;transition:.15s}
.section-card:hover{border-color:var(--border-h);background:var(--bg-card)}
.section-card .head{display:flex;align-items:center;gap:12px}
.section-card .icon{font-size:28px}
.section-card .info{flex:1}
.section-card .info h4{font-weight:600;font-size:14px}
.section-card .info p{font-size:12px;color:var(--text-d);margin-top:2px}
.custom-badge{margin-top:8px;padding:6px 10px;background:var(--primary-dim);border-radius:6px;font-size:12px;color:var(--primary-h)}

/* Progress */
.progress-outer{width:100%;max-width:400px;height:24px;background:var(--bg-card);border-radius:12px;overflow:hidden;border:1px solid var(--border)}
.progress-inner{height:100%;background:linear-gradient(90deg,var(--primary),var(--cyan));border-radius:12px;transition:width .5s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:600;min-width:40px}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
.spinner-lg{width:64px;height:64px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
.gen-icons{margin-top:40px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.gen-icon{width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:var(--bg-card);border-radius:10px;font-size:22px;border:1px solid var(--border);transition:.3s}
.gen-icon.done{background:var(--primary-dim);border-color:var(--primary)}

/* Preview */
.preview-wrap{background:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
.section-ctrl{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--bg-card);border-bottom:1px solid var(--border)}
.section-ctrl .name{font-weight:600;font-size:13px}
.edit-panel{padding:12px 16px;background:var(--bg);border-bottom:1px solid var(--border)}

/* Error */
.error-bar{display:flex;align-items:center;gap:8px;padding:10px 16px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;color:var(--err);font-size:13px;margin-bottom:16px}

/* API Key Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:32px;max-width:480px;width:90%}
.modal h2{font-size:20px;margin-bottom:8px}
.modal p{font-size:13px;color:var(--text-d);margin-bottom:20px}

/* Image Cuts */
.cuts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.cut-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:10px;transition:.2s}
.cut-card.has-result{border-color:var(--primary)}
.cut-label{font-size:13px;font-weight:700;color:var(--primary)}
.cut-preview{width:100%;aspect-ratio:4/3;border-radius:8px;object-fit:cover;background:var(--bg-input);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--text-m);font-size:12px;overflow:hidden}
.cut-preview img{width:100%;height:100%;object-fit:cover}
.cut-spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;margin:auto}
.source-upload{border:2px dashed var(--border);border-radius:12px;padding:24px;text-align:center;cursor:pointer;background:var(--bg-card);transition:.2s;margin-bottom:20px}
.source-upload:hover{border-color:var(--primary)}
.placement-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.placement-row:last-child{border-bottom:none}
.placement-select{background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:4px 8px;font-size:12px;font-family:inherit;outline:none}
.cut-thumb{width:40px;height:40px;border-radius:6px;object-fit:cover;border:1px solid var(--border);background:var(--bg-input)}

/* Automation */
.auto-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px}
.auto-card h3{font-size:15px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.auto-status{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
.auto-status.running{background:rgba(34,197,94,.15);color:var(--ok)}
.auto-status.stopped{background:rgba(239,68,68,.15);color:var(--err)}
.auto-status.waiting{background:rgba(245,158,11,.15);color:var(--warn)}
.folder-pick{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:.15s;min-height:44px}
.folder-pick:hover{border-color:var(--primary)}
.folder-pick .name{flex:1;font-size:13px;color:var(--text)}
.folder-pick .placeholder{flex:1;font-size:13px;color:var(--text-m)}
.queue-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);font-size:13px}
.queue-item:last-child{border-bottom:none}
.queue-item .q-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.queue-item .q-status.pending{background:var(--text-m)}
.queue-item .q-status.processing{background:var(--warn);animation:pulse 1s infinite}
.queue-item .q-status.done{background:var(--ok)}
.queue-item .q-status.error{background:var(--err)}
.log-box{background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:12px;max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px;line-height:1.8}
.log-line{color:var(--text-d)}
.log-line.ok{color:var(--ok)}
.log-line.err{color:var(--err)}
.log-line.info{color:var(--cyan)}
.interval-slider{width:100%;accent-color:var(--primary)}

/* Responsive */
@media(max-width:900px){
  .feature-grid{grid-template-columns:repeat(2,1fr)}
  .section-grid{grid-template-columns:1fr}
  .sidebar{width:60px;overflow:hidden}
  .sidebar .logo-text,.sidebar .logo-sub,.sidebar .nav-item span:last-child{display:none}
}
</style>
</head>
<body>
<div id="app"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECTION DEFINITIONS (15 sections)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SECTIONS = [
  {n:1,name:"í—¤ë” (Header)",id:"header",purpose:"ì œí’ˆì„ ê¹”ë”í•œ í™”ì´íŠ¸í†¤ ë°°ê²½ìœ¼ë¡œ ê°•ì¡°. ì œí’ˆëª…ì„ ìƒë‹¨ì— í¬ê³  ì„íŒ©íŠ¸ ìˆê²Œ í‘œì‹œ.",desc:"í™”ì´íŠ¸ ë°°ê²½ + ì œí’ˆ ì¤‘ì•™ ë°°ì¹˜ + ì œí’ˆëª… ê°•ì¡°",icon:"ğŸ¯"},
  {n:2,name:"í›… (Hook)",id:"hook",purpose:"êµ¬ë§¤ ìš•êµ¬ë¥¼ ìê·¹í•˜ëŠ” ê°•ë ¬í•œ ë¹„ì£¼ì–¼ê³¼ ì¹´í”¼. ê³ ê°ì˜ í˜ì¸í¬ì¸íŠ¸ë¥¼ ê±´ë“œë¦¬ê³  ì œí’ˆì´ í•´ê²°ì±…ì„ì„ ì•”ì‹œ.",desc:"êµ¬ë§¤ ìš•êµ¬ ìê·¹ í›… ë©”ì‹œì§€ + ê°ì„± ì´ë¯¸ì§€",icon:"ğŸª"},
  {n:3,name:"í•µì‹¬ íŠ¹ì§• (Key Features)",id:"key_features",purpose:"ì œí’ˆì˜ í•µì‹¬ íŠ¹ì¥ì  3~5ê°€ì§€ë¥¼ ì•„ì´ì½˜/ì´ë¯¸ì§€ì™€ í•¨ê»˜ ëª…í™•í•˜ê²Œ ì „ë‹¬.",desc:"í•µì‹¬ íŠ¹ì¥ì  3~5ê°€ì§€ ì•„ì´ì½˜+í…ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ",icon:"â­"},
  {n:4,name:"ìƒì„¸ ìŠ¤í™ (Specifications)",id:"specifications",purpose:"ì œí’ˆì˜ ìƒì„¸ ì‚¬ì–‘, í¬ê¸°, ì¬ì§ˆ, ë¬´ê²Œ ë“± êµ¬ì²´ì ì¸ ì •ë³´ ì œê³µ.",desc:"ìƒì„¸ ì‚¬ì–‘ í…Œì´ë¸” + ì œí’ˆ ë””í…Œì¼ ì´ë¯¸ì§€",icon:"ğŸ“"},
  {n:5,name:"ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ (Use Scenarios)",id:"use_scenarios",purpose:"ë‹¤ì–‘í•œ ì‚¬ìš© ìƒí™©ì„ ë³´ì—¬ì£¼ì–´ ê³ ê°ì´ ìì‹ ì˜ ë¼ì´í”„ìŠ¤íƒ€ì¼ì—ì„œ ì œí’ˆì„ ìƒìƒí•  ìˆ˜ ìˆê²Œ í•¨.",desc:"ë¼ì´í”„ìŠ¤íƒ€ì¼ ì´ë¯¸ì§€ + ì‚¬ìš© ìƒí™© í…ìŠ¤íŠ¸",icon:"ğŸ "},
  {n:6,name:"ë¹„êµ ìš°ìœ„ (Competitive Edge)",id:"competitive_edge",purpose:"ê²½ìŸ ì œí’ˆ ëŒ€ë¹„ ìš°ìœ„ì ì„ ì‹œê°ì ìœ¼ë¡œ ë¹„êµ.",desc:"ê²½ìŸì‚¬ ëŒ€ë¹„ ë¹„êµí‘œ ë˜ëŠ” Before/After",icon:"ğŸ†"},
  {n:7,name:"ì†Œì¬/ê¸°ìˆ  (Material & Tech)",id:"material_tech",purpose:"ì‚¬ìš©ëœ ì†Œì¬ì˜ ìš°ìˆ˜ì„±ì´ë‚˜ íŠ¹í—ˆ ê¸°ìˆ  ë“±ì„ ì‹œê°ì ìœ¼ë¡œ ì„¤ëª….",desc:"ì†Œì¬/ê¸°ìˆ ë ¥ ê°•ì¡° ë‹¤í¬í†¤ ì„¹ì…˜",icon:"ğŸ”¬"},
  {n:8,name:"ì¸ì¦/ìˆ˜ìƒ (Certifications)",id:"certifications",purpose:"ì œí’ˆì´ ë°›ì€ ì¸ì¦, ìˆ˜ìƒ ë‚´ì—­, í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë“±ìœ¼ë¡œ ì‹ ë¢°ë„ êµ¬ì¶•.",desc:"ì¸ì¦ë§ˆí¬/ìˆ˜ìƒë‚´ì—­ ë°°ì§€ ë‚˜ì—´",icon:"ğŸ…"},
  {n:9,name:"ë¦¬ë·°/í›„ê¸° (Reviews)",id:"reviews",purpose:"ì‹¤ì œ ì‚¬ìš©ì í›„ê¸°ë¥¼ í™œìš©í•œ ì‚¬íšŒì  ì¦ê±°.",desc:"ê³ ê° ë¦¬ë·° ì¹´ë“œ ë ˆì´ì•„ì›ƒ",icon:"ğŸ’¬"},
  {n:10,name:"í¬ê¸°/ì»¬ëŸ¬ ê°€ì´ë“œ",id:"size_color",purpose:"ì‚¬ì´ì¦ˆ ì°¨íŠ¸, ì»¬ëŸ¬ ì˜µì…˜ ë“± ì„ íƒì— ë„ì›€ë˜ëŠ” ì •ë³´ ì œê³µ.",desc:"ì‚¬ì´ì¦ˆí‘œ + ì»¬ëŸ¬ ìŠ¤ì™€ì¹˜ ì˜µì…˜",icon:"ğŸ¨"},
  {n:11,name:"í”„ë¡œëª¨ì…˜ (Promotion)",id:"promotion",purpose:"íŠ¹ë³„ í• ì¸, ì„¸íŠ¸ êµ¬ì„±, ì‚¬ì€í’ˆ ë“± êµ¬ë§¤ ì´‰ì§„ ì´ë²¤íŠ¸ ì„¹ì…˜.",desc:"í• ì¸/ì´ë²¤íŠ¸/ì„¸íŠ¸ êµ¬ì„± í”„ë¡œëª¨ì…˜ ë°°ë„ˆ",icon:"ğŸ"},
  {n:12,name:"ë°°ì†¡/í¬ì¥ (Shipping)",id:"shipping",purpose:"ë°°ì†¡ ì •ë³´, í¬ì¥ ìƒíƒœ, ì–¸ë°•ì‹± ê²½í—˜ ë“±ì„ ë³´ì—¬ì¤Œ.",desc:"ë°°ì†¡ì •ë³´ + íŒ¨í‚¤ì§• ì´ë¯¸ì§€",icon:"ğŸ“¦"},
  {n:13,name:"FAQ (ìì£¼ ë¬»ëŠ” ì§ˆë¬¸)",id:"faq",purpose:"ê³ ê°ë“¤ì´ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ì„ ë¯¸ë¦¬ ë‹µë³€í•˜ì—¬ êµ¬ë§¤ ë¶ˆì•ˆ í•´ì†Œ.",desc:"ì•„ì½”ë””ì–¸ í˜•ì‹ FAQ ì„¹ì…˜",icon:"â“"},
  {n:14,name:"ë¸Œëœë“œ ìŠ¤í† ë¦¬",id:"brand_story",purpose:"ë¸Œëœë“œì˜ ì² í•™, ìŠ¤í† ë¦¬, ê°€ì¹˜ë¥¼ ì „ë‹¬í•˜ì—¬ ê°ì„±ì  ì—°ê²° í˜•ì„±.",desc:"ë¸Œëœë“œ ìŠ¤í† ë¦¬í…”ë§ ë‹¤í¬ ì„¹ì…˜",icon:"ğŸ“–"},
  {n:15,name:"CTA í‘¸í„° (Footer)",id:"cta_footer",purpose:"ìµœì¢… êµ¬ë§¤ ê²°ì •ì„ ìœ ë„í•˜ëŠ” ê°•ë ¥í•œ CTA.",desc:"ìµœì¢… CTA + ê°€ê²© + êµ¬ë§¤ë²„íŠ¼",icon:"ğŸ›’"},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEMINI API SERVICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class GeminiAPI {
  constructor(apiKey) {
    this.apiKey = apiKey;
    this.baseUrl = 'https://generativelanguage.googleapis.com/v1beta';
  }

  async analyzeImage(imageBase64, mimeType) {
    const prompt = `You are a professional e-commerce product analyst. Analyze this product image in extreme detail.
Return a JSON object with the following fields:
{
    "product_name": "detected product name in Korean",
    "product_name_en": "detected product name in English",
    "category": "product category",
    "brand": "brand name if visible",
    "colors": ["list of colors detected"],
    "materials": ["detected or estimated materials"],
    "shape": "product shape description",
    "size_estimate": "estimated size",
    "key_features": ["list of 5-10 key features"],
    "target_audience": "target customer demographic",
    "price_range_estimate": "estimated price range in KRW",
    "mood": "overall mood/aesthetic of the product",
    "use_cases": ["list of use cases"],
    "selling_points": ["list of unique selling points"],
    "style_keywords": ["style-related keywords for design"],
    "complementary_colors": ["colors that complement the product"],
    "text_color_recommendation": "recommended text color for overlay",
    "detailed_description": "A detailed Korean description for marketing"
}
Respond ONLY with the JSON object, no other text.`;

    const body = {
      contents: [{
        parts: [
          { text: prompt },
          { inline_data: { mime_type: mimeType, data: imageBase64 } }
        ]
      }],
      generationConfig: { temperature: 0.3, maxOutputTokens: 4096 }
    };

    const res = await fetch(`${this.baseUrl}/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    let text = data.candidates[0].content.parts[0].text.trim();
    text = text.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'');
    return JSON.parse(text);
  }

  async generateSectionContent(sectionDef, productAnalysis, customInstructions, competitorRef) {
    const prompt = `You are a Korean e-commerce detail page content creator.

Product Analysis:
${JSON.stringify(productAnalysis, null, 2)}

${competitorRef ? 'Competitor Reference: ' + competitorRef : ''}

Section to create: ${sectionDef.name}
Section number: ${sectionDef.n}
Section purpose: ${sectionDef.purpose}
User custom instructions: ${customInstructions || 'None'}

Based on the product analysis, generate content for this section.
Return a JSON object:
{
    "headline": "Main headline text in Korean (impactful, short)",
    "subheadline": "Sub headline in Korean",
    "body_text": "Body copy in Korean (2-3 sentences)",
    "cta_text": "Call to action text if applicable, or empty string",
    "layout_suggestion": "Layout recommendation",
    "color_scheme": {
        "background": "#hex",
        "text_primary": "#hex",
        "text_secondary": "#hex",
        "accent": "#hex"
    },
    "font_suggestion": {
        "headline_font": "Noto Sans KR",
        "headline_size": "px value like 42px",
        "headline_weight": "700 or 900",
        "body_font": "Noto Sans KR",
        "body_size": "px value like 16px"
    },
    "image_description": "Detailed description of what the section image should look like",
    "product_placement": "Description of how the product image should be placed",
    "design_notes": "Additional design recommendations",
    "extra_elements": ["list of bullet points or features if applicable"]
}
Respond ONLY with the JSON object.`;

    const body = {
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
    };

    const res = await fetch(`${this.baseUrl}/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    let text = data.candidates[0].content.parts[0].text.trim();
    text = text.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'');
    return JSON.parse(text);
  }

  async generateImage(prompt, productImageBase64, mimeType) {
    const parts = [
      { text: `Create a professional Korean e-commerce product detail page section image. ${prompt} Style: clean, modern, high-end Korean shopping mall aesthetic. Size: 860px wide.` }
    ];
    if (productImageBase64) {
      parts.push({ inline_data: { mime_type: mimeType, data: productImageBase64 } });
    }

    const body = {
      contents: [{ parts }],
      generationConfig: {
        temperature: 0.8,
        responseModalities: ["TEXT", "IMAGE"]
      }
    };

    try {
      const res = await fetch(`${this.baseUrl}/models/gemini-3-pro-image-preview:generateContent?key=${this.apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error.message);

      for (const part of data.candidates[0].content.parts) {
        if (part.inlineData && part.inlineData.mimeType?.startsWith('image/')) {
          return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
        }
        if (part.inline_data && part.inline_data.mime_type?.startsWith('image/')) {
          return `data:${part.inline_data.mime_type};base64,${part.inline_data.data}`;
        }
      }
      return null;
    } catch (e) {
      console.warn('Image generation failed:', e.message);
      return null;
    }
  }

  async searchSimilarProducts(productName, category) {
    // Use Gemini to generate competitor analysis since we can't call SerpAPI from browser
    const prompt = `You are a Korean e-commerce market analyst.
For the product "${productName}" in the category "${category}", provide competitor analysis.
Return a JSON object:
{
    "similar_products": [
        {"name": "product name", "price_range": "price", "strengths": "key strength", "detail_page_style": "description of their detail page approach"}
    ],
    "market_insights": "brief market analysis in Korean",
    "detail_page_trends": ["list of current detail page design trends for this category"],
    "recommended_approach": "recommended detail page strategy in Korean"
}
List 5-8 competitor products. Respond ONLY with JSON.`;

    const body = {
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.5, maxOutputTokens: 2048 }
    };

    const res = await fetch(`${this.baseUrl}/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    let text = data.candidates[0].content.parts[0].text.trim();
    text = text.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'');
    return JSON.parse(text);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSISTENT STORAGE (works on file:// too)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveKey(key) {
  try { localStorage.setItem('gemini_api_key', key); } catch(e) {}
  try { document.cookie = `gemini_api_key=${encodeURIComponent(key)};max-age=31536000;path=/;SameSite=Lax`; } catch(e) {}
}
function loadKey() {
  let k = '';
  try { k = localStorage.getItem('gemini_api_key') || ''; } catch(e) {}
  if (!k) {
    try {
      const m = document.cookie.match(/gemini_api_key=([^;]+)/);
      if (m) k = decodeURIComponent(m[1]);
    } catch(e) {}
  }
  return k;
}

// ì„¹ì…˜ë³„ ì§€ì‹œì‚¬í•­ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
function saveSectionInstructions(instructions) {
  try { localStorage.setItem('section_instructions', JSON.stringify(instructions)); } catch(e) {}
}
function loadSectionInstructions() {
  try {
    const raw = localStorage.getItem('section_instructions');
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return {};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _savedKey = loadKey();
const _savedInstructions = loadSectionInstructions();
const state = {
  step: 'upload', // upload | analyzing | sections | generating | preview
  apiKey: _savedKey,
  showApiModal: !_savedKey,
  productName: '',
  imagePreview: null,
  imageBase64: null,
  imageMime: null,
  analysis: null,
  competitorData: null,
  sectionInstructions: _savedInstructions,
  sectionContents: {},
  sectionImages: {},
  progress: 0,
  progressMsg: '',
  error: '',
  activeSectionEdit: null,
  editingPreviewSection: null,
  // â”€â”€ Image Cuts â”€â”€
  cuts: {
    sourceBase64: null,
    sourceMime: null,
    sourcePreview: null,
    prompts: JSON.parse(localStorage.getItem('cuts_prompts') || JSON.stringify([
      { id:'cut1', label:'ì»· 1', prompt:'', result:null, generating:false },
      { id:'cut2', label:'ì»· 2', prompt:'', result:null, generating:false },
      { id:'cut3', label:'ì»· 3', prompt:'', result:null, generating:false },
      { id:'cut4', label:'ì»· 4', prompt:'', result:null, generating:false },
    ])),
    // ìƒì„¸í˜ì´ì§€ ì„¹ì…˜ ë°°ì¹˜: { sectionId: cutId }
    placement: JSON.parse(localStorage.getItem('cuts_placement') || '{}'),
  },
  // â”€â”€ Automation â”€â”€
  auto: {
    driveConnected: false,
    accessToken: null,
    gdClientId: localStorage.getItem('gd_client_id') || '',
    inputFolderId: localStorage.getItem('auto_input_folder_id') || '',
    inputFolderName: localStorage.getItem('auto_input_folder_name') || '',
    outputFolderId: localStorage.getItem('auto_output_folder_id') || '',
    outputFolderName: localStorage.getItem('auto_output_folder_name') || '',
    intervalMin: parseInt(localStorage.getItem('auto_interval') || '20'),
    running: false,
    queue: [],
    completed: JSON.parse(localStorage.getItem('auto_completed') || '[]'),
    currentItem: null,
    currentProgress: 0,
    currentMsg: '',
    timerId: null,
    nextRunAt: null,
    totalProcessed: parseInt(localStorage.getItem('auto_total_processed') || '0'),
    processedFileIds: new Set(JSON.parse(localStorage.getItem('auto_processed_ids') || '[]')),
  },
};

let gemini = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const app = document.getElementById('app');
  app.innerHTML = `
    ${state.showApiModal ? renderApiModal() : ''}
    <div class="app">
      ${renderSidebar()}
      <main class="main">
        <div class="container">
          ${state.error ? renderError() : ''}
          ${state.step === 'upload' ? renderUpload() : ''}
          ${state.step === 'analyzing' ? renderAnalyzing() : ''}
          ${state.step === 'sections' ? renderSections() : ''}
          ${state.step === 'generating' ? renderGenerating() : ''}
          ${state.step === 'preview' ? renderPreview() : ''}
          ${state.step === 'imagecuts' ? renderImageCuts() : ''}
          ${state.step === 'automation' ? renderAutomation() : ''}
        </div>
      </main>
    </div>
  `;
  bindEvents();
}

function renderApiModal() {
  const hasSaved = !!state.apiKey;
  return `<div class="modal-overlay" id="apiModal">
    <div class="modal">
      <h2>ğŸ”‘ API í‚¤ ì„¤ì •</h2>
      <p>Google Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--primary)">ì—¬ê¸°ì„œ ë°œê¸‰</a> ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      ${hasSaved ? '<p style="margin-top:-12px;margin-bottom:12px;font-size:12px;color:var(--ok)">âœ… ì´ì „ì— ì €ì¥í•œ API í‚¤ê°€ ìˆìŠµë‹ˆë‹¤.</p>' : ''}
      <div class="input-group">
        <label class="label">Gemini API Key</label>
        <div style="position:relative">
          <input type="text" class="input" id="apiKeyInput" value="${state.apiKey}" placeholder="AIza..." style="padding-right:40px;font-family:monospace;font-size:13px">
          <span class="material-icons-outlined" id="toggleKeyVis" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:var(--text-m)">visibility</span>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-primary" id="saveApiKey">
          <span class="material-icons-outlined" style="font-size:18px">save</span>
          ì €ì¥ í›„ ì‹œì‘
        </button>
        ${hasSaved ? '<button class="btn-sm" id="skipApiModal" style="padding:12px 20px">ê¸°ì¡´ í‚¤ë¡œ ê³„ì†</button>' : ''}
      </div>
    </div>
  </div>`;
}

function renderSidebar() {
  const items = [
    {icon:'upload_file',label:'ì´ë¯¸ì§€ ì—…ë¡œë“œ',step:'upload',always:true},
    {icon:'analytics',label:'AI ë¶„ì„',step:'analyzing',need:'analysis'},
    {icon:'dashboard_customize',label:'ì„¹ì…˜ ì„¤ì •',step:'sections',need:'analysis'},
    {icon:'auto_fix_high',label:'ìë™ ìƒì„±',step:'generating',need:'analysis'},
    {icon:'preview',label:'ë¯¸ë¦¬ë³´ê¸°',step:'preview',need:'preview'},
    {icon:'auto_awesome',label:'ì´ë¯¸ì§€ì»· ìƒì„±',step:'imagecuts',always:true},
    {icon:'cloud_sync',label:'ìë™í™”',step:'automation',always:true},
  ];
  return `<aside class="sidebar">
    <div class="logo">
      <span class="logo-icon">âœ¦</span>
      <div><span class="logo-text">ìƒì„¸í˜ì´ì§€</span><br><span class="logo-sub">Auto Generator</span></div>
    </div>
    <nav class="nav">
      ${items.map(it => {
        const active = state.step === it.step;
        const disabled = !it.always && it.need === 'analysis' && !state.analysis && state.step !== it.step;
        const disabledPreview = it.need === 'preview' && Object.keys(state.sectionContents).length === 0;
        return `<button class="nav-item ${active?'active':''} ${disabled||disabledPreview?'disabled':''}" data-nav="${it.step}">
          <span class="material-icons-outlined" style="font-size:20px">${it.icon}</span>
          <span>${it.label}</span>
        </button>`;
      }).join('')}
    </nav>
    <div style="padding:12px 16px;border-top:1px solid var(--border)">
      <button class="btn-sm" id="changeApiKey" style="width:100%;justify-content:center">
        <span class="material-icons-outlined" style="font-size:14px">key</span> API í‚¤ ë³€ê²½
      </button>
    </div>
  </aside>`;
}

function renderError() {
  return `<div class="error-bar">
    <span class="material-icons-outlined" style="font-size:18px">error_outline</span>
    <span style="flex:1">${state.error}</span>
    <span class="material-icons-outlined" style="font-size:18px;cursor:pointer" id="closeError">close</span>
  </div>`;
}

function renderUpload() {
  return `<div class="fade-in">
    <h1 class="page-title">ìƒì„¸í˜ì´ì§€ ìë™ ìƒì„±</h1>
    <p class="page-desc">ì œí’ˆ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ AIê°€ ë¶„ì„í•˜ì—¬ 15ê°œ ì„¹ì…˜ì˜ ìƒì„¸í˜ì´ì§€ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.</p>

    <div class="upload-area ${state.imagePreview?'has-image':''}" id="uploadArea">
      ${state.imagePreview
        ? `<img src="${state.imagePreview}" class="preview-img" alt="preview">`
        : `<div style="display:flex;flex-direction:column;align-items:center">
            <span class="material-icons-outlined" style="font-size:48px;color:var(--primary);margin-bottom:12px">cloud_upload</span>
            <p style="font-size:16px;font-weight:500">í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ</p>
            <p style="font-size:13px;color:var(--text-m);margin-top:6px">JPG, PNG, WEBP ì§€ì› (ìµœëŒ€ 50MB)</p>
          </div>`
      }
      <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>

    <div class="input-group">
      <label class="label">ì œí’ˆëª… (ì„ íƒì‚¬í•­)</label>
      <input type="text" class="input" id="productNameInput" value="${state.productName}" placeholder="AIê°€ ìë™ ê°ì§€í•˜ì§€ë§Œ, ì§ì ‘ ì…ë ¥í•˜ë©´ ë” ì •í™•í•©ë‹ˆë‹¤">
    </div>

    <button class="btn-primary" id="startAnalysis" ${!state.imagePreview?'disabled':''}>
      <span class="material-icons-outlined" style="font-size:20px">auto_fix_high</span>
      AI ë¶„ì„ ì‹œì‘
    </button>

    <div class="feature-grid">
      <div class="feature-card"><div class="mi material-icons-outlined">visibility</div><h4>ì´ë¯¸ì§€ ë¶„ì„</h4><p>Gemini AIê°€ ì œí’ˆ íŠ¹ì§•ì„ ìë™ ë¶„ì„</p></div>
      <div class="feature-card"><div class="mi material-icons-outlined">search</div><h4>ê²½ìŸ ë¶„ì„</h4><p>ìœ ì‚¬ ì œí’ˆì˜ ìƒì„¸í˜ì´ì§€ ì°¸ì¡° ê²€ìƒ‰</p></div>
      <div class="feature-card"><div class="mi material-icons-outlined">dashboard</div><h4>15ì„¹ì…˜ ìë™ìƒì„±</h4><p>í—¤ë”ë¶€í„° CTAê¹Œì§€ í’€ ìƒì„¸í˜ì´ì§€</p></div>
      <div class="feature-card"><div class="mi material-icons-outlined">image</div><h4>ì´ë¯¸ì§€ ìƒì„±</h4><p>ê° ì„¹ì…˜ì— ë§ëŠ” ì´ë¯¸ì§€ AI ìƒì„±</p></div>
    </div>
  </div>`;
}

function renderAnalyzing() {
  return `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh">
    <div class="spinner-lg"></div>
    <h2 style="font-size:22px;margin-top:24px;margin-bottom:8px">AI ë¶„ì„ ì§„í–‰ ì¤‘</h2>
    <p style="color:var(--text-d);margin-bottom:24px">${state.progressMsg}</p>
    <div class="progress-outer"><div class="progress-inner" style="width:${state.progress}%">${state.progress}%</div></div>
  </div>`;
}

function renderSections() {
  const a = state.analysis;
  return `<div class="fade-in">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">
      <div>
        <h1 class="page-title">ì„¹ì…˜ë³„ ì„¤ì •</h1>
        <p class="page-desc">ê° ì„¹ì…˜ì— ì›í•˜ëŠ” ì§€ì‹œì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”. ë¹„ì›Œë‘ë©´ AIê°€ ìë™ìœ¼ë¡œ ìµœì ì˜ ì½˜í…ì¸ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
      </div>
      <button class="btn-primary" id="generateAll">
        <span class="material-icons-outlined" style="font-size:20px">rocket_launch</span>
        ì „ì²´ ìƒì„± ì‹œì‘
      </button>
    </div>

    ${a ? `<div class="analysis-box">
      <div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap">
        ${state.imagePreview ? `<img src="${state.imagePreview}" style="width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid var(--border)">` : ''}
        <div style="flex:1;min-width:200px">
          <h3 style="font-size:18px;font-weight:700">${a.product_name||'ë¶„ì„ëœ ì œí’ˆ'}</h3>
          <p style="font-size:13px;color:var(--text-d);margin-top:4px">${a.category||''} ${a.mood?'| '+a.mood:''}</p>
          <div style="margin-top:8px">${(a.key_features||[]).slice(0,5).map(f=>`<span class="tag">${f}</span>`).join('')}</div>
        </div>
      </div>
      ${state.competitorData ? `<div style="margin-top:16px;padding:12px 16px;background:var(--bg);border-radius:8px;font-size:13px">
        <span style="color:var(--text-m)">ê²½ìŸ ë¶„ì„:</span>
        <span style="color:var(--cyan)">${state.competitorData.similar_products?.length||0}ê°œ ìœ ì‚¬ ì œí’ˆ ë¶„ì„ë¨</span>
        ${state.competitorData.recommended_approach ? `<br><span style="color:var(--text-d);margin-top:4px;display:block">${state.competitorData.recommended_approach}</span>` : ''}
      </div>` : ''}
    </div>` : ''}

    <div class="section-grid">
      ${SECTIONS.map(s => `
        <div class="section-card" data-section-toggle="${s.id}">
          <div class="head">
            <span class="icon">${s.icon}</span>
            <div class="info">
              <h4>${s.n}. ${s.name}</h4>
              <p>${s.desc}</p>
            </div>
            <span class="material-icons-outlined" style="color:var(--text-m);font-size:20px">${state.activeSectionEdit===s.id?'expand_less':'expand_more'}</span>
          </div>
          ${state.activeSectionEdit===s.id ? `<div style="margin-top:12px" onclick="event.stopPropagation()">
            <textarea class="textarea" data-section-input="${s.id}" rows="3" placeholder="ì´ ì„¹ì…˜ì— ì›í•˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...\nì˜ˆ: ${s.purpose}">${state.sectionInstructions[s.id]||''}</textarea>
          </div>` : ''}
          ${state.sectionInstructions[s.id] && state.activeSectionEdit!==s.id ? `<div class="custom-badge">âœ ì»¤ìŠ¤í…€ ì§€ì‹œì‚¬í•­ ì…ë ¥ë¨</div>` : ''}
        </div>
      `).join('')}
    </div>

    <div style="text-align:center;margin-top:32px">
      <button class="btn-primary" id="generateAll2" style="padding:16px 48px;font-size:16px">
        <span class="material-icons-outlined" style="font-size:22px">rocket_launch</span>
        15ê°œ ì„¹ì…˜ ì¼ê´„ ìƒì„± ì‹œì‘
      </button>
    </div>
  </div>`;
}

function renderGenerating() {
  const icons = SECTIONS.map(s=>s.icon);
  const doneCount = Object.keys(state.sectionContents).length;
  return `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh">
    <div class="spinner-lg"></div>
    <h2 style="font-size:24px;margin-top:32px;margin-bottom:8px">ìƒì„¸í˜ì´ì§€ ìƒì„± ì¤‘</h2>
    <p style="color:var(--text-d);margin-bottom:24px;text-align:center">${state.progressMsg}</p>
    <div class="progress-outer"><div class="progress-inner" style="width:${state.progress}%">${state.progress}%</div></div>
    <p style="font-size:12px;color:var(--text-m);margin-top:16px">15ê°œ ì„¹ì…˜ Ã— (ì½˜í…ì¸  + ì´ë¯¸ì§€) ìƒì„± ì¤‘ â€” Gemini API í˜¸ì¶œ</p>
    <div class="gen-icons">
      ${icons.map((ic,i) => `<div class="gen-icon ${i<doneCount?'done':''}">${ic}</div>`).join('')}
    </div>
  </div>`;
}

function renderPreview() {
  return `<div class="fade-in">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">
      <div>
        <h1 class="page-title">ìƒì„¸í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸°</h1>
        <p class="page-desc">ìƒì„±ëœ ìƒì„¸í˜ì´ì§€ë¥¼ í™•ì¸í•˜ê³  ê°œë³„ ì„¹ì…˜ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-primary" id="exportHTML">
          <span class="material-icons-outlined" style="font-size:18px">download</span>
          HTML ë‚´ë³´ë‚´ê¸°
        </button>
      </div>
    </div>

    <div class="preview-wrap">
      ${SECTIONS.map(s => {
        const content = state.sectionContents[s.id];
        if (!content) return `<div style="padding:20px;text-align:center;color:var(--text-m);border-bottom:1px solid var(--border)">
          <span>${s.icon} ${s.n}. ${s.name} - ë¯¸ìƒì„±</span>
        </div>`;

        const c = content.color_scheme || {};
        const f = content.font_suggestion || {};
        const img = state.sectionImages[s.id];
        const isEditing = state.editingPreviewSection === s.id;

        return `
          <div style="position:relative">
            <div class="section-ctrl">
              <span style="font-size:16px">${s.icon}</span>
              <span class="name">${s.n}. ${s.name}</span>
              <div style="flex:1"></div>
              <button class="btn-sm" data-edit-preview="${s.id}">
                <span class="material-icons-outlined" style="font-size:16px">edit</span> ìˆ˜ì •
              </button>
              <button class="btn-sm" data-regen="${s.id}">
                <span class="material-icons-outlined" style="font-size:16px">refresh</span> ì¬ìƒì„±
              </button>
            </div>
            ${isEditing ? `<div class="edit-panel" onclick="event.stopPropagation()">
              <textarea class="textarea" data-edit-input="${s.id}" rows="2" placeholder="ì´ ì„¹ì…˜ì— ëŒ€í•œ ìˆ˜ì • ì§€ì‹œì‚¬í•­...">${state.sectionInstructions[s.id]||''}</textarea>
              <button class="btn-sm" style="margin-top:8px" data-apply-edit="${s.id}">ì§€ì‹œì‚¬í•­ ì ìš© í›„ ì¬ìƒì„±</button>
            </div>` : ''}
            <div style="background:${c.background||'#FFFFFF'};padding:48px 20px;text-align:center">
              <div style="max-width:860px;margin:0 auto">
                <h2 style="font-size:${f.headline_size||'36px'};color:${c.text_primary||'#333'};font-weight:${f.headline_weight||'700'};margin-bottom:10px">
                  ${content.headline || `[${s.name}]`}
                </h2>
                <h3 style="font-size:18px;color:${c.text_secondary||'#666'};font-weight:400;margin-bottom:20px">
                  ${content.subheadline || ''}
                </h3>
                ${img ? `<img src="${img}" alt="${s.name}" style="max-width:100%;border-radius:12px;margin-bottom:20px">` : ''}
                <p style="font-size:${f.body_size||'16px'};color:${c.text_secondary||'#666'};line-height:1.8;max-width:680px;margin:0 auto">
                  ${content.body_text || ''}
                </p>
                ${content.extra_elements?.length ? `<div style="margin-top:20px;text-align:left;max-width:600px;margin-left:auto;margin-right:auto">
                  ${content.extra_elements.map(e => `<div style="padding:8px 0;color:${c.text_secondary||'#555'};font-size:14px;border-bottom:1px solid rgba(0,0,0,.05)">â€¢ ${e}</div>`).join('')}
                </div>` : ''}
                ${content.cta_text ? `<div style="display:inline-block;margin-top:20px;padding:12px 36px;background:${c.accent||'#6366f1'};color:#fff;border-radius:8px;font-weight:600;font-size:16px">${content.cta_text}</div>` : ''}
              </div>
            </div>
          </div>`;
      }).join('')}
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENT BINDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bindEvents() {
  // API Key modal
  const saveBtn = document.getElementById('saveApiKey');
  if (saveBtn) {
    saveBtn.onclick = () => {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (!key) return;
      state.apiKey = key;
      saveKey(key);
      gemini = new GeminiAPI(key);
      state.showApiModal = false;
      render();
    };
  }

  const skipBtn = document.getElementById('skipApiModal');
  if (skipBtn) {
    skipBtn.onclick = () => {
      gemini = new GeminiAPI(state.apiKey);
      state.showApiModal = false;
      render();
    };
  }

  const toggleVis = document.getElementById('toggleKeyVis');
  if (toggleVis) {
    toggleVis.onclick = () => {
      const inp = document.getElementById('apiKeyInput');
      if (inp.type === 'text') { inp.type = 'password'; toggleVis.textContent = 'visibility'; }
      else { inp.type = 'text'; toggleVis.textContent = 'visibility_off'; }
    };
  }

  const changeApiBtn = document.getElementById('changeApiKey');
  if (changeApiBtn) {
    changeApiBtn.onclick = () => { state.showApiModal = true; render(); };
  }

  // Navigation
  document.querySelectorAll('[data-nav]').forEach(btn => {
    btn.onclick = () => {
      if (btn.classList.contains('disabled')) return;
      const target = btn.dataset.nav;
      if (target === 'preview' && Object.keys(state.sectionContents).length === 0) return;
      state.step = target;
      render();
    };
  });

  // Error close
  const closeErr = document.getElementById('closeError');
  if (closeErr) closeErr.onclick = () => { state.error = ''; render(); };

  // File upload
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  if (uploadArea) {
    uploadArea.onclick = () => fileInput.click();
    uploadArea.ondragover = (e) => e.preventDefault();
    uploadArea.ondrop = (e) => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) handleFile(file);
    };
  }
  if (fileInput) {
    fileInput.onchange = (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); };
  }

  // Product name
  const nameInput = document.getElementById('productNameInput');
  if (nameInput) nameInput.oninput = (e) => { state.productName = e.target.value; };

  // Start analysis
  const startBtn = document.getElementById('startAnalysis');
  if (startBtn) startBtn.onclick = startAnalysis;

  // Generate all
  const genAll = document.getElementById('generateAll');
  const genAll2 = document.getElementById('generateAll2');
  if (genAll) genAll.onclick = generateAllSections;
  if (genAll2) genAll2.onclick = generateAllSections;

  // Section toggles
  document.querySelectorAll('[data-section-toggle]').forEach(el => {
    el.onclick = () => {
      const id = el.dataset.sectionToggle;
      state.activeSectionEdit = state.activeSectionEdit === id ? null : id;
      render();
    };
  });

  // Section instruction inputs
  document.querySelectorAll('[data-section-input]').forEach(el => {
    el.oninput = (e) => { state.sectionInstructions[el.dataset.sectionInput] = e.target.value; saveSectionInstructions(state.sectionInstructions); };
    el.onclick = (e) => e.stopPropagation();
  });

  // Preview edit
  document.querySelectorAll('[data-edit-preview]').forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.editPreview;
      state.editingPreviewSection = state.editingPreviewSection === id ? null : id;
      render();
    };
  });

  // Regenerate section
  document.querySelectorAll('[data-regen]').forEach(btn => {
    btn.onclick = () => regenerateSection(btn.dataset.regen);
  });

  // Apply edit
  document.querySelectorAll('[data-apply-edit]').forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.applyEdit;
      const textarea = document.querySelector(`[data-edit-input="${id}"]`);
      if (textarea) state.sectionInstructions[id] = textarea.value;
      saveSectionInstructions(state.sectionInstructions);
      state.editingPreviewSection = null;
      regenerateSection(id);
    };
  });

  // Edit input
  document.querySelectorAll('[data-edit-input]').forEach(el => {
    el.oninput = (e) => { state.sectionInstructions[el.dataset.editInput] = e.target.value; saveSectionInstructions(state.sectionInstructions); };
  });

  // Export
  const exportBtn = document.getElementById('exportHTML');
  if (exportBtn) exportBtn.onclick = exportHTML;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleFile(file) {
  state.imageMime = file.type;
  const reader = new FileReader();
  reader.onload = (e) => {
    state.imagePreview = e.target.result;
    state.imageBase64 = e.target.result.split(',')[1];
    render();
  };
  reader.readAsDataURL(file);
}

async function startAnalysis() {
  if (!state.imageBase64) { state.error = 'ì œí’ˆ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.'; render(); return; }
  if (!state.apiKey) { state.showApiModal = true; render(); return; }

  gemini = gemini || new GeminiAPI(state.apiKey);
  state.error = '';
  state.step = 'analyzing';
  state.progress = 10;
  state.progressMsg = 'ì œí’ˆ ì´ë¯¸ì§€ AI ë¶„ì„ ì¤‘...';
  render();

  try {
    // 1. Analyze image
    const analysis = await gemini.analyzeImage(state.imageBase64, state.imageMime);
    if (state.productName) analysis.product_name = state.productName;
    state.analysis = analysis;
    state.progress = 25;
    state.progressMsg = 'ìœ ì‚¬ ì œí’ˆ ê²€ìƒ‰ ì¤‘...';
    render();

    // 2. Competitor search
    try {
      const competitors = await gemini.searchSimilarProducts(
        analysis.product_name || analysis.product_name_en,
        analysis.category
      );
      state.competitorData = competitors;
    } catch (e) {
      state.competitorData = null;
    }

    state.progress = 35;
    state.step = 'sections';
    state.progressMsg = 'ë¶„ì„ ì™„ë£Œ!';
    render();
  } catch (e) {
    state.error = `ë¶„ì„ ì‹¤íŒ¨: ${e.message}`;
    state.step = 'upload';
    render();
  }
}

async function generateAllSections() {
  state.step = 'generating';
  state.progress = 35;
  state.sectionContents = {};
  state.sectionImages = {};
  render();

  const total = SECTIONS.length;
  const compRef = state.competitorData ? JSON.stringify(state.competitorData).substring(0, 1000) : '';

  for (let i = 0; i < total; i++) {
    const s = SECTIONS[i];
    const pct = Math.round(35 + ((i / total) * 60));
    state.progress = pct;
    state.progressMsg = `[${i+1}/${total}] ${s.name} ì½˜í…ì¸  ìƒì„± ì¤‘...`;
    render();

    try {
      // Generate content
      const content = await gemini.generateSectionContent(
        s, state.analysis, state.sectionInstructions[s.id] || '', compRef
      );
      state.sectionContents[s.id] = content;

      // Try to generate image
      state.progressMsg = `[${i+1}/${total}] ${s.name} ì´ë¯¸ì§€ ìƒì„± ì¤‘...`;
      render();

      try {
        const imgPrompt = content.image_description || content.design_notes || s.purpose;
        const img = await gemini.generateImage(imgPrompt, state.imageBase64, state.imageMime);
        if (img) state.sectionImages[s.id] = img;
      } catch (e) {
        console.warn(`Image gen failed for ${s.id}:`, e);
      }

    } catch (e) {
      console.error(`Section ${s.id} failed:`, e);
      state.sectionContents[s.id] = {
        headline: s.name,
        subheadline: 'ìƒì„± ì‹¤íŒ¨ - ì¬ì‹œë„í•´ì£¼ì„¸ìš”',
        body_text: e.message,
        color_scheme: { background: '#FFF5F5', text_primary: '#C53030', text_secondary: '#E53E3E', accent: '#FC8181' },
        font_suggestion: { headline_size: '32px', body_size: '14px' }
      };
    }

    // Small delay for rate limiting
    await new Promise(r => setTimeout(r, 500));
  }

  state.progress = 100;
  state.progressMsg = 'ëª¨ë“  ì„¹ì…˜ ìƒì„± ì™„ë£Œ!';
  state.step = 'preview';
  render();
}

async function regenerateSection(sectionId) {
  const s = SECTIONS.find(x => x.id === sectionId);
  if (!s) return;

  state.progressMsg = `${s.name} ì¬ìƒì„± ì¤‘...`;
  const compRef = state.competitorData ? JSON.stringify(state.competitorData).substring(0, 1000) : '';

  try {
    const content = await gemini.generateSectionContent(
      s, state.analysis, state.sectionInstructions[sectionId] || '', compRef
    );
    state.sectionContents[sectionId] = content;

    try {
      const imgPrompt = content.image_description || content.design_notes || s.purpose;
      const img = await gemini.generateImage(imgPrompt, state.imageBase64, state.imageMime);
      if (img) state.sectionImages[sectionId] = img;
    } catch (e) {}

    render();
  } catch (e) {
    state.error = `ì¬ìƒì„± ì‹¤íŒ¨: ${e.message}`;
    render();
  }
}

function exportHTML() {
  const product = state.analysis || {};
  let sectionsHtml = '';

  for (const s of SECTIONS) {
    const content = state.sectionContents[s.id];
    if (!content) continue;
    const c = content.color_scheme || {};
    const f = content.font_suggestion || {};
    const img = state.sectionImages[s.id];

    sectionsHtml += `
    <section style="background:${c.background||'#FFFFFF'};padding:60px 20px;text-align:center;">
      <div style="max-width:860px;margin:0 auto;">
        <h2 style="font-size:${f.headline_size||'36px'};color:${c.text_primary||'#333'};margin-bottom:12px;font-weight:${f.headline_weight||'700'};">
          ${content.headline||''}
        </h2>
        <h3 style="font-size:20px;color:${c.text_secondary||'#666'};margin-bottom:24px;font-weight:400;">
          ${content.subheadline||''}
        </h3>
        ${img ? `<img src="${img}" alt="${s.name}" style="max-width:100%;border-radius:12px;margin:20px 0;">` : ''}
        <p style="font-size:${f.body_size||'16px'};color:${c.text_secondary||'#666'};line-height:1.8;max-width:680px;margin:0 auto;">
          ${content.body_text||''}
        </p>
        ${content.extra_elements?.length ? `<div style="margin-top:20px;text-align:left;max-width:600px;margin:0 auto;">
          ${content.extra_elements.map(e=>`<div style="padding:8px 0;color:${c.text_secondary||'#555'};font-size:14px;border-bottom:1px solid rgba(0,0,0,.05);">â€¢ ${e}</div>`).join('')}
        </div>` : ''}
        ${content.cta_text ? `<a href="#" style="display:inline-block;margin-top:24px;padding:14px 40px;background:${c.accent||'#6366f1'};color:#fff;border-radius:8px;text-decoration:none;font-size:18px;font-weight:600;">${content.cta_text}</a>` : ''}
      </div>
    </section>`;
  }

  const html = `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${product.product_name||'ìƒì„¸í˜ì´ì§€'}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans KR',sans-serif;color:#333}
        img{max-width:100%;height:auto}
        section{width:100%}
    </style>
</head>
<body>${sectionsHtml}</body>
</html>`;

  const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${product.product_name||'detail-page'}_ìƒì„¸í˜ì´ì§€.html`;
  a.click();
  URL.revokeObjectURL(url);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE DRIVE SERVICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DRIVE_API = 'https://www.googleapis.com/drive/v3';
const GD_CLIENT_ID = localStorage.getItem('gd_client_id') || '';

// URLì´ë“  IDë§Œì´ë“  í´ë” IDë¥¼ ì¶”ì¶œ
function extractFolderId(input) {
  if (!input) return '';
  input = input.trim();
  // https://drive.google.com/drive/folders/XXXXX?usp=... í˜•íƒœ
  const m1 = input.match(/folders\/([a-zA-Z0-9_-]+)/);
  if (m1) return m1[1];
  // https://drive.google.com/drive/u/0/folders/XXXXX í˜•íƒœ
  const m2 = input.match(/drive[^"]*folders\/([a-zA-Z0-9_-]+)/);
  if (m2) return m2[1];
  // ì´ë¯¸ ìˆœìˆ˜ ID (ê³µë°±, ìŠ¬ë˜ì‹œ ì—†ìŒ)
  if (/^[a-zA-Z0-9_-]+$/.test(input)) return input;
  return input;
}

class DriveService {
  constructor(token) {
    this.token = token;
    this.tokenExpiresAt = Date.now() + 3500 * 1000; // ~58ë¶„ í›„ ë§Œë£Œ ì˜ˆìƒ
  }
  headers() { return { 'Authorization': `Bearer ${this.token}` }; }

  // í† í° ë§Œë£Œ ì²´í¬ í›„ ìë™ ê°±ì‹ 
  async ensureToken() {
    if (Date.now() > this.tokenExpiresAt) {
      autoLog('info', 'í† í° ë§Œë£Œë¨ â€” ìë™ ê°±ì‹  ì¤‘...');
      await refreshDriveToken();
    }
  }

  // 401 ì—ëŸ¬ ì‹œ í† í° ê°±ì‹  í›„ ì¬ì‹œë„í•˜ëŠ” ë˜í¼
  async fetchWithRetry(url, options = {}) {
    await this.ensureToken();
    let res = await fetch(url, { ...options, headers: { ...this.headers(), ...(options.headers||{}) } });
    if (res.status === 401) {
      autoLog('info', '401 ì¸ì¦ ë§Œë£Œ â€” í† í° ê°±ì‹  í›„ ì¬ì‹œë„...');
      await refreshDriveToken();
      res = await fetch(url, { ...options, headers: { ...this.headers(), ...(options.headers||{}) } });
    }
    return res;
  }

  async listImages(folderId) {
    const q = encodeURIComponent(`'${folderId}' in parents and mimeType contains 'image/' and trashed=false`);
    const res = await this.fetchWithRetry(`${DRIVE_API}/files?q=${q}&fields=files(id,name,mimeType,createdTime,size)&orderBy=createdTime&pageSize=100`);
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return data.files || [];
  }

  async downloadFile(fileId) {
    const res = await this.fetchWithRetry(`${DRIVE_API}/files/${fileId}?alt=media`);
    if (!res.ok) throw new Error('Download failed');
    const blob = await res.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve({ base64: reader.result.split(',')[1], dataUrl: reader.result, mime: blob.type });
      reader.readAsDataURL(blob);
    });
  }

  async uploadHtml(folderId, fileName, htmlContent) {
    await this.ensureToken();
    const metadata = { name: fileName, mimeType: 'text/html', parents: [folderId] };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', new Blob([htmlContent], { type: 'text/html' }));

    let res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink', {
      method: 'POST', headers: { 'Authorization': `Bearer ${this.token}` }, body: form
    });
    if (res.status === 401) {
      autoLog('info', 'ì—…ë¡œë“œ 401 â€” í† í° ê°±ì‹  í›„ ì¬ì‹œë„...');
      await refreshDriveToken();
      const form2 = new FormData();
      form2.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form2.append('file', new Blob([htmlContent], { type: 'text/html' }));
      res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink', {
        method: 'POST', headers: { 'Authorization': `Bearer ${this.token}` }, body: form2
      });
    }
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);
    return data;
  }

  async getFolderName(folderId) {
    const res = await this.fetchWithRetry(`${DRIVE_API}/files/${folderId}?fields=name`);
    const data = await res.json();
    return data.name || folderId;
  }
}

let driveService = null;
let tokenClient = null;

// í† í° ìë™ ê°±ì‹  â€” ì‚¬ìš©ì íŒì—… ì—†ì´ silent ì‹œë„, ì‹¤íŒ¨ ì‹œ íŒì—…
function refreshDriveToken() {
  return new Promise((resolve, reject) => {
    const clientId = state.auto.gdClientId || localStorage.getItem('gd_client_id') || '';
    if (!clientId || !google?.accounts?.oauth2) {
      reject(new Error('Google OAuth ì´ˆê¸°í™” ì•ˆ ë¨'));
      return;
    }
    const client = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
      prompt: '',  // silent ê°±ì‹  ì‹œë„
      callback: (resp) => {
        if (resp.access_token) {
          state.auto.accessToken = resp.access_token;
          state.auto.driveConnected = true;
          if (driveService) {
            driveService.token = resp.access_token;
            driveService.tokenExpiresAt = Date.now() + 3500 * 1000;
          } else {
            driveService = new DriveService(resp.access_token);
          }
          autoLog('ok', 'í† í° ìë™ ê°±ì‹  ì™„ë£Œ');
          resolve();
        } else {
          autoLog('err', 'í† í° ê°±ì‹  ì‹¤íŒ¨ â€” Google Drive ì¬ì—°ê²° í•„ìš”');
          state.auto.driveConnected = false;
          render();
          reject(new Error('Token refresh failed'));
        }
      },
    });
    client.requestAccessToken();
  });
}

function initGoogleAuth() {
  const clientId = state.auto.gdClientId || GD_CLIENT_ID;
  if (!clientId) return;
  try {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
      callback: (resp) => {
        if (resp.access_token) {
          state.auto.accessToken = resp.access_token;
          state.auto.driveConnected = true;
          driveService = new DriveService(resp.access_token);
          autoLog('info', 'Google Drive ì—°ê²° ì™„ë£Œ');
          render();
        }
      },
    });
  } catch(e) { console.warn('Google auth init failed:', e); }
}

function connectDrive() {
  const clientId = document.getElementById('gdClientId')?.value.trim() || GD_CLIENT_ID;
  if (!clientId) {
    state.error = 'Google Cloud OAuth Client IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
    render();
    return;
  }
  localStorage.setItem('gd_client_id', clientId);
  state.auto.gdClientId = clientId;
  try {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
      callback: (resp) => {
        if (resp.error) {
          state.error = `Drive ì¸ì¦ ì‹¤íŒ¨: ${resp.error}`;
          render();
          return;
        }
        state.auto.accessToken = resp.access_token;
        state.auto.driveConnected = true;
        driveService = new DriveService(resp.access_token);
        autoLog('info', 'Google Drive ì—°ê²° ì™„ë£Œ');
        render();
      },
    });
    tokenClient.requestAccessToken();
  } catch(e) {
    state.error = `Google ì¸ì¦ ì˜¤ë¥˜: ${e.message}`;
    render();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTOMATION LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const autoLogs = [];
function autoLog(type, msg) {
  const t = new Date().toLocaleTimeString('ko-KR');
  autoLogs.unshift({ type, msg, time: t });
  if (autoLogs.length > 200) autoLogs.length = 200;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTOMATION RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAutomation() {
  const a = state.auto;
  const connected = a.driveConnected;
  const savedClientId = localStorage.getItem('gd_client_id') || '';

  return `<div class="fade-in">
    <h1 class="page-title">ğŸ”„ ìë™í™” ì‹œìŠ¤í…œ</h1>
    <p class="page-desc">êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë”ë¥¼ ì—°ê²°í•˜ë©´ ì„¤ì •í•œ ê°„ê²©ë§ˆë‹¤ ìë™ìœ¼ë¡œ ìƒì„¸í˜ì´ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

    <!-- Drive Connection -->
    <div class="auto-card">
      <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--primary)">cloud</span> Google Drive ì—°ê²°
        ${connected ? '<span class="auto-status running">â— ì—°ê²°ë¨</span>' : '<span class="auto-status stopped">â— ë¯¸ì—°ê²°</span>'}
      </h3>
      ${!connected ? `
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px">
          <p style="font-size:13px;color:var(--warn);font-weight:600;margin-bottom:8px">âš ï¸ ë°˜ë“œì‹œ start.batìœ¼ë¡œ ì‹¤í–‰í•˜ì„¸ìš”</p>
          <p style="font-size:12px;color:var(--text-d);margin-bottom:4px">Google OAuthëŠ” <code style="background:var(--bg-card);padding:2px 6px;border-radius:4px;color:var(--cyan)">http://localhost:8080</code> ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.</p>
          <p style="font-size:11px;color:var(--text-m)">file:///ë¡œ ì—´ë©´ ì¸ì¦ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤. start.bat ë”ë¸”í´ë¦­ â†’ ë¸Œë¼ìš°ì €ì—ì„œ localhost:8080 ì ‘ì†</p>
        </div>
        <p style="font-size:13px;color:var(--text-d);margin-bottom:12px">
          <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color:var(--primary)">Google Cloud Console</a>ì—ì„œ OAuth 2.0 Client IDë¥¼ ë°œê¸‰ ë°›ìœ¼ì„¸ìš”.
        </p>
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px;font-size:12px;color:var(--text-d)">
          <p style="font-weight:600;margin-bottom:6px">ğŸ“‹ ì„¤ì • ë°©ë²•:</p>
          <p>1. ìœ í˜•: <strong>ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜</strong></p>
          <p>2. ìŠ¹ì¸ëœ JavaScript ì›ë³¸ ì¶”ê°€:</p>
          <code style="display:block;background:var(--bg-card);padding:8px 12px;border-radius:6px;margin:6px 0;color:var(--cyan);font-size:13px">http://localhost:8080</code>
          <p>3. Google Drive API í™œì„±í™” í•„ìš” (<a href="https://console.cloud.google.com/apis/library/drive.googleapis.com" target="_blank" style="color:var(--primary)">ì—¬ê¸°ì„œ í™œì„±í™”</a>)</p>
        </div>
        <div class="input-group" style="margin-bottom:12px">
          <label class="label">OAuth Client ID</label>
          <input type="text" class="input" id="gdClientId" value="${savedClientId}" placeholder="xxxx.apps.googleusercontent.com" style="font-size:12px;font-family:monospace">
        </div>
        <button class="btn-primary" id="connectDriveBtn">
          <span class="material-icons-outlined" style="font-size:18px">login</span>
          Google Drive ì—°ê²°
        </button>
      ` : `
        <p style="font-size:13px;color:var(--ok)">âœ… Google Driveê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      `}
    </div>

    ${connected ? `
    <!-- Folder Settings -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="auto-card">
        <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--orange)">folder_open</span> ì…ë ¥ í´ë” (ì œí’ˆ ì´ë¯¸ì§€)</h3>
        <div class="input-group" style="margin-bottom:8px">
          <label class="label">Google Drive í´ë” ID</label>
          <input type="text" class="input" id="inputFolderId" value="${a.inputFolderId}" placeholder="í´ë” URL ì „ì²´ ë˜ëŠ” ID ë¶™ì—¬ë„£ê¸°" style="font-size:12px;font-family:monospace">
        </div>
        ${a.inputFolderName ? `<p style="font-size:12px;color:var(--ok)">ğŸ“ ${a.inputFolderName}</p>` : ''}
        <button class="btn-sm" id="setInputFolder" style="margin-top:4px">
          <span class="material-icons-outlined" style="font-size:14px">check</span> í´ë” ì„¤ì •
        </button>
        <p style="font-size:11px;color:var(--text-m);margin-top:8px">
          ğŸ’¡ ë“œë¼ì´ë¸Œ í´ë” ì—´ê³  URLì—ì„œ <code>folders/</code> ë’¤ì˜ ë¬¸ìì—´ì´ IDì…ë‹ˆë‹¤
        </p>
      </div>

      <div class="auto-card">
        <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--cyan)">drive_file_move</span> ì¶œë ¥ í´ë” (ìƒì„¸í˜ì´ì§€)</h3>
        <div class="input-group" style="margin-bottom:8px">
          <label class="label">Google Drive í´ë” ID</label>
          <input type="text" class="input" id="outputFolderId" value="${a.outputFolderId}" placeholder="í´ë” URL ì „ì²´ ë˜ëŠ” ID ë¶™ì—¬ë„£ê¸°" style="font-size:12px;font-family:monospace">
        </div>
        ${a.outputFolderName ? `<p style="font-size:12px;color:var(--ok)">ğŸ“ ${a.outputFolderName}</p>` : ''}
        <button class="btn-sm" id="setOutputFolder" style="margin-top:4px">
          <span class="material-icons-outlined" style="font-size:14px">check</span> í´ë” ì„¤ì •
        </button>
      </div>
    </div>

    <!-- Interval & Control -->
    <div class="auto-card">
      <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--warn)">timer</span> ì‹¤í–‰ ê°„ê²©</h3>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
        <input type="range" min="5" max="60" step="5" value="${a.intervalMin}" class="interval-slider" id="intervalSlider">
        <span style="font-size:24px;font-weight:700;color:var(--primary);min-width:60px;text-align:center" id="intervalDisplay">${a.intervalMin}ë¶„</span>
      </div>
      <p style="font-size:12px;color:var(--text-m)">ì…ë ¥ í´ë”ì—ì„œ ì•„ì§ ì²˜ë¦¬ ì•ˆ ëœ ì´ë¯¸ì§€ë¥¼ 1ì¥ì”© ê°€ì ¸ì™€ 15ì„¹ì…˜ ìƒì„¸í˜ì´ì§€ë¥¼ ìƒì„± í›„ ì¶œë ¥ í´ë”ì— ì €ì¥í•©ë‹ˆë‹¤.</p>

      <div style="display:flex;gap:10px;margin-top:16px;align-items:center">
        ${!a.running ? `
          <button class="btn-primary" id="startAutoBtn" ${!a.inputFolderId||!a.outputFolderId?'disabled':''}>
            <span class="material-icons-outlined" style="font-size:18px">play_arrow</span>
            ìë™í™” ì‹œì‘
          </button>
        ` : `
          <button class="btn-primary" id="stopAutoBtn" style="background:var(--err)">
            <span class="material-icons-outlined" style="font-size:18px">stop</span>
            ìë™í™” ì¤‘ì§€
          </button>
        `}
        <button class="btn-sm" id="runOnceBtn" ${!a.inputFolderId||!a.outputFolderId||a.running?'disabled':''} style="padding:10px 16px">
          <span class="material-icons-outlined" style="font-size:16px">play_circle</span>
          1íšŒ ì¦‰ì‹œ ì‹¤í–‰
        </button>
        <button class="btn-sm" id="resetProcessedBtn" style="padding:10px 16px">
          <span class="material-icons-outlined" style="font-size:16px">restart_alt</span>
          ì²˜ë¦¬ê¸°ë¡ ì´ˆê¸°í™”
        </button>
        ${a.running ? `<span class="auto-status running" style="margin-left:auto">â— ì‘ë™ ì¤‘ ${a.nextRunAt ? '| ë‹¤ìŒ ì‹¤í–‰: '+a.nextRunAt : ''}</span>` : ''}
      </div>
    </div>

    <!-- Current Processing -->
    ${a.currentItem ? `
    <div class="auto-card" style="border-color:var(--warn)">
      <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--warn)">hourglass_top</span> í˜„ì¬ ì²˜ë¦¬ ì¤‘</h3>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <span style="font-size:13px;font-weight:600">${a.currentItem.name}</span>
        <span style="font-size:12px;color:var(--text-m)">${a.currentMsg}</span>
      </div>
      <div class="progress-outer" style="max-width:100%"><div class="progress-inner" style="width:${a.currentProgress}%">${a.currentProgress}%</div></div>
    </div>
    ` : ''}

    <!-- Stats -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
      <div class="auto-card" style="text-align:center">
        <div style="font-size:32px;font-weight:900;color:var(--primary)">${a.totalProcessed}</div>
        <div style="font-size:12px;color:var(--text-d)">ì´ ì²˜ë¦¬ ì™„ë£Œ</div>
      </div>
      <div class="auto-card" style="text-align:center">
        <div style="font-size:32px;font-weight:900;color:var(--warn)">${a.queue.length}</div>
        <div style="font-size:12px;color:var(--text-d)">ëŒ€ê¸° ì¤‘</div>
      </div>
      <div class="auto-card" style="text-align:center">
        <div style="font-size:32px;font-weight:900;color:var(--ok)">${a.processedFileIds.size}</div>
        <div style="font-size:12px;color:var(--text-d)">ëˆ„ì  ì²˜ë¦¬ (ìŠ¤í‚µ)</div>
      </div>
    </div>

    <!-- Recent Completed -->
    ${a.completed.length ? `
    <div class="auto-card">
      <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--ok)">check_circle</span> ìµœê·¼ ì™„ë£Œ</h3>
      ${a.completed.slice(0, 10).map(c => `
        <div class="queue-item">
          <div class="q-status ${c.error?'error':'done'}"></div>
          <span style="flex:1">${c.name}</span>
          <span style="font-size:11px;color:var(--text-m)">${c.finishedAt || ''}</span>
          ${c.error ? `<span style="font-size:11px;color:var(--err)">${c.error}</span>` : '<span style="font-size:11px;color:var(--ok)">âœ… ì™„ë£Œ</span>'}
        </div>
      `).join('')}
    </div>` : ''}

    <!-- Log -->
    <div class="auto-card">
      <h3><span class="material-icons-outlined" style="font-size:20px;color:var(--text-d)">terminal</span> ë¡œê·¸</h3>
      <div class="log-box" id="autoLogBox">
        ${autoLogs.length === 0 ? '<div class="log-line" style="color:var(--text-m)">ì•„ì§ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>' : ''}
        ${autoLogs.slice(0, 50).map(l => `<div class="log-line ${l.type}">[${l.time}] ${l.msg}</div>`).join('')}
      </div>
    </div>
    ` : `
    <div class="auto-card" style="text-align:center;padding:40px">
      <span class="material-icons-outlined" style="font-size:48px;color:var(--text-m);margin-bottom:12px">cloud_off</span>
      <p style="color:var(--text-d)">Google Driveë¥¼ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.</p>
    </div>
    `}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTOMATION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function autoProcessOne() {
  if (!driveService || !state.apiKey) {
    autoLog('err', 'Drive ë˜ëŠ” Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
    return;
  }
  if (!state.auto.inputFolderId || !state.auto.outputFolderId) {
    autoLog('err', 'ì…ë ¥/ì¶œë ¥ í´ë”ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
    return;
  }

  gemini = gemini || new GeminiAPI(state.apiKey);

  // 1. List images in input folder
  autoLog('info', 'ì…ë ¥ í´ë” ìŠ¤ìº” ì¤‘...');
  state.auto.currentMsg = 'í´ë” ìŠ¤ìº” ì¤‘...';
  state.auto.currentProgress = 0;
  render();

  let files;
  try {
    files = await driveService.listImages(state.auto.inputFolderId);
  } catch(e) {
    // ì¸ì¦ ë§Œë£Œì¸ ê²½ìš° ìë™ ê°±ì‹  ì‹œë„
    if (e.message.includes('invalid authentication') || e.message.includes('401') || e.message.includes('Request had invalid')) {
      autoLog('info', 'í† í° ë§Œë£Œ ê°ì§€ â€” ìë™ ê°±ì‹  ì‹œë„...');
      try {
        await refreshDriveToken();
        files = await driveService.listImages(state.auto.inputFolderId);
      } catch(e2) {
        autoLog('err', `í† í° ê°±ì‹  í›„ì—ë„ ì‹¤íŒ¨: ${e2.message}`);
        state.auto.currentItem = null;
        render();
        return;
      }
    } else {
      autoLog('err', `í´ë” ìŠ¤ìº” ì‹¤íŒ¨: ${e.message}`);
      state.auto.currentItem = null;
      render();
      return;
    }
  }

  // 2. Filter already processed
  const unprocessed = files.filter(f => !state.auto.processedFileIds.has(f.id));
  autoLog('info', `ì „ì²´ ${files.length}ì¥, ë¯¸ì²˜ë¦¬ ${unprocessed.length}ì¥`);

  if (unprocessed.length === 0) {
    autoLog('info', 'ì²˜ë¦¬í•  ìƒˆ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ëŒ€ê¸°í•©ë‹ˆë‹¤.');
    state.auto.currentItem = null;
    render();
    return;
  }

  // 3. Pick the first unprocessed file
  const file = unprocessed[0];
  state.auto.currentItem = { id: file.id, name: file.name };
  state.auto.currentProgress = 5;
  state.auto.currentMsg = `${file.name} ë‹¤ìš´ë¡œë“œ ì¤‘...`;
  autoLog('info', `ì²˜ë¦¬ ì‹œì‘: ${file.name}`);
  render();

  try {
    // 4. Download the image
    const imgData = await driveService.downloadFile(file.id);
    state.auto.currentProgress = 15;
    state.auto.currentMsg = 'AI ë¶„ì„ ì¤‘...';
    render();

    // 5. Analyze with Gemini
    const analysis = await gemini.analyzeImage(imgData.base64, imgData.mime);
    autoLog('ok', `ë¶„ì„ ì™„ë£Œ: ${analysis.product_name || file.name}`);
    state.auto.currentProgress = 25;
    state.auto.currentMsg = 'ê²½ìŸ ë¶„ì„ ì¤‘...';
    render();

    // 6. Competitor search
    let compRef = '';
    try {
      const comp = await gemini.searchSimilarProducts(analysis.product_name || analysis.product_name_en, analysis.category);
      compRef = JSON.stringify(comp).substring(0, 1000);
      autoLog('ok', `ê²½ìŸ ë¶„ì„ ì™„ë£Œ: ${comp.similar_products?.length || 0}ê°œ`);
    } catch(e) {
      autoLog('err', 'ê²½ìŸ ë¶„ì„ ìŠ¤í‚µ: ' + e.message);
    }
    state.auto.currentProgress = 30;

    // 7. Generate all 15 sections
    const sectionContents = {};
    const sectionImages = {};
    const instructions = state.sectionInstructions; // use saved instructions

    for (let i = 0; i < SECTIONS.length; i++) {
      const s = SECTIONS[i];
      const pct = Math.round(30 + ((i / SECTIONS.length) * 60));
      state.auto.currentProgress = pct;
      state.auto.currentMsg = `[${i+1}/15] ${s.name} ìƒì„± ì¤‘...`;
      render();

      try {
        const content = await gemini.generateSectionContent(s, analysis, instructions[s.id] || '', compRef);
        sectionContents[s.id] = content;

        // Image
        try {
          const imgPrompt = content.image_description || content.design_notes || s.purpose;
          const img = await gemini.generateImage(imgPrompt, imgData.base64, imgData.mime);
          if (img) sectionImages[s.id] = img;
        } catch(e) {}
      } catch(e) {
        autoLog('err', `ì„¹ì…˜ ${s.name} ì‹¤íŒ¨: ${e.message}`);
        sectionContents[s.id] = { headline: s.name, subheadline: 'ìƒì„± ì‹¤íŒ¨', body_text: e.message, color_scheme: {background:'#fff',text_primary:'#c00',text_secondary:'#e00'}, font_suggestion:{headline_size:'32px',body_size:'14px'} };
      }
      await new Promise(r => setTimeout(r, 500));
    }

    state.auto.currentProgress = 92;
    state.auto.currentMsg = 'HTML ìƒì„± ë° ì—…ë¡œë“œ ì¤‘...';
    render();

    // 8. Build HTML
    const htmlContent = buildExportHtml(analysis, sectionContents, sectionImages);

    // 9. Upload to Drive
    const productName = analysis.product_name || file.name.replace(/\.[^.]+$/, '');
    const fileName = `${productName}_ìƒì„¸í˜ì´ì§€_${new Date().toISOString().slice(0,10)}.html`;
    const uploaded = await driveService.uploadHtml(state.auto.outputFolderId, fileName, htmlContent);
    autoLog('ok', `âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${fileName}`);

    // 10. Mark as processed
    state.auto.processedFileIds.add(file.id);
    localStorage.setItem('auto_processed_ids', JSON.stringify([...state.auto.processedFileIds]));
    state.auto.totalProcessed++;
    localStorage.setItem('auto_total_processed', state.auto.totalProcessed);
    state.auto.completed.unshift({ name: file.name, finishedAt: new Date().toLocaleTimeString('ko-KR'), error: null });
    if (state.auto.completed.length > 50) state.auto.completed.length = 50;
    localStorage.setItem('auto_completed', JSON.stringify(state.auto.completed));
    state.auto.currentItem = null;
    state.auto.currentProgress = 100;
    state.auto.currentMsg = '';
    render();

  } catch(e) {
    autoLog('err', `ì²˜ë¦¬ ì‹¤íŒ¨ (${file.name}): ${e.message}`);
    state.auto.completed.unshift({ name: file.name, finishedAt: new Date().toLocaleTimeString('ko-KR'), error: e.message });
    if (state.auto.completed.length > 50) state.auto.completed.length = 50;
    localStorage.setItem('auto_completed', JSON.stringify(state.auto.completed));
    state.auto.currentItem = null;
    render();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGE CUTS â€” RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderImageCuts() {
  const c = state.cuts;
  const hasSrc = !!c.sourcePreview;
  const anyResult = c.prompts.some(p => p.result);

  return `<div class="fade-in">
    <h1 class="page-title">âœ¨ ì´ë¯¸ì§€ì»· ìƒì„±</h1>
    <p class="page-desc">ì œí’ˆ ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ê³  4ê°€ì§€ í”„ë¡¬í”„íŠ¸ë¡œ ê°ê° ë‹¤ë¥¸ ì´ë¯¸ì§€ì»·ì„ ìƒì„±í•©ë‹ˆë‹¤. ìƒì„±ëœ ì»·ì€ ìƒì„¸í˜ì´ì§€ ì›í•˜ëŠ” ì„¹ì…˜ì— ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <p style="font-size:12px;color:var(--primary);margin-bottom:20px;background:var(--primary-dim);padding:8px 12px;border-radius:8px;display:inline-block">
      ğŸ¤– ì´ë¯¸ì§€ ìƒì„± ëª¨ë¸: <strong>gemini-3-pro-image-preview</strong>
    </p>

    <!-- ì†ŒìŠ¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
    <div class="source-upload" id="cutsUploadArea">
      ${hasSrc
        ? `<img src="${c.sourcePreview}" style="max-height:200px;max-width:100%;border-radius:8px;object-fit:contain">`
        : `<span class="material-icons-outlined" style="font-size:40px;color:var(--primary);display:block;margin-bottom:8px">add_photo_alternate</span>
           <p style="font-size:15px;font-weight:500">ì œí’ˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ</p>
           <p style="font-size:12px;color:var(--text-m);margin-top:4px">í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸&amp;ë“œë¡­</p>`
      }
      <input type="file" id="cutsFileInput" accept="image/*" style="display:none">
    </div>

    <!-- 4ê°œ ì»· ì¹´ë“œ -->
    <div class="cuts-grid">
      ${c.prompts.map((p, i) => `
        <div class="cut-card ${p.result ? 'has-result' : ''}">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <span class="cut-label">${p.label}</span>
            <div style="display:flex;gap:6px">
              <button class="btn-sm" data-rename-cut="${i}">âœï¸ ì´ë¦„ë³€ê²½</button>
              ${p.result ? `<a class="btn-sm" href="${p.result}" download="cut${i+1}.png">â¬‡ï¸ ì €ì¥</a>` : ''}
            </div>
          </div>

          <!-- ë¯¸ë¦¬ë³´ê¸° -->
          <div class="cut-preview">
            ${p.generating
              ? `<div class="cut-spinner"></div>`
              : p.result
                ? `<img src="${p.result}" alt="cut${i+1}">`
                : `<span style="color:var(--text-m);font-size:12px">ìƒì„± ì „</span>`
            }
          </div>

          <!-- í”„ë¡¬í”„íŠ¸ ì…ë ¥ -->
          <textarea class="textarea" data-cut-prompt="${i}" rows="3"
            placeholder="ì˜ˆ) í° ë°°ê²½ì— ì œí’ˆì„ ì¤‘ì•™ ë°°ì¹˜, ê·¸ë¦¼ì ì—†ì´ ê¹”ë”í•˜ê²Œ&#10;ì˜ˆ) ë¼ì´í”„ìŠ¤íƒ€ì¼ ê°ì„±, ì¹´í˜ í…Œì´ë¸” ìœ„ì— ë†“ì¸ ëª¨ìŠµ&#10;ì˜ˆ) ë‹¤í¬í†¤ ëŸ­ì…”ë¦¬, ê²€ì€ ë°°ê²½ ê³¨ë“œ ì¡°ëª…"
            style="font-size:12px">${p.prompt}</textarea>

          <!-- ê°œë³„ ìƒì„± ë²„íŠ¼ -->
          <button class="btn-primary" data-gen-cut="${i}"
            style="font-size:13px;padding:9px 16px;justify-content:center"
            ${!hasSrc || p.generating ? 'disabled' : ''}>
            <span class="material-icons-outlined" style="font-size:16px">${p.generating ? 'hourglass_empty' : 'auto_fix_high'}</span>
            ${p.generating ? 'ìƒì„± ì¤‘...' : 'ì´ ì»· ìƒì„±'}
          </button>
        </div>
      `).join('')}
    </div>

    <!-- 4ê°œ ì „ì²´ ìƒì„± ë²„íŠ¼ -->
    <div style="display:flex;gap:10px;margin-bottom:32px">
      <button class="btn-primary" id="genAllCutsBtn"
        style="padding:14px 32px;font-size:15px"
        ${!hasSrc ? 'disabled' : ''}>
        <span class="material-icons-outlined" style="font-size:20px">auto_fix_high</span>
        4ê°œ ì»· ì „ì²´ ìƒì„±
      </button>
      ${anyResult ? `<button class="btn-sm" id="clearAllCutsBtn" style="padding:12px 20px">
        <span class="material-icons-outlined" style="font-size:16px">delete_sweep</span>
        ê²°ê³¼ ì´ˆê¸°í™”
      </button>` : ''}
    </div>

    <!-- ìƒì„¸í˜ì´ì§€ ë°°ì¹˜ ì„¤ì • -->
    ${anyResult ? `
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px">
      <h3 style="font-size:15px;font-weight:700;margin-bottom:4px">ğŸ“Œ ìƒì„¸í˜ì´ì§€ ì„¹ì…˜ì— ë°°ì¹˜</h3>
      <p style="font-size:12px;color:var(--text-m);margin-bottom:16px">ê° ì„¹ì…˜ì— ì–´ë–¤ ì´ë¯¸ì§€ì»·ì„ ë„£ì„ì§€ ì„ íƒí•˜ì„¸ìš”. ë¯¸ë¦¬ë³´ê¸°Â·HTML ë‚´ë³´ë‚´ê¸°ì— ë°˜ì˜ë©ë‹ˆë‹¤.</p>
      <div>
        ${SECTIONS.map(s => {
          const placed = c.placement[s.id];
          const placedCut = c.prompts.find(p => p.id === placed);
          return `<div class="placement-row">
            <span style="font-size:16px">${s.icon}</span>
            <span style="flex:1;font-size:13px">${s.n}. ${s.name}</span>
            ${placedCut?.result ? `<img class="cut-thumb" src="${placedCut.result}" alt="">` : '<div class="cut-thumb" style="opacity:.3"></div>'}
            <select class="placement-select" data-place-section="${s.id}">
              <option value="">-- ë°°ì¹˜ ì•ˆ í•¨</option>
              ${c.prompts.map(p => p.result ? `<option value="${p.id}" ${placed===p.id?'selected':''}>${p.label}</option>` : '').join('')}
            </select>
          </div>`;
        }).join('')}
      </div>
      <div style="margin-top:16px;display:flex;gap:8px">
        <button class="btn-primary" id="applyPlacementBtn" style="font-size:13px;padding:10px 20px">
          <span class="material-icons-outlined" style="font-size:16px">check</span>
          ë°°ì¹˜ ì ìš©
        </button>
        <span style="font-size:12px;color:var(--text-m);align-self:center">ë¯¸ë¦¬ë³´ê¸° íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”</span>
      </div>
    </div>
    ` : `
    <div style="background:var(--bg-card);border:1px dashed var(--border);border-radius:12px;padding:24px;text-align:center;color:var(--text-m);font-size:13px">
      ì´ë¯¸ì§€ì»·ì„ ìƒì„±í•˜ë©´ ìƒì„¸í˜ì´ì§€ ì„¹ì…˜ì— ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
    `}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGE CUTS â€” GENERATION LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateCut(idx) {
  const c = state.cuts;
  const p = c.prompts[idx];
  if (!c.sourceBase64 || !p.prompt.trim()) {
    state.error = 'ì´ë¯¸ì§€ì™€ í”„ë¡¬í”„íŠ¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    render();
    return;
  }

  gemini = gemini || new GeminiAPI(state.apiKey);
  p.generating = true;
  render();

  try {
    const fullPrompt = `Create a professional Korean e-commerce product detail page image cut.
Product image is provided. Apply the following creative direction:
${p.prompt}
Requirements: High quality, clean, professional Korean e-commerce style.
Maintain the product as the focal point. Aspect ratio 4:3.`;

    const parts = [
      { text: fullPrompt },
      { inline_data: { mime_type: c.sourceMime, data: c.sourceBase64 } }
    ];
    const body = {
      contents: [{ parts }],
      generationConfig: { temperature: 0.8, responseModalities: ['TEXT', 'IMAGE'] }
    };

    // ë¬´ì¡°ê±´ gemini-3-pro-image-preview ì‚¬ìš©
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-image-preview:generateContent?key=${state.apiKey}`,
      { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }
    );
    const data = await res.json();
    if (data.error) throw new Error(data.error.message);

    let imgResult = null;
    for (const part of data.candidates[0].content.parts) {
      const id = part.inlineData || part.inline_data;
      if (id && id.mime_type?.startsWith('image/')) {
        imgResult = `data:${id.mime_type};base64,${id.data}`;
        break;
      }
      if (id && id.mimeType?.startsWith('image/')) {
        imgResult = `data:${id.mimeType};base64,${id.data}`;
        break;
      }
    }
    if (!imgResult) throw new Error('ì´ë¯¸ì§€ê°€ ë°˜í™˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');

    p.result = imgResult;
    p.generating = false;
    savePrompts();
    render();
  } catch(e) {
    p.generating = false;
    state.error = `ì»· ${idx+1} ìƒì„± ì‹¤íŒ¨: ${e.message}`;
    render();
  }
}

async function generateAllCuts() {
  for (let i = 0; i < state.cuts.prompts.length; i++) {
    await generateCut(i);
    await new Promise(r => setTimeout(r, 800));
  }
}

function savePrompts() {
  // result(base64)ëŠ” ìš©ëŸ‰ ë¬¸ì œë¡œ ì €ì¥ ì•ˆ í•¨ â€” prompt/labelë§Œ ì €ì¥
  const toSave = state.cuts.prompts.map(p => ({ id: p.id, label: p.label, prompt: p.prompt, result: null, generating: false }));
  localStorage.setItem('cuts_prompts', JSON.stringify(toSave));
}

function savePlacement() {
  localStorage.setItem('cuts_placement', JSON.stringify(state.cuts.placement));
}

// ë°°ì¹˜ ì ìš© â€” sectionImagesì— ì´ë¯¸ì§€ì»· ë°˜ì˜
function applyPlacement() {
  const c = state.cuts;
  for (const [sectionId, cutId] of Object.entries(c.placement)) {
    const cut = c.prompts.find(p => p.id === cutId);
    if (cut?.result) {
      state.sectionImages[sectionId] = cut.result;
    } else {
      delete state.sectionImages[sectionId];
    }
  }
  savePlacement();
  state.step = 'preview';
  render();
}

// â”€â”€ bindEvents í™•ì¥ (ì´ë¯¸ì§€ì»·) â”€â”€
const _origBind2 = bindEvents;
bindEvents = function() {
  _origBind2();

  // ì†ŒìŠ¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ
  const cutsArea = document.getElementById('cutsUploadArea');
  const cutsInput = document.getElementById('cutsFileInput');
  if (cutsArea) {
    cutsArea.onclick = () => cutsInput.click();
    cutsArea.ondragover = e => e.preventDefault();
    cutsArea.ondrop = e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file?.type.startsWith('image/')) loadCutSource(file);
    };
  }
  if (cutsInput) cutsInput.onchange = e => { if (e.target.files[0]) loadCutSource(e.target.files[0]); };

  // í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì €ì¥
  document.querySelectorAll('[data-cut-prompt]').forEach(el => {
    el.oninput = e => {
      state.cuts.prompts[+el.dataset.cutPrompt].prompt = e.target.value;
      savePrompts();
    };
  });

  // ê°œë³„ ìƒì„±
  document.querySelectorAll('[data-gen-cut]').forEach(btn => {
    btn.onclick = () => generateCut(+btn.dataset.genCut);
  });

  // ì´ë¦„ ë³€ê²½
  document.querySelectorAll('[data-rename-cut]').forEach(btn => {
    btn.onclick = () => {
      const i = +btn.dataset.renameCut;
      const newName = prompt('ì»· ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', state.cuts.prompts[i].label);
      if (newName?.trim()) {
        state.cuts.prompts[i].label = newName.trim();
        savePrompts();
        render();
      }
    };
  });

  // ì „ì²´ ìƒì„±
  const genAllBtn = document.getElementById('genAllCutsBtn');
  if (genAllBtn) genAllBtn.onclick = generateAllCuts;

  // ê²°ê³¼ ì´ˆê¸°í™”
  const clearBtn = document.getElementById('clearAllCutsBtn');
  if (clearBtn) clearBtn.onclick = () => {
    state.cuts.prompts.forEach(p => { p.result = null; p.generating = false; });
    state.cuts.placement = {};
    savePlacement();
    render();
  };

  // ë°°ì¹˜ ì„ íƒ
  document.querySelectorAll('[data-place-section]').forEach(sel => {
    sel.onchange = e => {
      const sid = sel.dataset.placeSection;
      if (e.target.value) state.cuts.placement[sid] = e.target.value;
      else delete state.cuts.placement[sid];
    };
  });

  // ë°°ì¹˜ ì ìš©
  const applyBtn = document.getElementById('applyPlacementBtn');
  if (applyBtn) applyBtn.onclick = applyPlacement;
};

function loadCutSource(file) {
  state.cuts.sourceMime = file.type;
  const reader = new FileReader();
  reader.onload = e => {
    state.cuts.sourcePreview = e.target.result;
    state.cuts.sourceBase64 = e.target.result.split(',')[1];
    render();
  };
  reader.readAsDataURL(file);
}

function buildExportHtml(analysis, sectionContents, sectionImages) {
  let sectionsHtml = '';
  for (const s of SECTIONS) {
    const content = sectionContents[s.id];
    if (!content) continue;
    const c = content.color_scheme || {};
    const f = content.font_suggestion || {};
    const img = sectionImages[s.id];
    sectionsHtml += `
    <section style="background:${c.background||'#FFFFFF'};padding:60px 20px;text-align:center;">
      <div style="max-width:860px;margin:0 auto;">
        <h2 style="font-size:${f.headline_size||'36px'};color:${c.text_primary||'#333'};margin-bottom:12px;font-weight:${f.headline_weight||'700'};">${content.headline||''}</h2>
        <h3 style="font-size:20px;color:${c.text_secondary||'#666'};margin-bottom:24px;font-weight:400;">${content.subheadline||''}</h3>
        ${img ? `<img src="${img}" alt="${s.name}" style="max-width:100%;border-radius:12px;margin:20px 0;">` : ''}
        <p style="font-size:${f.body_size||'16px'};color:${c.text_secondary||'#666'};line-height:1.8;max-width:680px;margin:0 auto;">${content.body_text||''}</p>
        ${content.extra_elements?.length ? `<div style="margin-top:20px;text-align:left;max-width:600px;margin:0 auto;">${content.extra_elements.map(e=>`<div style="padding:8px 0;color:${c.text_secondary||'#555'};font-size:14px;border-bottom:1px solid rgba(0,0,0,.05);">â€¢ ${e}</div>`).join('')}</div>` : ''}
        ${content.cta_text ? `<a href="#" style="display:inline-block;margin-top:24px;padding:14px 40px;background:${c.accent||'#6366f1'};color:#fff;border-radius:8px;text-decoration:none;font-size:18px;font-weight:600;">${content.cta_text}</a>` : ''}
      </div>
    </section>`;
  }
  return `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>${analysis.product_name||'ìƒì„¸í˜ì´ì§€'}</title><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Noto Sans KR',sans-serif;color:#333}img{max-width:100%;height:auto}section{width:100%}</style></head><body>${sectionsHtml}</body></html>`;
}

function startAutomation() {
  if (state.auto.running) return;
  state.auto.running = true;
  autoLog('info', `ìë™í™” ì‹œì‘ (${state.auto.intervalMin}ë¶„ ê°„ê²©)`);

  // Run immediately
  autoProcessOne();

  // Schedule
  state.auto.timerId = setInterval(() => {
    if (!state.auto.currentItem) { // ì´ì „ ì‘ì—… ì™„ë£Œëœ ê²½ìš°ë§Œ
      const now = new Date();
      state.auto.nextRunAt = new Date(now.getTime() + state.auto.intervalMin * 60000).toLocaleTimeString('ko-KR');
      autoProcessOne();
    }
  }, state.auto.intervalMin * 60 * 1000);

  const now = new Date();
  state.auto.nextRunAt = new Date(now.getTime() + state.auto.intervalMin * 60000).toLocaleTimeString('ko-KR');
  render();
}

function stopAutomation() {
  state.auto.running = false;
  if (state.auto.timerId) {
    clearInterval(state.auto.timerId);
    state.auto.timerId = null;
  }
  state.auto.nextRunAt = null;
  autoLog('info', 'ìë™í™” ì¤‘ì§€ë¨');
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BIND AUTOMATION EVENTS (add to bindEvents)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origBind = bindEvents;
bindEvents = function() {
  _origBind();

  const connectBtn = document.getElementById('connectDriveBtn');
  if (connectBtn) connectBtn.onclick = connectDrive;

  const setInput = document.getElementById('setInputFolder');
  if (setInput) setInput.onclick = async () => {
    const raw = document.getElementById('inputFolderId')?.value.trim();
    if (!raw) return;
    const id = extractFolderId(raw);
    state.auto.inputFolderId = id;
    localStorage.setItem('auto_input_folder_id', id);
    autoLog('info', `ì…ë ¥ í´ë” ID ì¶”ì¶œ: ${id}`);
    try {
      const name = await driveService.getFolderName(id);
      state.auto.inputFolderName = name;
      localStorage.setItem('auto_input_folder_name', name);
      autoLog('ok', `ì…ë ¥ í´ë” ì„¤ì • ì™„ë£Œ: ${name}`);
    } catch(e) {
      state.auto.inputFolderName = id;
      autoLog('err', 'í´ë” ì´ë¦„ ì¡°íšŒ ì‹¤íŒ¨: ' + e.message);
    }
    render();
  };

  const setOutput = document.getElementById('setOutputFolder');
  if (setOutput) setOutput.onclick = async () => {
    const raw = document.getElementById('outputFolderId')?.value.trim();
    if (!raw) return;
    const id = extractFolderId(raw);
    state.auto.outputFolderId = id;
    localStorage.setItem('auto_output_folder_id', id);
    autoLog('info', `ì¶œë ¥ í´ë” ID ì¶”ì¶œ: ${id}`);
    try {
      const name = await driveService.getFolderName(id);
      state.auto.outputFolderName = name;
      localStorage.setItem('auto_output_folder_name', name);
      autoLog('ok', `ì¶œë ¥ í´ë” ì„¤ì •: ${name}`);
    } catch(e) {
      state.auto.outputFolderName = id;
      autoLog('err', 'í´ë” ì´ë¦„ ì¡°íšŒ ì‹¤íŒ¨, IDë¡œ ì„¤ì •ë¨');
    }
    render();
  };

  const intervalSlider = document.getElementById('intervalSlider');
  if (intervalSlider) {
    intervalSlider.oninput = () => {
      const v = parseInt(intervalSlider.value);
      state.auto.intervalMin = v;
      localStorage.setItem('auto_interval', v);
      const disp = document.getElementById('intervalDisplay');
      if (disp) disp.textContent = v + 'ë¶„';
    };
  }

  const startBtn = document.getElementById('startAutoBtn');
  if (startBtn) startBtn.onclick = startAutomation;

  const stopBtn = document.getElementById('stopAutoBtn');
  if (stopBtn) stopBtn.onclick = stopAutomation;

  const runOnce = document.getElementById('runOnceBtn');
  if (runOnce) runOnce.onclick = () => {
    autoLog('info', 'ìˆ˜ë™ 1íšŒ ì‹¤í–‰');
    autoProcessOne();
  };

  const resetBtn = document.getElementById('resetProcessedBtn');
  if (resetBtn) resetBtn.onclick = () => {
    state.auto.processedFileIds.clear();
    localStorage.removeItem('auto_processed_ids');
    state.auto.totalProcessed = 0;
    localStorage.setItem('auto_total_processed', '0');
    state.auto.completed = [];
    localStorage.setItem('auto_completed', '[]');
    autoLog('info', 'ì²˜ë¦¬ ê¸°ë¡ ì´ˆê¸°í™”ë¨');
    render();
  };
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (state.apiKey) {
  gemini = new GeminiAPI(state.apiKey);
}
// Try init Google auth if client ID exists
setTimeout(() => { try { initGoogleAuth(); } catch(e) {} }, 1000);
render();
</script>
</body>
</html>
